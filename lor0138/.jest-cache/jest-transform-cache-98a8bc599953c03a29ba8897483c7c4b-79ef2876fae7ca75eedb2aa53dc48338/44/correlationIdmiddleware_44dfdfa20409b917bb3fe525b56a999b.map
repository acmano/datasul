{"file":"/home/mano/projetos/datasul/lor0138/src/shared/middlewares/correlationId.middleware.ts","mappings":";AAAA,qDAAqD;;;AAGrD,+BAAoC;AACpC,iDAA2C;AAE3C;;;;;;;;;;;;;;;;;;;GAmBG;AACI,MAAM,uBAAuB,GAAG,CACrC,GAAY,EACZ,GAAa,EACb,IAAkB,EACZ,EAAE;IACR,6EAA6E;IAC7E,MAAM,mBAAmB,GACvB,GAAG,CAAC,OAAO,CAAC,kBAAkB,CAAW;QACzC,GAAG,CAAC,OAAO,CAAC,cAAc,CAAW;QACrC,GAAG,CAAC,OAAO,CAAC,gBAAgB,CAAW,CAAC;IAE1C,yCAAyC;IACzC,MAAM,aAAa,GAAG,mBAAmB,IAAI,IAAA,SAAM,GAAE,CAAC;IAEtD,oDAAoD;IACpD,GAAG,CAAC,EAAE,GAAG,aAAa,CAAC;IAEvB,gDAAgD;IAChD,GAAG,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;IAE3B,kDAAkD;IAClD,GAAG,CAAC,SAAS,CAAC,kBAAkB,EAAE,aAAa,CAAC,CAAC;IAEjD,6EAA6E;IAC7E,IAAI,mBAAmB,EAAE,CAAC;QACxB,YAAG,CAAC,KAAK,CAAC,oCAAoC,EAAE;YAC9C,aAAa;YACb,MAAM,EAAE,GAAG,CAAC,MAAM;YAClB,GAAG,EAAE,GAAG,CAAC,GAAG;SACb,CAAC,CAAC;IACL,CAAC;IAED,IAAI,EAAE,CAAC;AACT,CAAC,CAAC;AAjCW,QAAA,uBAAuB,2BAiClC;AAEF;;;GAGG;AACI,MAAM,gBAAgB,GAAG,CAAC,GAAY,EAAU,EAAE;IACvD,OAAO,GAAG,CAAC,EAAE,IAAI,SAAS,CAAC;AAC7B,CAAC,CAAC;AAFW,QAAA,gBAAgB,oBAE3B;AAEF;;GAEG;AACI,MAAM,iBAAiB,GAAG,CAC/B,GAAY,EACZ,OAA4B,EACP,EAAE;IACvB,OAAO;QACL,GAAG,OAAO;QACV,aAAa,EAAE,GAAG,CAAC,EAAE;KACtB,CAAC;AACJ,CAAC,CAAC;AARW,QAAA,iBAAiB,qBAQ5B","names":[],"sources":["/home/mano/projetos/datasul/lor0138/src/shared/middlewares/correlationId.middleware.ts"],"sourcesContent":["// src/shared/middlewares/correlationId.middleware.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { v4 as uuidv4 } from 'uuid';\nimport { log } from '@shared/utils/logger';\n\n/**\n * Middleware de Correlation ID\n * \n * Funcionalidades:\n * 1. Aceita correlation ID do cliente (headers: X-Correlation-ID, X-Request-ID, correlation-id)\n * 2. Gera novo UUID se não fornecido\n * 3. Adiciona ao objeto request (req.id)\n * 4. Retorna no header X-Correlation-ID\n * 5. Adiciona timestamp para métricas de performance\n * \n * @example\n * // Cliente envia:\n * curl -H \"X-Correlation-ID: abc-123\" http://lor0138.lorenzetti.ibe:3000/api/...\n * \n * // Servidor usa \"abc-123\" e retorna no header:\n * X-Correlation-ID: abc-123\n * \n * // Se cliente não enviar, servidor gera:\n * X-Correlation-ID: 550e8400-e29b-41d4-a716-446655440000\n */\nexport const correlationIdMiddleware = (\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void => {\n  // 1. Tenta pegar correlation ID dos headers do cliente (ordem de prioridade)\n  const clientCorrelationId = \n    req.headers['x-correlation-id'] as string ||\n    req.headers['x-request-id'] as string ||\n    req.headers['correlation-id'] as string;\n\n  // 2. Usa ID do cliente ou gera novo UUID\n  const correlationId = clientCorrelationId || uuidv4();\n\n  // 3. Adiciona ao request para uso em toda aplicação\n  req.id = correlationId;\n\n  // 4. Adiciona timestamp para cálculo de duração\n  req.startTime = Date.now();\n\n  // 5. Retorna correlation ID no header de resposta\n  res.setHeader('X-Correlation-ID', correlationId);\n\n  // 6. Log de início da requisição (opcional, pode ser feito no requestLogger)\n  if (clientCorrelationId) {\n    log.debug('Correlation ID recebido do cliente', {\n      correlationId,\n      method: req.method,\n      url: req.url,\n    });\n  }\n\n  next();\n};\n\n/**\n * Helper para obter correlation ID do request\n * Útil em lugares onde o request não está disponível diretamente\n */\nexport const getCorrelationId = (req: Request): string => {\n  return req.id || 'unknown';\n};\n\n/**\n * Helper para adicionar correlation ID em objetos de log\n */\nexport const withCorrelationId = (\n  req: Request,\n  logData: Record<string, any>\n): Record<string, any> => {\n  return {\n    ...logData,\n    correlationId: req.id,\n  };\n};"],"version":3}