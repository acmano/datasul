11bd4822328f70818c15d2795dad7b6d
"use strict";
// src/shared/utils/cacheManager.ts
// ✅ VERSÃO ATUALIZADA: Suporta Memory, Redis e Layered (L1+L2)
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheManager = void 0;
exports.generateCacheKey = generateCacheKey;
exports.Cacheable = Cacheable;
const MemoryCacheAdapter_1 = require("./cache/MemoryCacheAdapter");
const RedisCacheAdapter_1 = require("./cache/RedisCacheAdapter");
const LayeredCacheAdapter_1 = require("./cache/LayeredCacheAdapter");
const logger_1 = require("./logger");
/**
 * Gerenciador de cache com suporte a múltiplos backends
 * - Memory: Cache local (padrão)
 * - Redis: Cache compartilhado
 * - Layered: L1 (memory) + L2 (Redis)
 */
class CacheManager {
    /**
     * Inicializa o cache com a estratégia escolhida
     */
    static initialize(strategy) {
        this.enabled = process.env.CACHE_ENABLED !== 'false';
        this.strategy = strategy || process.env.CACHE_STRATEGY || 'memory';
        if (!this.enabled) {
            logger_1.log.warn('❌ Cache desabilitado (CACHE_ENABLED=false)');
            return;
        }
        const ttl = parseInt(process.env.CACHE_DEFAULT_TTL || '300', 10);
        try {
            switch (this.strategy) {
                case 'layered':
                    this.initializeLayered(ttl);
                    break;
                case 'redis':
                    this.initializeRedis(ttl);
                    break;
                case 'memory':
                default:
                    this.initializeMemory(ttl);
                    break;
            }
            logger_1.log.info('✅ Cache inicializado', {
                strategy: this.strategy,
                enabled: this.enabled,
                ttl
            });
        }
        catch (error) {
            logger_1.log.error('❌ Erro ao inicializar cache', { strategy: this.strategy, error });
            // Fallback para memória em caso de erro
            this.initializeMemory(ttl);
        }
    }
    static initializeMemory(ttl) {
        this.adapter = new MemoryCacheAdapter_1.MemoryCacheAdapter(ttl, 'Cache-Memory');
        this.strategy = 'memory';
    }
    static initializeRedis(ttl) {
        const redisUrl = process.env.CACHE_REDIS_URL || 'redis://localhost:6379';
        this.adapter = new RedisCacheAdapter_1.RedisCacheAdapter(redisUrl, 'Cache-Redis');
        this.strategy = 'redis';
    }
    static initializeLayered(ttl) {
        const redisUrl = process.env.CACHE_REDIS_URL || 'redis://localhost:6379';
        const l1 = new MemoryCacheAdapter_1.MemoryCacheAdapter(ttl, 'L1-Memory');
        const l2 = new RedisCacheAdapter_1.RedisCacheAdapter(redisUrl, 'L2-Redis');
        this.adapter = new LayeredCacheAdapter_1.LayeredCacheAdapter(l1, l2, 'Cache-Layered');
        this.strategy = 'layered';
    }
    /**
     * Retorna instância singleton (compatibilidade)
     */
    static getInstance() {
        if (!this.adapter) {
            this.initialize();
        }
        return this;
    }
    /**
     * Busca valor no cache
     */
    static async get(key) {
        if (!this.enabled || !this.adapter) {
            return undefined;
        }
        try {
            return await this.adapter.get(key);
        }
        catch (error) {
            logger_1.log.error('Cache GET error', { key, error });
            return undefined;
        }
    }
    /**
     * Armazena valor no cache
     */
    static async set(key, value, ttl) {
        if (!this.enabled || !this.adapter) {
            return false;
        }
        try {
            return await this.adapter.set(key, value, ttl);
        }
        catch (error) {
            logger_1.log.error('Cache SET error', { key, error });
            return false;
        }
    }
    /**
     * Remove valor do cache
     */
    static async delete(key) {
        if (!this.enabled || !this.adapter) {
            return 0;
        }
        try {
            return await this.adapter.delete(key);
        }
        catch (error) {
            logger_1.log.error('Cache DELETE error', { key, error });
            return 0;
        }
    }
    /**
     * Limpa todo o cache
     */
    static async flush() {
        if (!this.enabled || !this.adapter) {
            return;
        }
        try {
            await this.adapter.flush();
            logger_1.log.info('Cache limpo completamente');
        }
        catch (error) {
            logger_1.log.error('Cache FLUSH error', { error });
        }
    }
    /**
     * Lista chaves em cache
     */
    static async keys(pattern) {
        if (!this.enabled || !this.adapter) {
            return [];
        }
        try {
            return await this.adapter.keys(pattern);
        }
        catch (error) {
            logger_1.log.error('Cache KEYS error', { pattern, error });
            return [];
        }
    }
    /**
     * Invalida chaves por padrão (wildcards)
     */
    static async invalidate(pattern) {
        if (!this.enabled || !this.adapter) {
            return 0;
        }
        try {
            const keys = await this.adapter.keys(pattern);
            if (keys.length === 0) {
                logger_1.log.debug('Nenhuma chave encontrada para invalidar', { pattern });
                return 0;
            }
            const deletePromises = keys.map(key => this.adapter.delete(key));
            const results = await Promise.all(deletePromises);
            const total = results.reduce((sum, count) => sum + count, 0);
            logger_1.log.info('Cache invalidado', { pattern, keys: total });
            return total;
        }
        catch (error) {
            logger_1.log.error('Cache INVALIDATE error', { pattern, error });
            return 0;
        }
    }
    /**
     * Cache-aside pattern: busca ou executa função
     */
    static async getOrSet(key, fetchFn, ttl) {
        // Tenta buscar do cache
        const cached = await this.get(key);
        if (cached !== undefined) {
            return cached;
        }
        // Executa função para buscar dados
        const value = await fetchFn();
        // Armazena no cache
        await this.set(key, value, ttl);
        return value;
    }
    /**
     * Verifica se cache está pronto
     */
    static async isReady() {
        if (!this.enabled || !this.adapter) {
            return false;
        }
        try {
            return await this.adapter.isReady();
        }
        catch (error) {
            logger_1.log.error('Cache isReady error', { error });
            return false;
        }
    }
    /**
     * Retorna estatísticas do cache
     */
    static getStats() {
        if (!this.enabled || !this.adapter) {
            return {
                enabled: false,
                strategy: 'none'
            };
        }
        // LayeredCacheAdapter tem método getStats()
        if (this.adapter instanceof LayeredCacheAdapter_1.LayeredCacheAdapter) {
            return {
                enabled: true,
                strategy: this.strategy,
                ...this.adapter.getStats()
            };
        }
        // MemoryCacheAdapter tem método getStats()
        if (this.adapter instanceof MemoryCacheAdapter_1.MemoryCacheAdapter) {
            return {
                enabled: true,
                strategy: this.strategy,
                ...this.adapter.getStats()
            };
        }
        return {
            enabled: true,
            strategy: this.strategy
        };
    }
    /**
     * Fecha conexões (chamado no graceful shutdown)
     */
    static async close() {
        if (!this.adapter) {
            return;
        }
        try {
            await this.adapter.close();
            logger_1.log.info('Cache fechado');
        }
        catch (error) {
            logger_1.log.error('Cache CLOSE error', { error });
        }
    }
}
exports.CacheManager = CacheManager;
CacheManager.strategy = 'memory';
CacheManager.enabled = true;
/**
 * Gera chave de cache consistente
 */
function generateCacheKey(...parts) {
    return parts.filter(p => p !== undefined && p !== null).join(':');
}
/**
 * Decorator para cachear métodos de classe
 * @example
 * class MyService {
 *   @Cacheable({ ttl: 600, keyPrefix: 'service' })
 *   async getData(id: string) { ... }
 * }
 */
function Cacheable(options = {}) {
    return function (target, propertyKey, descriptor) {
        const originalMethod = descriptor.value;
        descriptor.value = async function (...args) {
            const keyPrefix = options.keyPrefix || target.constructor.name;
            const cacheKey = generateCacheKey(keyPrefix, propertyKey, ...args);
            return CacheManager.getOrSet(cacheKey, () => originalMethod.apply(this, args), options.ttl);
        };
        return descriptor;
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC91dGlscy9jYWNoZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLG1DQUFtQztBQUNuQywrREFBK0Q7OztBQXNTL0QsNENBRUM7QUFVRCw4QkFxQkM7QUFwVUQsbUVBQWdFO0FBQ2hFLGlFQUE4RDtBQUM5RCxxRUFBa0U7QUFDbEUscUNBQStCO0FBRS9COzs7OztHQUtHO0FBQ0gsTUFBYSxZQUFZO0lBS3ZCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFpQjtRQUNqQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxLQUFLLE9BQU8sQ0FBQztRQUNyRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxRQUFRLENBQUM7UUFFbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNsQixZQUFHLENBQUMsSUFBSSxDQUFDLDRDQUE0QyxDQUFDLENBQUM7WUFDdkQsT0FBTztRQUNULENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDO1lBQ0gsUUFBUSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLEtBQUssU0FBUztvQkFDWixJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzVCLE1BQU07Z0JBRVIsS0FBSyxPQUFPO29CQUNWLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzFCLE1BQU07Z0JBRVIsS0FBSyxRQUFRLENBQUM7Z0JBQ2Q7b0JBQ0UsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMzQixNQUFNO1lBQ1YsQ0FBQztZQUVELFlBQUcsQ0FB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QUFDLEdBQUcsQ0FDWixDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9tYW5vL3Byb2pldG9zL2RhdGFzdWwvbG9yMDEzOC9zcmMvc2hhcmVkL3V0aWxzL2NhY2hlTWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2hhcmVkL3V0aWxzL2NhY2hlTWFuYWdlci50c1xuLy8g4pyFIFZFUlPDg08gQVRVQUxJWkFEQTogU3Vwb3J0YSBNZW1vcnksIFJlZGlzIGUgTGF5ZXJlZCAoTDErTDIpXG5cbmltcG9ydCB7IENhY2hlQWRhcHRlciB9IGZyb20gJy4vY2FjaGUvQ2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IE1lbW9yeUNhY2hlQWRhcHRlciB9IGZyb20gJy4vY2FjaGUvTWVtb3J5Q2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IFJlZGlzQ2FjaGVBZGFwdGVyIH0gZnJvbSAnLi9jYWNoZS9SZWRpc0NhY2hlQWRhcHRlcic7XG5pbXBvcnQgeyBMYXllcmVkQ2FjaGVBZGFwdGVyIH0gZnJvbSAnLi9jYWNoZS9MYXllcmVkQ2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vbG9nZ2VyJztcblxuLyoqXG4gKiBHZXJlbmNpYWRvciBkZSBjYWNoZSBjb20gc3Vwb3J0ZSBhIG3Dumx0aXBsb3MgYmFja2VuZHNcbiAqIC0gTWVtb3J5OiBDYWNoZSBsb2NhbCAocGFkcsOjbylcbiAqIC0gUmVkaXM6IENhY2hlIGNvbXBhcnRpbGhhZG9cbiAqIC0gTGF5ZXJlZDogTDEgKG1lbW9yeSkgKyBMMiAoUmVkaXMpXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZU1hbmFnZXIge1xuICBwcml2YXRlIHN0YXRpYyBhZGFwdGVyOiBDYWNoZUFkYXB0ZXI7XG4gIHByaXZhdGUgc3RhdGljIHN0cmF0ZWd5OiBzdHJpbmcgPSAnbWVtb3J5JztcbiAgcHJpdmF0ZSBzdGF0aWMgZW5hYmxlZDogYm9vbGVhbiA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEluaWNpYWxpemEgbyBjYWNoZSBjb20gYSBlc3RyYXTDqWdpYSBlc2NvbGhpZGFcbiAgICovXG4gIHN0YXRpYyBpbml0aWFsaXplKHN0cmF0ZWd5Pzogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5lbmFibGVkID0gcHJvY2Vzcy5lbnYuQ0FDSEVfRU5BQkxFRCAhPT0gJ2ZhbHNlJztcbiAgICB0aGlzLnN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgcHJvY2Vzcy5lbnYuQ0FDSEVfU1RSQVRFR1kgfHwgJ21lbW9yeSc7XG5cbiAgICBpZiAoIXRoaXMuZW5hYmxlZCkge1xuICAgICAgbG9nLndhcm4oJ+KdjCBDYWNoZSBkZXNhYmlsaXRhZG8gKENBQ0hFX0VOQUJMRUQ9ZmFsc2UpJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdHRsID0gcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0FDSEVfREVGQVVMVF9UVEwgfHwgJzMwMCcsIDEwKTtcblxuICAgIHRyeSB7XG4gICAgICBzd2l0Y2ggKHRoaXMuc3RyYXRlZ3kpIHtcbiAgICAgICAgY2FzZSAnbGF5ZXJlZCc6XG4gICAgICAgICAgdGhpcy5pbml0aWFsaXplTGF5ZXJlZCh0dGwpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ3JlZGlzJzpcbiAgICAgICAgICB0aGlzLmluaXRpYWxpemVSZWRpcyh0dGwpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhpcy5pbml0aWFsaXplTWVtb3J5KHR0bCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGxvZy5pbmZvKCfinIUgQ2FjaGUgaW5pY2lhbGl6YWRvJywgeyBcbiAgICAgICAgc3RyYXRlZ3k6IHRoaXMuc3RyYXRlZ3ksIFxuICAgICAgICBlbmFibGVkOiB0aGlzLmVuYWJsZWQsXG4gICAgICAgIHR0bCBcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ+KdjCBFcnJvIGFvIGluaWNpYWxpemFyIGNhY2hlJywgeyBzdHJhdGVneTogdGhpcy5zdHJhdGVneSwgZXJyb3IgfSk7XG4gICAgICAvLyBGYWxsYmFjayBwYXJhIG1lbcOzcmlhIGVtIGNhc28gZGUgZXJyb1xuICAgICAgdGhpcy5pbml0aWFsaXplTWVtb3J5KHR0bCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaW5pdGlhbGl6ZU1lbW9yeSh0dGw6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuYWRhcHRlciA9IG5ldyBNZW1vcnlDYWNoZUFkYXB0ZXIodHRsLCAnQ2FjaGUtTWVtb3J5Jyk7XG4gICAgdGhpcy5zdHJhdGVneSA9ICdtZW1vcnknO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaW5pdGlhbGl6ZVJlZGlzKHR0bDogbnVtYmVyKTogdm9pZCB7XG4gICAgY29uc3QgcmVkaXNVcmwgPSBwcm9jZXNzLmVudi5DQUNIRV9SRURJU19VUkwgfHwgJ3JlZGlzOi8vbG9jYWxob3N0OjYzNzknO1xuICAgIHRoaXMuYWRhcHRlciA9IG5ldyBSZWRpc0NhY2hlQWRhcHRlcihyZWRpc1VybCwgJ0NhY2hlLVJlZGlzJyk7XG4gICAgdGhpcy5zdHJhdGVneSA9ICdyZWRpcyc7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpbml0aWFsaXplTGF5ZXJlZCh0dGw6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHJlZGlzVXJsID0gcHJvY2Vzcy5lbnYuQ0FDSEVfUkVESVNfVVJMIHx8ICdyZWRpczovL2xvY2FsaG9zdDo2Mzc5JztcbiAgICBcbiAgICBjb25zdCBsMSA9IG5ldyBNZW1vcnlDYWNoZUFkYXB0ZXIodHRsLCAnTDEtTWVtb3J5Jyk7XG4gICAgY29uc3QgbDIgPSBuZXcgUmVkaXNDYWNoZUFkYXB0ZXIocmVkaXNVcmwsICdMMi1SZWRpcycpO1xuICAgIFxuICAgIHRoaXMuYWRhcHRlciA9IG5ldyBMYXllcmVkQ2FjaGVBZGFwdGVyKGwxLCBsMiwgJ0NhY2hlLUxheWVyZWQnKTtcbiAgICB0aGlzLnN0cmF0ZWd5ID0gJ2xheWVyZWQnO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgaW5zdMOibmNpYSBzaW5nbGV0b24gKGNvbXBhdGliaWxpZGFkZSlcbiAgICovXG4gIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBDYWNoZU1hbmFnZXIge1xuICAgIGlmICghdGhpcy5hZGFwdGVyKSB7XG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdmFsb3Igbm8gY2FjaGVcbiAgICovXG4gIHN0YXRpYyBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhdGhpcy5hZGFwdGVyKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZGFwdGVyLmdldDxUPihrZXkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NhY2hlIEdFVCBlcnJvcicsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFybWF6ZW5hIHZhbG9yIG5vIGNhY2hlXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgc2V0PFQ+KGtleTogc3RyaW5nLCB2YWx1ZTogVCwgdHRsPzogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZGFwdGVyLnNldChrZXksIHZhbHVlLCB0dGwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NhY2hlIFNFVCBlcnJvcicsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHZhbG9yIGRvIGNhY2hlXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhdGhpcy5hZGFwdGVyKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYWRhcHRlci5kZWxldGUoa2V5KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCdDYWNoZSBERUxFVEUgZXJyb3InLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGltcGEgdG9kbyBvIGNhY2hlXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZmx1c2goKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYXB0ZXIuZmx1c2goKTtcbiAgICAgIGxvZy5pbmZvKCdDYWNoZSBsaW1wbyBjb21wbGV0YW1lbnRlJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcignQ2FjaGUgRkxVU0ggZXJyb3InLCB7IGVycm9yIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0YSBjaGF2ZXMgZW0gY2FjaGVcbiAgICovXG4gIHN0YXRpYyBhc3luYyBrZXlzKHBhdHRlcm4/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZGFwdGVyLmtleXMocGF0dGVybik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcignQ2FjaGUgS0VZUyBlcnJvcicsIHsgcGF0dGVybiwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEludmFsaWRhIGNoYXZlcyBwb3IgcGFkcsOjbyAod2lsZGNhcmRzKVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGludmFsaWRhdGUocGF0dGVybjogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhdGhpcy5hZGFwdGVyKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMuYWRhcHRlci5rZXlzKHBhdHRlcm4pO1xuICAgICAgXG4gICAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgbG9nLmRlYnVnKCdOZW5odW1hIGNoYXZlIGVuY29udHJhZGEgcGFyYSBpbnZhbGlkYXInLCB7IHBhdHRlcm4gfSk7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkZWxldGVQcm9taXNlcyA9IGtleXMubWFwKGtleSA9PiB0aGlzLmFkYXB0ZXIuZGVsZXRlKGtleSkpO1xuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKGRlbGV0ZVByb21pc2VzKTtcbiAgICAgIGNvbnN0IHRvdGFsID0gcmVzdWx0cy5yZWR1Y2UoKHN1bSwgY291bnQpID0+IHN1bSArIGNvdW50LCAwKTtcblxuICAgICAgbG9nLmluZm8oJ0NhY2hlIGludmFsaWRhZG8nLCB7IHBhdHRlcm4sIGtleXM6IHRvdGFsIH0pO1xuICAgICAgcmV0dXJuIHRvdGFsO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NhY2hlIElOVkFMSURBVEUgZXJyb3InLCB7IHBhdHRlcm4sIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENhY2hlLWFzaWRlIHBhdHRlcm46IGJ1c2NhIG91IGV4ZWN1dGEgZnVuw6fDo29cbiAgICovXG4gIHN0YXRpYyBhc3luYyBnZXRPclNldDxUPihcbiAgICBrZXk6IHN0cmluZyxcbiAgICBmZXRjaEZuOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIHR0bD86IG51bWJlclxuICApOiBQcm9taXNlPFQ+IHtcbiAgICAvLyBUZW50YSBidXNjYXIgZG8gY2FjaGVcbiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCB0aGlzLmdldDxUPihrZXkpO1xuICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGNhY2hlZDtcbiAgICB9XG5cbiAgICAvLyBFeGVjdXRhIGZ1bsOnw6NvIHBhcmEgYnVzY2FyIGRhZG9zXG4gICAgY29uc3QgdmFsdWUgPSBhd2FpdCBmZXRjaEZuKCk7XG5cbiAgICAvLyBBcm1hemVuYSBubyBjYWNoZVxuICAgIGF3YWl0IHRoaXMuc2V0KGtleSwgdmFsdWUsIHR0bCk7XG5cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgY2FjaGUgZXN0w6EgcHJvbnRvXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgaXNSZWFkeSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhdGhpcy5hZGFwdGVyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmFkYXB0ZXIuaXNSZWFkeSgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NhY2hlIGlzUmVhZHkgZXJyb3InLCB7IGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIGVzdGF0w61zdGljYXMgZG8gY2FjaGVcbiAgICovXG4gIHN0YXRpYyBnZXRTdGF0cygpOiBhbnkge1xuICAgIGlmICghdGhpcy5lbmFibGVkIHx8ICF0aGlzLmFkYXB0ZXIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICBzdHJhdGVneTogJ25vbmUnXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIExheWVyZWRDYWNoZUFkYXB0ZXIgdGVtIG3DqXRvZG8gZ2V0U3RhdHMoKVxuICAgIGlmICh0aGlzLmFkYXB0ZXIgaW5zdGFuY2VvZiBMYXllcmVkQ2FjaGVBZGFwdGVyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBzdHJhdGVneTogdGhpcy5zdHJhdGVneSxcbiAgICAgICAgLi4udGhpcy5hZGFwdGVyLmdldFN0YXRzKClcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gTWVtb3J5Q2FjaGVBZGFwdGVyIHRlbSBtw6l0b2RvIGdldFN0YXRzKClcbiAgICBpZiAodGhpcy5hZGFwdGVyIGluc3RhbmNlb2YgTWVtb3J5Q2FjaGVBZGFwdGVyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICBzdHJhdGVneTogdGhpcy5zdHJhdGVneSxcbiAgICAgICAgLi4udGhpcy5hZGFwdGVyLmdldFN0YXRzKClcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICBzdHJhdGVneTogdGhpcy5zdHJhdGVneVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRmVjaGEgY29uZXjDtWVzIChjaGFtYWRvIG5vIGdyYWNlZnVsIHNodXRkb3duKVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5hZGFwdGVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuYWRhcHRlci5jbG9zZSgpO1xuICAgICAgbG9nLmluZm8oJ0NhY2hlIGZlY2hhZG8nKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCdDYWNoZSBDTE9TRSBlcnJvcicsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2VyYSBjaGF2ZSBkZSBjYWNoZSBjb25zaXN0ZW50ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVDYWNoZUtleSguLi5wYXJ0czogKHN0cmluZyB8IG51bWJlcilbXSk6IHN0cmluZyB7XG4gIHJldHVybiBwYXJ0cy5maWx0ZXIocCA9PiBwICE9PSB1bmRlZmluZWQgJiYgcCAhPT0gbnVsbCkuam9pbignOicpO1xufVxuXG4vKipcbiAqIERlY29yYXRvciBwYXJhIGNhY2hlYXIgbcOpdG9kb3MgZGUgY2xhc3NlXG4gKiBAZXhhbXBsZVxuICogY2xhc3MgTXlTZXJ2aWNlIHtcbiAqICAgQENhY2hlYWJsZSh7IHR0bDogNjAwLCBrZXlQcmVmaXg6ICdzZXJ2aWNlJyB9KVxuICogICBhc3luYyBnZXREYXRhKGlkOiBzdHJpbmcpIHsgLi4uIH1cbiAqIH1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIENhY2hlYWJsZShvcHRpb25zOiB7IHR0bD86IG51bWJlcjsga2V5UHJlZml4Pzogc3RyaW5nIH0gPSB7fSkge1xuICByZXR1cm4gZnVuY3Rpb24gKFxuICAgIHRhcmdldDogYW55LFxuICAgIHByb3BlcnR5S2V5OiBzdHJpbmcsXG4gICAgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yXG4gICkge1xuICAgIGNvbnN0IG9yaWdpbmFsTWV0aG9kID0gZGVzY3JpcHRvci52YWx1ZTtcblxuICAgIGRlc2NyaXB0b3IudmFsdWUgPSBhc3luYyBmdW5jdGlvbiAoLi4uYXJnczogYW55W10pIHtcbiAgICAgIGNvbnN0IGtleVByZWZpeCA9IG9wdGlvbnMua2V5UHJlZml4IHx8IHRhcmdldC5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgY29uc3QgY2FjaGVLZXkgPSBnZW5lcmF0ZUNhY2hlS2V5KGtleVByZWZpeCwgcHJvcGVydHlLZXksIC4uLmFyZ3MpO1xuXG4gICAgICByZXR1cm4gQ2FjaGVNYW5hZ2VyLmdldE9yU2V0KFxuICAgICAgICBjYWNoZUtleSxcbiAgICAgICAgKCkgPT4gb3JpZ2luYWxNZXRob2QuYXBwbHkodGhpcywgYXJncyksXG4gICAgICAgIG9wdGlvbnMudHRsXG4gICAgICApO1xuICAgIH07XG5cbiAgICByZXR1cm4gZGVzY3JpcHRvcjtcbiAgfTtcbn0iXSwidmVyc2lvbiI6M30=