47192a110bf8fbaf904512fc0fe06fef
"use strict";
// src/shared/utils/UserRateLimiter.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.UserRateLimiter = void 0;
const apiKey_types_1 = require("@shared/types/apiKey.types");
const logger_1 = require("./logger");
/**
 * Rate Limiter por usuário com múltiplas janelas de tempo
 */
class UserRateLimiter {
    /**
     * Verifica se a requisição está dentro do rate limit
     */
    static check(userId, tier) {
        const config = apiKey_types_1.RATE_LIMIT_CONFIGS[tier];
        const now = Date.now();
        // Busca ou cria record
        let record = this.records.get(userId);
        if (!record) {
            record = this.createRecord(userId, tier);
            this.records.set(userId, record);
        }
        // Reseta contadores se necessário
        this.resetIfNeeded(record, now);
        // Verifica cada limite (minuto, hora, dia)
        const minuteCheck = this.checkWindow(record.minute, config.limits.perMinute, 60 * 1000, now);
        const hourCheck = this.checkWindow(record.hour, config.limits.perHour, 60 * 60 * 1000, now);
        const dayCheck = this.checkWindow(record.day, config.limits.perDay, 24 * 60 * 60 * 1000, now);
        // Se algum limite foi excedido
        if (!minuteCheck.allowed || !hourCheck.allowed || !dayCheck.allowed) {
            // Retorna o limite mais restritivo
            const mostRestrictive = [minuteCheck, hourCheck, dayCheck]
                .filter(c => !c.allowed)
                .sort((a, b) => a.resetAt - b.resetAt)[0];
            logger_1.log.warn('Rate limit excedido', {
                userId,
                tier,
                limit: mostRestrictive.limit,
                resetAt: new Date(mostRestrictive.resetAt)
            });
            return mostRestrictive;
        }
        // Incrementa contadores
        record.minute.count++;
        record.hour.count++;
        record.day.count++;
        // Retorna limite mais próximo de ser atingido
        const closest = [minuteCheck, hourCheck, dayCheck]
            .sort((a, b) => a.remaining - b.remaining)[0];
        return closest;
    }
    /**
     * Verifica uma janela de tempo específica
     */
    static checkWindow(window, limit, duration, now) {
        const allowed = window.count < limit;
        const remaining = Math.max(0, limit - window.count);
        const retryAfter = allowed ? undefined : Math.ceil((window.resetAt - now) / 1000);
        return {
            allowed,
            limit,
            remaining,
            resetAt: window.resetAt,
            retryAfter
        };
    }
    /**
     * Cria novo record para usuário
     */
    static createRecord(userId, tier) {
        const now = Date.now();
        return {
            userId,
            tier,
            minute: { count: 0, resetAt: now + 60 * 1000 },
            hour: { count: 0, resetAt: now + 60 * 60 * 1000 },
            day: { count: 0, resetAt: now + 24 * 60 * 60 * 1000 }
        };
    }
    /**
     * Reseta contadores se janela expirou
     */
    static resetIfNeeded(record, now) {
        if (now >= record.minute.resetAt) {
            record.minute.count = 0;
            record.minute.resetAt = now + 60 * 1000;
        }
        if (now >= record.hour.resetAt) {
            record.hour.count = 0;
            record.hour.resetAt = now + 60 * 60 * 1000;
        }
        if (now >= record.day.resetAt) {
            record.day.count = 0;
            record.day.resetAt = now + 24 * 60 * 60 * 1000;
        }
    }
    /**
     * Limpa records antigos (garbage collection)
     */
    static cleanup() {
        const now = Date.now();
        const threshold = 24 * 60 * 60 * 1000; // 24 horas
        for (const [userId, record] of this.records.entries()) {
            if (now > record.day.resetAt + threshold) {
                this.records.delete(userId);
            }
        }
        logger_1.log.debug('Rate limiter cleanup', {
            recordsRemaining: this.records.size
        });
    }
    /**
     * Retorna estatísticas de uso
     */
    static getStats(userId) {
        if (userId) {
            const record = this.records.get(userId);
            if (!record)
                return null;
            const config = apiKey_types_1.RATE_LIMIT_CONFIGS[record.tier];
            return {
                userId: record.userId,
                tier: record.tier,
                usage: {
                    minute: {
                        current: record.minute.count,
                        limit: config.limits.perMinute,
                        remaining: config.limits.perMinute - record.minute.count,
                        resetAt: new Date(record.minute.resetAt)
                    },
                    hour: {
                        current: record.hour.count,
                        limit: config.limits.perHour,
                        remaining: config.limits.perHour - record.hour.count,
                        resetAt: new Date(record.hour.resetAt)
                    },
                    day: {
                        current: record.day.count,
                        limit: config.limits.perDay,
                        remaining: config.limits.perDay - record.day.count,
                        resetAt: new Date(record.day.resetAt)
                    }
                }
            };
        }
        // Estatísticas gerais
        return {
            totalUsers: this.records.size,
            byTier: {
                free: Array.from(this.records.values()).filter(r => r.tier === apiKey_types_1.UserTier.FREE).length,
                premium: Array.from(this.records.values()).filter(r => r.tier === apiKey_types_1.UserTier.PREMIUM).length,
                enterprise: Array.from(this.records.values()).filter(r => r.tier === apiKey_types_1.UserTier.ENTERPRISE).length,
                admin: Array.from(this.records.values()).filter(r => r.tier === apiKey_types_1.UserTier.ADMIN).length,
            }
        };
    }
    /**
     * Reseta limites de um usuário (admin)
     */
    static resetUser(userId) {
        this.records.delete(userId);
        logger_1.log.info('Rate limit resetado', { userId });
    }
}
exports.UserRateLimiter = UserRateLimiter;
UserRateLimiter.records = new Map();
// Cleanup automático a cada hora
setInterval(() => {
    UserRateLimiter.cleanup();
}, 60 * 60 * 1000);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC91dGlscy9Vc2VyUmF0ZUxpbWl0ZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHNDQUFzQzs7O0FBRXRDLDZEQUEwRTtBQUMxRSxxQ0FBK0I7QUFrQi9COztHQUVHO0FBQ0gsTUFBYSxlQUFlO0lBRzFCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFjLEVBQUUsSUFBYztRQUN6QyxNQUFNLE1BQU0sR0FBRyxpQ0FBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFdkIsdUJBQXVCO1FBQ3ZCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNaLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbkMsQ0FBQztRQUVELGtDQUFrQztRQUNsQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVoQywyQ0FBMkM7UUFDM0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FDbEMsTUFBTSxDQUFDLE1BQU0sRUFDYixNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFDdkIsRUFBRSxHQUFHLElBQUksRUFDVCxHQUFHLENBQ0osQ0FBQztRQUVGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQ2hDLE1BQU0sQ0FBQyxJQUFJLEVBQ1gsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQ3JCLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUNkLEdBQUcsQ0FDSixDQUFDO1FBRUYsTUFB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SUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssdUJBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNO2dCQUNoRyxLQUFLLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyx1QkFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU07YUFDdkY7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFjO1FBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVCLFlBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQzlDLENBQUM7O0FBeE1ILDBDQXlNQztBQXhNZ0IsdUJBQU8sR0FBaUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQTBNbkUsaUNBQWlDO0FBQ2pDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7SUFDZixlQUFlLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDNUIsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC91dGlscy9Vc2VyUmF0ZUxpbWl0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL3NoYXJlZC91dGlscy9Vc2VyUmF0ZUxpbWl0ZXIudHNcblxuaW1wb3J0IHsgVXNlclRpZXIsIFJBVEVfTElNSVRfQ09ORklHUyB9IGZyb20gJ0BzaGFyZWQvdHlwZXMvYXBpS2V5LnR5cGVzJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vbG9nZ2VyJztcblxuaW50ZXJmYWNlIFJhdGVMaW1pdFJlY29yZCB7XG4gIHVzZXJJZDogc3RyaW5nO1xuICB0aWVyOiBVc2VyVGllcjtcbiAgbWludXRlOiB7IGNvdW50OiBudW1iZXI7IHJlc2V0QXQ6IG51bWJlciB9O1xuICBob3VyOiB7IGNvdW50OiBudW1iZXI7IHJlc2V0QXQ6IG51bWJlciB9O1xuICBkYXk6IHsgY291bnQ6IG51bWJlcjsgcmVzZXRBdDogbnVtYmVyIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmF0ZUxpbWl0UmVzdWx0IHtcbiAgYWxsb3dlZDogYm9vbGVhbjtcbiAgbGltaXQ6IG51bWJlcjtcbiAgcmVtYWluaW5nOiBudW1iZXI7XG4gIHJlc2V0QXQ6IG51bWJlcjtcbiAgcmV0cnlBZnRlcj86IG51bWJlcjtcbn1cblxuLyoqXG4gKiBSYXRlIExpbWl0ZXIgcG9yIHVzdcOhcmlvIGNvbSBtw7psdGlwbGFzIGphbmVsYXMgZGUgdGVtcG9cbiAqL1xuZXhwb3J0IGNsYXNzIFVzZXJSYXRlTGltaXRlciB7XG4gIHByaXZhdGUgc3RhdGljIHJlY29yZHM6IE1hcDxzdHJpbmcsIFJhdGVMaW1pdFJlY29yZD4gPSBuZXcgTWFwKCk7XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIGEgcmVxdWlzacOnw6NvIGVzdMOhIGRlbnRybyBkbyByYXRlIGxpbWl0XG4gICAqL1xuICBzdGF0aWMgY2hlY2sodXNlcklkOiBzdHJpbmcsIHRpZXI6IFVzZXJUaWVyKTogUmF0ZUxpbWl0UmVzdWx0IHtcbiAgICBjb25zdCBjb25maWcgPSBSQVRFX0xJTUlUX0NPTkZJR1NbdGllcl07XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcblxuICAgIC8vIEJ1c2NhIG91IGNyaWEgcmVjb3JkXG4gICAgbGV0IHJlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQodXNlcklkKTtcbiAgICBpZiAoIXJlY29yZCkge1xuICAgICAgcmVjb3JkID0gdGhpcy5jcmVhdGVSZWNvcmQodXNlcklkLCB0aWVyKTtcbiAgICAgIHRoaXMucmVjb3Jkcy5zZXQodXNlcklkLCByZWNvcmQpO1xuICAgIH1cblxuICAgIC8vIFJlc2V0YSBjb250YWRvcmVzIHNlIG5lY2Vzc8OhcmlvXG4gICAgdGhpcy5yZXNldElmTmVlZGVkKHJlY29yZCwgbm93KTtcblxuICAgIC8vIFZlcmlmaWNhIGNhZGEgbGltaXRlIChtaW51dG8sIGhvcmEsIGRpYSlcbiAgICBjb25zdCBtaW51dGVDaGVjayA9IHRoaXMuY2hlY2tXaW5kb3coXG4gICAgICByZWNvcmQubWludXRlLFxuICAgICAgY29uZmlnLmxpbWl0cy5wZXJNaW51dGUsXG4gICAgICA2MCAqIDEwMDAsXG4gICAgICBub3dcbiAgICApO1xuXG4gICAgY29uc3QgaG91ckNoZWNrID0gdGhpcy5jaGVja1dpbmRvdyhcbiAgICAgIHJlY29yZC5ob3VyLFxuICAgICAgY29uZmlnLmxpbWl0cy5wZXJIb3VyLFxuICAgICAgNjAgKiA2MCAqIDEwMDAsXG4gICAgICBub3dcbiAgICApO1xuXG4gICAgY29uc3QgZGF5Q2hlY2sgPSB0aGlzLmNoZWNrV2luZG93KFxuICAgICAgcmVjb3JkLmRheSxcbiAgICAgIGNvbmZpZy5saW1pdHMucGVyRGF5LFxuICAgICAgMjQgKiA2MCAqIDYwICogMTAwMCxcbiAgICAgIG5vd1xuICAgICk7XG5cbiAgICAvLyBTZSBhbGd1bSBsaW1pdGUgZm9pIGV4Y2VkaWRvXG4gICAgaWYgKCFtaW51dGVDaGVjay5hbGxvd2VkIHx8ICFob3VyQ2hlY2suYWxsb3dlZCB8fCAhZGF5Q2hlY2suYWxsb3dlZCkge1xuICAgICAgLy8gUmV0b3JuYSBvIGxpbWl0ZSBtYWlzIHJlc3RyaXRpdm9cbiAgICAgIGNvbnN0IG1vc3RSZXN0cmljdGl2ZSA9IFttaW51dGVDaGVjaywgaG91ckNoZWNrLCBkYXlDaGVja11cbiAgICAgICAgLmZpbHRlcihjID0+ICFjLmFsbG93ZWQpXG4gICAgICAgIC5zb3J0KChhLCBiKSA9PiBhLnJlc2V0QXQgLSBiLnJlc2V0QXQpWzBdO1xuXG4gICAgICBsb2cud2FybignUmF0ZSBsaW1pdCBleGNlZGlkbycsIHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB0aWVyLFxuICAgICAgICBsaW1pdDogbW9zdFJlc3RyaWN0aXZlLmxpbWl0LFxuICAgICAgICByZXNldEF0OiBuZXcgRGF0ZShtb3N0UmVzdHJpY3RpdmUucmVzZXRBdClcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gbW9zdFJlc3RyaWN0aXZlO1xuICAgIH1cblxuICAgIC8vIEluY3JlbWVudGEgY29udGFkb3Jlc1xuICAgIHJlY29yZC5taW51dGUuY291bnQrKztcbiAgICByZWNvcmQuaG91ci5jb3VudCsrO1xuICAgIHJlY29yZC5kYXkuY291bnQrKztcblxuICAgIC8vIFJldG9ybmEgbGltaXRlIG1haXMgcHLDs3hpbW8gZGUgc2VyIGF0aW5naWRvXG4gICAgY29uc3QgY2xvc2VzdCA9IFttaW51dGVDaGVjaywgaG91ckNoZWNrLCBkYXlDaGVja11cbiAgICAgIC5zb3J0KChhLCBiKSA9PiBhLnJlbWFpbmluZyAtIGIucmVtYWluaW5nKVswXTtcblxuICAgIHJldHVybiBjbG9zZXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHVtYSBqYW5lbGEgZGUgdGVtcG8gZXNwZWPDrWZpY2FcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGNoZWNrV2luZG93KFxuICAgIHdpbmRvdzogeyBjb3VudDogbnVtYmVyOyByZXNldEF0OiBudW1iZXIgfSxcbiAgICBsaW1pdDogbnVtYmVyLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICAgbm93OiBudW1iZXJcbiAgKTogUmF0ZUxpbWl0UmVzdWx0IHtcbiAgICBjb25zdCBhbGxvd2VkID0gd2luZG93LmNvdW50IDwgbGltaXQ7XG4gICAgY29uc3QgcmVtYWluaW5nID0gTWF0aC5tYXgoMCwgbGltaXQgLSB3aW5kb3cuY291bnQpO1xuICAgIGNvbnN0IHJldHJ5QWZ0ZXIgPSBhbGxvd2VkID8gdW5kZWZpbmVkIDogTWF0aC5jZWlsKCh3aW5kb3cucmVzZXRBdCAtIG5vdykgLyAxMDAwKTtcblxuICAgIHJldHVybiB7XG4gICAgICBhbGxvd2VkLFxuICAgICAgbGltaXQsXG4gICAgICByZW1haW5pbmcsXG4gICAgICByZXNldEF0OiB3aW5kb3cucmVzZXRBdCxcbiAgICAgIHJldHJ5QWZ0ZXJcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyaWEgbm92byByZWNvcmQgcGFyYSB1c3XDoXJpb1xuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlUmVjb3JkKHVzZXJJZDogc3RyaW5nLCB0aWVyOiBVc2VyVGllcik6IFJhdGVMaW1pdFJlY29yZCB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcblxuICAgIHJldHVybiB7XG4gICAgICB1c2VySWQsXG4gICAgICB0aWVyLFxuICAgICAgbWludXRlOiB7IGNvdW50OiAwLCByZXNldEF0OiBub3cgKyA2MCAqIDEwMDAgfSxcbiAgICAgIGhvdXI6IHsgY291bnQ6IDAsIHJlc2V0QXQ6IG5vdyArIDYwICogNjAgKiAxMDAwIH0sXG4gICAgICBkYXk6IHsgY291bnQ6IDAsIHJlc2V0QXQ6IG5vdyArIDI0ICogNjAgKiA2MCAqIDEwMDAgfVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRhIGNvbnRhZG9yZXMgc2UgamFuZWxhIGV4cGlyb3VcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIHJlc2V0SWZOZWVkZWQocmVjb3JkOiBSYXRlTGltaXRSZWNvcmQsIG5vdzogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKG5vdyA+PSByZWNvcmQubWludXRlLnJlc2V0QXQpIHtcbiAgICAgIHJlY29yZC5taW51dGUuY291bnQgPSAwO1xuICAgICAgcmVjb3JkLm1pbnV0ZS5yZXNldEF0ID0gbm93ICsgNjAgKiAxMDAwO1xuICAgIH1cblxuICAgIGlmIChub3cgPj0gcmVjb3JkLmhvdXIucmVzZXRBdCkge1xuICAgICAgcmVjb3JkLmhvdXIuY291bnQgPSAwO1xuICAgICAgcmVjb3JkLmhvdXIucmVzZXRBdCA9IG5vdyArIDYwICogNjAgKiAxMDAwO1xuICAgIH1cblxuICAgIGlmIChub3cgPj0gcmVjb3JkLmRheS5yZXNldEF0KSB7XG4gICAgICByZWNvcmQuZGF5LmNvdW50ID0gMDtcbiAgICAgIHJlY29yZC5kYXkucmVzZXRBdCA9IG5vdyArIDI0ICogNjAgKiA2MCAqIDEwMDA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpbXBhIHJlY29yZHMgYW50aWdvcyAoZ2FyYmFnZSBjb2xsZWN0aW9uKVxuICAgKi9cbiAgc3RhdGljIGNsZWFudXAoKTogdm9pZCB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB0aHJlc2hvbGQgPSAyNCAqIDYwICogNjAgKiAxMDAwOyAvLyAyNCBob3Jhc1xuXG4gICAgZm9yIChjb25zdCBbdXNlcklkLCByZWNvcmRdIG9mIHRoaXMucmVjb3Jkcy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChub3cgPiByZWNvcmQuZGF5LnJlc2V0QXQgKyB0aHJlc2hvbGQpIHtcbiAgICAgICAgdGhpcy5yZWNvcmRzLmRlbGV0ZSh1c2VySWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxvZy5kZWJ1ZygnUmF0ZSBsaW1pdGVyIGNsZWFudXAnLCB7XG4gICAgICByZWNvcmRzUmVtYWluaW5nOiB0aGlzLnJlY29yZHMuc2l6ZVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgZXN0YXTDrXN0aWNhcyBkZSB1c29cbiAgICovXG4gIHN0YXRpYyBnZXRTdGF0cyh1c2VySWQ/OiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMucmVjb3Jkcy5nZXQodXNlcklkKTtcbiAgICAgIGlmICghcmVjb3JkKSByZXR1cm4gbnVsbDtcblxuICAgICAgY29uc3QgY29uZmlnID0gUkFURV9MSU1JVF9DT05GSUdTW3JlY29yZC50aWVyXTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdXNlcklkOiByZWNvcmQudXNlcklkLFxuICAgICAgICB0aWVyOiByZWNvcmQudGllcixcbiAgICAgICAgdXNhZ2U6IHtcbiAgICAgICAgICBtaW51dGU6IHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IHJlY29yZC5taW51dGUuY291bnQsXG4gICAgICAgICAgICBsaW1pdDogY29uZmlnLmxpbWl0cy5wZXJNaW51dGUsXG4gICAgICAgICAgICByZW1haW5pbmc6IGNvbmZpZy5saW1pdHMucGVyTWludXRlIC0gcmVjb3JkLm1pbnV0ZS5jb3VudCxcbiAgICAgICAgICAgIHJlc2V0QXQ6IG5ldyBEYXRlKHJlY29yZC5taW51dGUucmVzZXRBdClcbiAgICAgICAgICB9LFxuICAgICAgICAgIGhvdXI6IHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IHJlY29yZC5ob3VyLmNvdW50LFxuICAgICAgICAgICAgbGltaXQ6IGNvbmZpZy5saW1pdHMucGVySG91cixcbiAgICAgICAgICAgIHJlbWFpbmluZzogY29uZmlnLmxpbWl0cy5wZXJIb3VyIC0gcmVjb3JkLmhvdXIuY291bnQsXG4gICAgICAgICAgICByZXNldEF0OiBuZXcgRGF0ZShyZWNvcmQuaG91ci5yZXNldEF0KVxuICAgICAgICAgIH0sXG4gICAgICAgICAgZGF5OiB7XG4gICAgICAgICAgICBjdXJyZW50OiByZWNvcmQuZGF5LmNvdW50LFxuICAgICAgICAgICAgbGltaXQ6IGNvbmZpZy5saW1pdHMucGVyRGF5LFxuICAgICAgICAgICAgcmVtYWluaW5nOiBjb25maWcubGltaXRzLnBlckRheSAtIHJlY29yZC5kYXkuY291bnQsXG4gICAgICAgICAgICByZXNldEF0OiBuZXcgRGF0ZShyZWNvcmQuZGF5LnJlc2V0QXQpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEVzdGF0w61zdGljYXMgZ2VyYWlzXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsVXNlcnM6IHRoaXMucmVjb3Jkcy5zaXplLFxuICAgICAgYnlUaWVyOiB7XG4gICAgICAgIGZyZWU6IEFycmF5LmZyb20odGhpcy5yZWNvcmRzLnZhbHVlcygpKS5maWx0ZXIociA9PiByLnRpZXIgPT09IFVzZXJUaWVyLkZSRUUpLmxlbmd0aCxcbiAgICAgICAgcHJlbWl1bTogQXJyYXkuZnJvbSh0aGlzLnJlY29yZHMudmFsdWVzKCkpLmZpbHRlcihyID0+IHIudGllciA9PT0gVXNlclRpZXIuUFJFTUlVTSkubGVuZ3RoLFxuICAgICAgICBlbnRlcnByaXNlOiBBcnJheS5mcm9tKHRoaXMucmVjb3Jkcy52YWx1ZXMoKSkuZmlsdGVyKHIgPT4gci50aWVyID09PSBVc2VyVGllci5FTlRFUlBSSVNFKS5sZW5ndGgsXG4gICAgICAgIGFkbWluOiBBcnJheS5mcm9tKHRoaXMucmVjb3Jkcy52YWx1ZXMoKSkuZmlsdGVyKHIgPT4gci50aWVyID09PSBVc2VyVGllci5BRE1JTikubGVuZ3RoLFxuICAgICAgfVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRhIGxpbWl0ZXMgZGUgdW0gdXN1w6FyaW8gKGFkbWluKVxuICAgKi9cbiAgc3RhdGljIHJlc2V0VXNlcih1c2VySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMucmVjb3Jkcy5kZWxldGUodXNlcklkKTtcbiAgICBsb2cuaW5mbygnUmF0ZSBsaW1pdCByZXNldGFkbycsIHsgdXNlcklkIH0pO1xuICB9XG59XG5cbi8vIENsZWFudXAgYXV0b23DoXRpY28gYSBjYWRhIGhvcmFcbnNldEludGVydmFsKCgpID0+IHtcbiAgVXNlclJhdGVMaW1pdGVyLmNsZWFudXAoKTtcbn0sIDYwICogNjAgKiAxMDAwKTsiXSwidmVyc2lvbiI6M30=