fccdab7676987cadc8cf238ec54c93f1
"use strict";
// src/infrastructure/metrics/MetricsManager.ts
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.metricsManager = exports.MetricsManager = void 0;
const prom_client_1 = __importDefault(require("prom-client"));
/**
 * Gerenciador central de m√©tricas Prometheus
 * Singleton que gerencia todas as m√©tricas da aplica√ß√£o
 */
class MetricsManager {
    constructor(config) {
        this.isInitialized = false;
        this.registry = new prom_client_1.default.Registry();
        // Labels padr√£o para todas as m√©tricas
        if (config.defaultLabels) {
            this.registry.setDefaultLabels(config.defaultLabels);
        }
        // Prefixo para todas as m√©tricas
        const prefix = config.prefix || 'lor0138_';
        // ========================================
        // üìä HTTP METRICS
        // ========================================
        this.httpRequestsTotal = new prom_client_1.default.Counter({
            name: `${prefix}http_requests_total`,
            help: 'Total de requisi√ß√µes HTTP',
            labelNames: ['method', 'route', 'status_code'],
            registers: [this.registry],
        });
        this.httpRequestDuration = new prom_client_1.default.Histogram({
            name: `${prefix}http_request_duration_seconds`,
            help: 'Dura√ß√£o das requisi√ß√µes HTTP em segundos',
            labelNames: ['method', 'route', 'status_code'],
            buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10],
            registers: [this.registry],
        });
        this.httpRequestsInProgress = new prom_client_1.default.Gauge({
            name: `${prefix}http_requests_in_progress`,
            help: 'N√∫mero de requisi√ß√µes HTTP em andamento',
            labelNames: ['method', 'route'],
            registers: [this.registry],
        });
        // ========================================
        // üóÑÔ∏è DATABASE METRICS
        // ========================================
        this.dbQueriesTotal = new prom_client_1.default.Counter({
            name: `${prefix}db_queries_total`,
            help: 'Total de queries executadas',
            labelNames: ['database', 'operation'],
            registers: [this.registry],
        });
        this.dbQueryDuration = new prom_client_1.default.Histogram({
            name: `${prefix}db_query_duration_seconds`,
            help: 'Dura√ß√£o das queries em segundos',
            labelNames: ['database', 'operation'],
            buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5],
            registers: [this.registry],
        });
        this.dbQueriesInProgress = new prom_client_1.default.Gauge({
            name: `${prefix}db_queries_in_progress`,
            help: 'N√∫mero de queries em andamento',
            labelNames: ['database'],
            registers: [this.registry],
        });
        this.dbQueryErrors = new prom_client_1.default.Counter({
            name: `${prefix}db_query_errors_total`,
            help: 'Total de erros em queries',
            labelNames: ['database', 'error_type'],
            registers: [this.registry],
        });
        this.dbConnectionsActive = new prom_client_1.default.Gauge({
            name: `${prefix}db_connections_active`,
            help: 'N√∫mero de conex√µes ativas com o banco',
            labelNames: ['database'],
            registers: [this.registry],
        });
        this.dbConnectionErrors = new prom_client_1.default.Counter({
            name: `${prefix}db_connection_errors_total`,
            help: 'Total de erros de conex√£o',
            labelNames: ['database', 'error_type'],
            registers: [this.registry],
        });
        // ========================================
        // üîí RATE LIMIT METRICS
        // ========================================
        this.rateLimitRequestsBlocked = new prom_client_1.default.Counter({
            name: `${prefix}rate_limit_requests_blocked_total`,
            help: 'Total de requisi√ß√µes bloqueadas por rate limit',
            labelNames: ['route', 'user_id', 'reason'],
            registers: [this.registry],
        });
        this.rateLimitRequestsAllowed = new prom_client_1.default.Counter({
            name: `${prefix}rate_limit_requests_allowed_total`,
            help: 'Total de requisi√ß√µes permitidas',
            labelNames: ['route', 'user_id'],
            registers: [this.registry],
        });
        // ========================================
        // ‚öïÔ∏è HEALTH METRICS
        // ========================================
        this.healthCheckStatus = new prom_client_1.default.Gauge({
            name: `${prefix}health_check_status`,
            help: 'Status do health check (1 = healthy, 0 = unhealthy)',
            labelNames: ['component'],
            registers: [this.registry],
        });
        this.healthCheckDuration = new prom_client_1.default.Histogram({
            name: `${prefix}health_check_duration_seconds`,
            help: 'Dura√ß√£o do health check em segundos',
            labelNames: ['component'],
            buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1],
            registers: [this.registry],
        });
        // ========================================
        // üíª SYSTEM METRICS (Node.js default)
        // ========================================
        if (config.collectDefaultMetrics !== false) {
            prom_client_1.default.collectDefaultMetrics({
                register: this.registry,
                prefix,
            });
        }
        this.isInitialized = true;
        console.log('‚úÖ MetricsManager inicializado');
    }
    /**
     * Retorna inst√¢ncia singleton
     */
    static getInstance(config) {
        if (!this.instance) {
            const defaultConfig = {
                enabled: true,
                collectDefaultMetrics: true,
                prefix: 'lor0138_',
                defaultLabels: {
                    app: 'lor0138',
                    environment: process.env.NODE_ENV || 'development',
                    version: process.env.npm_package_version || '1.0.0',
                },
            };
            this.instance = new MetricsManager({ ...defaultConfig, ...config });
        }
        return this.instance;
    }
    /**
     * Retorna as m√©tricas no formato Prometheus
     */
    async getMetrics() {
        return this.registry.metrics();
    }
    /**
     * Retorna o registro para uso externo
     */
    getRegistry() {
        return this.registry;
    }
    /**
     * Reseta todas as m√©tricas (√∫til para testes)
     */
    reset() {
        this.registry.resetMetrics();
    }
    /**
     * Verifica se est√° inicializado
     */
    isReady() {
        return this.isInitialized;
    }
    /**
     * Registra m√©trica customizada
     */
    registerCustomMetric(metric) {
        this.registry.registerMetric(metric);
    }
}
exports.MetricsManager = MetricsManager;
MetricsManager.instance = null;
// Export singleton instance
exports.metricsManager = MetricsManager.getInstance();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL2luZnJhc3RydWN0dXJlL21ldHJpY3MvTWV0cmljc01hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLCtDQUErQzs7Ozs7O0FBRS9DLDhEQUFpQztBQUdqQzs7O0dBR0c7QUFDSCxNQUFhLGNBQWM7SUEwQnpCLFlBQW9CLE1BQXFCO1FBdkJqQyxrQkFBYSxHQUFZLEtBQUssQ0FBQztRQXdCckMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLHFCQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFdEMsdUNBQXVDO1FBQ3ZDLElBQUksTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFFRCxpQ0FBaUM7UUFDakMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sSUFBSSxVQUFVLENBQUM7UUFFM0MsMkNBQTJDO1FBQzNDLGtCQUFrQjtRQUNsQiwyQ0FBMkM7UUFDM0MsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUkscUJBQU0sQ0FBQyxPQUFPLENBQUM7WUFDMUMsSUFBSSxFQUFFLEdBQUcsTUFBTSxxQkFBcUI7WUFDcEMsSUFBSSxFQUFFLDJCQUEyQjtZQUNqQyxVQUFVLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQztZQUM5QyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1NBQzNCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLHFCQUFNLENBQUMsU0FBUyxDQUFDO1lBQzlDLElBQUksRUFBRSxHQUFHLE1BQU0sK0JBQStCO1lBQzlDLElBQUksRUFBRSwwQ0FBMEM7WUFDaEQsVUFBVSxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUM7WUFDOUMsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFF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QVEsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPO1FBQ0wsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRztJQUNILG9CQUFvQixDQUFDLE1BQXFCO1FBQ3hDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7O0FBcE5ILHdDQXFOQztBQXBOZ0IsdUJBQVEsR0FBMEIsSUFBSSxBQUE5QixDQUErQjtBQXNOeEQsNEJBQTRCO0FBQ2YsUUFBQSxjQUFjLEdBQUcsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL21hbm8vcHJvamV0b3MvZGF0YXN1bC9sb3IwMTM4L3NyYy9pbmZyYXN0cnVjdHVyZS9tZXRyaWNzL01ldHJpY3NNYW5hZ2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9pbmZyYXN0cnVjdHVyZS9tZXRyaWNzL01ldHJpY3NNYW5hZ2VyLnRzXG5cbmltcG9ydCBjbGllbnQgZnJvbSAncHJvbS1jbGllbnQnO1xuaW1wb3J0IHsgTWV0cmljc0NvbmZpZyB9IGZyb20gJ0BzaGFyZWQvdHlwZXMvbWV0cmljcy50eXBlcyc7XG5cbi8qKlxuICogR2VyZW5jaWFkb3IgY2VudHJhbCBkZSBtw6l0cmljYXMgUHJvbWV0aGV1c1xuICogU2luZ2xldG9uIHF1ZSBnZXJlbmNpYSB0b2RhcyBhcyBtw6l0cmljYXMgZGEgYXBsaWNhw6fDo29cbiAqL1xuZXhwb3J0IGNsYXNzIE1ldHJpY3NNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IE1ldHJpY3NNYW5hZ2VyIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgcmVnaXN0cnk6IGNsaWVudC5SZWdpc3RyeTtcbiAgcHJpdmF0ZSBpc0luaXRpYWxpemVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLy8g8J+TiiBIVFRQIE1ldHJpY3NcbiAgcHVibGljIGh0dHBSZXF1ZXN0c1RvdGFsOiBjbGllbnQuQ291bnRlcjxzdHJpbmc+O1xuICBwdWJsaWMgaHR0cFJlcXVlc3REdXJhdGlvbjogY2xpZW50Lkhpc3RvZ3JhbTxzdHJpbmc+O1xuICBwdWJsaWMgaHR0cFJlcXVlc3RzSW5Qcm9ncmVzczogY2xpZW50LkdhdWdlPHN0cmluZz47XG5cbiAgLy8g8J+XhO+4jyBEYXRhYmFzZSBNZXRyaWNzXG4gIHB1YmxpYyBkYlF1ZXJpZXNUb3RhbDogY2xpZW50LkNvdW50ZXI8c3RyaW5nPjtcbiAgcHVibGljIGRiUXVlcnlEdXJhdGlvbjogY2xpZW50Lkhpc3RvZ3JhbTxzdHJpbmc+O1xuICBwdWJsaWMgZGJRdWVyaWVzSW5Qcm9ncmVzczogY2xpZW50LkdhdWdlPHN0cmluZz47XG4gIHB1YmxpYyBkYlF1ZXJ5RXJyb3JzOiBjbGllbnQuQ291bnRlcjxzdHJpbmc+O1xuICBwdWJsaWMgZGJDb25uZWN0aW9uc0FjdGl2ZTogY2xpZW50LkdhdWdlPHN0cmluZz47XG4gIHB1YmxpYyBkYkNvbm5lY3Rpb25FcnJvcnM6IGNsaWVudC5Db3VudGVyPHN0cmluZz47XG5cbiAgLy8g8J+UkiBSYXRlIExpbWl0IE1ldHJpY3NcbiAgcHVibGljIHJhdGVMaW1pdFJlcXVlc3RzQmxvY2tlZDogY2xpZW50LkNvdW50ZXI8c3RyaW5nPjtcbiAgcHVibGljIHJhdGVMaW1pdFJlcXVlc3RzQWxsb3dlZDogY2xpZW50LkNvdW50ZXI8c3RyaW5nPjtcblxuICAvLyDimpXvuI8gSGVhbHRoIE1ldHJpY3NcbiAgcHVibGljIGhlYWx0aENoZWNrU3RhdHVzOiBjbGllbnQuR2F1Z2U8c3RyaW5nPjtcbiAgcHVibGljIGhlYWx0aENoZWNrRHVyYXRpb246IGNsaWVudC5IaXN0b2dyYW08c3RyaW5nPjtcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKGNvbmZpZzogTWV0cmljc0NvbmZpZykge1xuICAgIHRoaXMucmVnaXN0cnkgPSBuZXcgY2xpZW50LlJlZ2lzdHJ5KCk7XG5cbiAgICAvLyBMYWJlbHMgcGFkcsOjbyBwYXJhIHRvZGFzIGFzIG3DqXRyaWNhc1xuICAgIGlmIChjb25maWcuZGVmYXVsdExhYmVscykge1xuICAgICAgdGhpcy5yZWdpc3RyeS5zZXREZWZhdWx0TGFiZWxzKGNvbmZpZy5kZWZhdWx0TGFiZWxzKTtcbiAgICB9XG5cbiAgICAvLyBQcmVmaXhvIHBhcmEgdG9kYXMgYXMgbcOpdHJpY2FzXG4gICAgY29uc3QgcHJlZml4ID0gY29uZmlnLnByZWZpeCB8fCAnbG9yMDEzOF8nO1xuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIPCfk4ogSFRUUCBNRVRSSUNTXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIHRoaXMuaHR0cFJlcXVlc3RzVG90YWwgPSBuZXcgY2xpZW50LkNvdW50ZXIoe1xuICAgICAgbmFtZTogYCR7cHJlZml4fWh0dHBfcmVxdWVzdHNfdG90YWxgLFxuICAgICAgaGVscDogJ1RvdGFsIGRlIHJlcXVpc2nDp8O1ZXMgSFRUUCcsXG4gICAgICBsYWJlbE5hbWVzOiBbJ21ldGhvZCcsICdyb3V0ZScsICdzdGF0dXNfY29kZSddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmh0dHBSZXF1ZXN0RHVyYXRpb24gPSBuZXcgY2xpZW50Lkhpc3RvZ3JhbSh7XG4gICAgICBuYW1lOiBgJHtwcmVmaXh9aHR0cF9yZXF1ZXN0X2R1cmF0aW9uX3NlY29uZHNgLFxuICAgICAgaGVscDogJ0R1cmHDp8OjbyBkYXMgcmVxdWlzacOnw7VlcyBIVFRQIGVtIHNlZ3VuZG9zJyxcbiAgICAgIGxhYmVsTmFtZXM6IFsnbWV0aG9kJywgJ3JvdXRlJywgJ3N0YXR1c19jb2RlJ10sXG4gICAgICBidWNrZXRzOiBbMC4wMDUsIDAuMDEsIDAuMDI1LCAwLjA1LCAwLjEsIDAuMjUsIDAuNSwgMSwgMi41LCA1LCAxMF0sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIHRoaXMuaHR0cFJlcXVlc3RzSW5Qcm9ncmVzcyA9IG5ldyBjbGllbnQuR2F1Z2Uoe1xuICAgICAgbmFtZTogYCR7cHJlZml4fWh0dHBfcmVxdWVzdHNfaW5fcHJvZ3Jlc3NgLFxuICAgICAgaGVscDogJ07Dum1lcm8gZGUgcmVxdWlzacOnw7VlcyBIVFRQIGVtIGFuZGFtZW50bycsXG4gICAgICBsYWJlbE5hbWVzOiBbJ21ldGhvZCcsICdyb3V0ZSddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8g8J+XhO+4jyBEQVRBQkFTRSBNRVRSSUNTXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIHRoaXMuZGJRdWVyaWVzVG90YWwgPSBuZXcgY2xpZW50LkNvdW50ZXIoe1xuICAgICAgbmFtZTogYCR7cHJlZml4fWRiX3F1ZXJpZXNfdG90YWxgLFxuICAgICAgaGVscDogJ1RvdGFsIGRlIHF1ZXJpZXMgZXhlY3V0YWRhcycsXG4gICAgICBsYWJlbE5hbWVzOiBbJ2RhdGFiYXNlJywgJ29wZXJhdGlvbiddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmRiUXVlcnlEdXJhdGlvbiA9IG5ldyBjbGllbnQuSGlzdG9ncmFtKHtcbiAgICAgIG5hbWU6IGAke3ByZWZpeH1kYl9xdWVyeV9kdXJhdGlvbl9zZWNvbmRzYCxcbiAgICAgIGhlbHA6ICdEdXJhw6fDo28gZGFzIHF1ZXJpZXMgZW0gc2VndW5kb3MnLFxuICAgICAgbGFiZWxOYW1lczogWydkYXRhYmFzZScsICdvcGVyYXRpb24nXSxcbiAgICAgIGJ1Y2tldHM6IFswLjAwMSwgMC4wMDUsIDAuMDEsIDAuMDI1LCAwLjA1LCAwLjEsIDAuMjUsIDAuNSwgMSwgMi41LCA1XSxcbiAgICAgIHJlZ2lzdGVyczogW3RoaXMucmVnaXN0cnldLFxuICAgIH0pO1xuXG4gICAgdGhpcy5kYlF1ZXJpZXNJblByb2dyZXNzID0gbmV3IGNsaWVudC5HYXVnZSh7XG4gICAgICBuYW1lOiBgJHtwcmVmaXh9ZGJfcXVlcmllc19pbl9wcm9ncmVzc2AsXG4gICAgICBoZWxwOiAnTsO6bWVybyBkZSBxdWVyaWVzIGVtIGFuZGFtZW50bycsXG4gICAgICBsYWJlbE5hbWVzOiBbJ2RhdGFiYXNlJ10sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIHRoaXMuZGJRdWVyeUVycm9ycyA9IG5ldyBjbGllbnQuQ291bnRlcih7XG4gICAgICBuYW1lOiBgJHtwcmVmaXh9ZGJfcXVlcnlfZXJyb3JzX3RvdGFsYCxcbiAgICAgIGhlbHA6ICdUb3RhbCBkZSBlcnJvcyBlbSBxdWVyaWVzJyxcbiAgICAgIGxhYmVsTmFtZXM6IFsnZGF0YWJhc2UnLCAnZXJyb3JfdHlwZSddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmRiQ29ubmVjdGlvbnNBY3RpdmUgPSBuZXcgY2xpZW50LkdhdWdlKHtcbiAgICAgIG5hbWU6IGAke3ByZWZpeH1kYl9jb25uZWN0aW9uc19hY3RpdmVgLFxuICAgICAgaGVscDogJ07Dum1lcm8gZGUgY29uZXjDtWVzIGF0aXZhcyBjb20gbyBiYW5jbycsXG4gICAgICBsYWJlbE5hbWVzOiBbJ2RhdGFiYXNlJ10sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIHRoaXMuZGJDb25uZWN0aW9uRXJyb3JzID0gbmV3IGNsaWVudC5Db3VudGVyKHtcbiAgICAgIG5hbWU6IGAke3ByZWZpeH1kYl9jb25uZWN0aW9uX2Vycm9yc190b3RhbGAsXG4gICAgICBoZWxwOiAnVG90YWwgZGUgZXJyb3MgZGUgY29uZXjDo28nLFxuICAgICAgbGFiZWxOYW1lczogWydkYXRhYmFzZScsICdlcnJvcl90eXBlJ10sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyDwn5SSIFJBVEUgTElNSVQgTUVUUklDU1xuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICB0aGlzLnJhdGVMaW1pdFJlcXVlc3RzQmxvY2tlZCA9IG5ldyBjbGllbnQuQ291bnRlcih7XG4gICAgICBuYW1lOiBgJHtwcmVmaXh9cmF0ZV9saW1pdF9yZXF1ZXN0c19ibG9ja2VkX3RvdGFsYCxcbiAgICAgIGhlbHA6ICdUb3RhbCBkZSByZXF1aXNpw6fDtWVzIGJsb3F1ZWFkYXMgcG9yIHJhdGUgbGltaXQnLFxuICAgICAgbGFiZWxOYW1lczogWydyb3V0ZScsICd1c2VyX2lkJywgJ3JlYXNvbiddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLnJhdGVMaW1pdFJlcXVlc3RzQWxsb3dlZCA9IG5ldyBjbGllbnQuQ291bnRlcih7XG4gICAgICBuYW1lOiBgJHtwcmVmaXh9cmF0ZV9saW1pdF9yZXF1ZXN0c19hbGxvd2VkX3RvdGFsYCxcbiAgICAgIGhlbHA6ICdUb3RhbCBkZSByZXF1aXNpw6fDtWVzIHBlcm1pdGlkYXMnLFxuICAgICAgbGFiZWxOYW1lczogWydyb3V0ZScsICd1c2VyX2lkJ10sXG4gICAgICByZWdpc3RlcnM6IFt0aGlzLnJlZ2lzdHJ5XSxcbiAgICB9KTtcblxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyDimpXvuI8gSEVBTFRIIE1FVFJJQ1NcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgdGhpcy5oZWFsdGhDaGVja1N0YXR1cyA9IG5ldyBjbGllbnQuR2F1Z2Uoe1xuICAgICAgbmFtZTogYCR7cHJlZml4fWhlYWx0aF9jaGVja19zdGF0dXNgLFxuICAgICAgaGVscDogJ1N0YXR1cyBkbyBoZWFsdGggY2hlY2sgKDEgPSBoZWFsdGh5LCAwID0gdW5oZWFsdGh5KScsXG4gICAgICBsYWJlbE5hbWVzOiBbJ2NvbXBvbmVudCddLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmhlYWx0aENoZWNrRHVyYXRpb24gPSBuZXcgY2xpZW50Lkhpc3RvZ3JhbSh7XG4gICAgICBuYW1lOiBgJHtwcmVmaXh9aGVhbHRoX2NoZWNrX2R1cmF0aW9uX3NlY29uZHNgLFxuICAgICAgaGVscDogJ0R1cmHDp8OjbyBkbyBoZWFsdGggY2hlY2sgZW0gc2VndW5kb3MnLFxuICAgICAgbGFiZWxOYW1lczogWydjb21wb25lbnQnXSxcbiAgICAgIGJ1Y2tldHM6IFswLjAwMSwgMC4wMDUsIDAuMDEsIDAuMDI1LCAwLjA1LCAwLjFdLFxuICAgICAgcmVnaXN0ZXJzOiBbdGhpcy5yZWdpc3RyeV0sXG4gICAgfSk7XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8g8J+SuyBTWVNURU0gTUVUUklDUyAoTm9kZS5qcyBkZWZhdWx0KVxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICBpZiAoY29uZmlnLmNvbGxlY3REZWZhdWx0TWV0cmljcyAhPT0gZmFsc2UpIHtcbiAgICAgIGNsaWVudC5jb2xsZWN0RGVmYXVsdE1ldHJpY3Moe1xuICAgICAgICByZWdpc3RlcjogdGhpcy5yZWdpc3RyeSxcbiAgICAgICAgcHJlZml4LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICBjb25zb2xlLmxvZygn4pyFIE1ldHJpY3NNYW5hZ2VyIGluaWNpYWxpemFkbycpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgaW5zdMOibmNpYSBzaW5nbGV0b25cbiAgICovXG4gIHN0YXRpYyBnZXRJbnN0YW5jZShjb25maWc/OiBNZXRyaWNzQ29uZmlnKTogTWV0cmljc01hbmFnZXIge1xuICAgIGlmICghdGhpcy5pbnN0YW5jZSkge1xuICAgICAgY29uc3QgZGVmYXVsdENvbmZpZzogTWV0cmljc0NvbmZpZyA9IHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgY29sbGVjdERlZmF1bHRNZXRyaWNzOiB0cnVlLFxuICAgICAgICBwcmVmaXg6ICdsb3IwMTM4XycsXG4gICAgICAgIGRlZmF1bHRMYWJlbHM6IHtcbiAgICAgICAgICBhcHA6ICdsb3IwMTM4JyxcbiAgICAgICAgICBlbnZpcm9ubWVudDogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgJ2RldmVsb3BtZW50JyxcbiAgICAgICAgICB2ZXJzaW9uOiBwcm9jZXNzLmVudi5ucG1fcGFja2FnZV92ZXJzaW9uIHx8ICcxLjAuMCcsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICB0aGlzLmluc3RhbmNlID0gbmV3IE1ldHJpY3NNYW5hZ2VyKHsgLi4uZGVmYXVsdENvbmZpZywgLi4uY29uZmlnIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgYXMgbcOpdHJpY2FzIG5vIGZvcm1hdG8gUHJvbWV0aGV1c1xuICAgKi9cbiAgYXN5bmMgZ2V0TWV0cmljcygpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5Lm1ldHJpY3MoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIG8gcmVnaXN0cm8gcGFyYSB1c28gZXh0ZXJub1xuICAgKi9cbiAgZ2V0UmVnaXN0cnkoKTogY2xpZW50LlJlZ2lzdHJ5IHtcbiAgICByZXR1cm4gdGhpcy5yZWdpc3RyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldGEgdG9kYXMgYXMgbcOpdHJpY2FzICjDunRpbCBwYXJhIHRlc3RlcylcbiAgICovXG4gIHJlc2V0KCk6IHZvaWQge1xuICAgIHRoaXMucmVnaXN0cnkucmVzZXRNZXRyaWNzKCk7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZpY2Egc2UgZXN0w6EgaW5pY2lhbGl6YWRvXG4gICAqL1xuICBpc1JlYWR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzSW5pdGlhbGl6ZWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0cmEgbcOpdHJpY2EgY3VzdG9taXphZGFcbiAgICovXG4gIHJlZ2lzdGVyQ3VzdG9tTWV0cmljKG1ldHJpYzogY2xpZW50Lk1ldHJpYyk6IHZvaWQge1xuICAgIHRoaXMucmVnaXN0cnkucmVnaXN0ZXJNZXRyaWMobWV0cmljKTtcbiAgfVxufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXG5leHBvcnQgY29uc3QgbWV0cmljc01hbmFnZXIgPSBNZXRyaWNzTWFuYWdlci5nZXRJbnN0YW5jZSgpOyJdLCJ2ZXJzaW9uIjozfQ==