2fa2f96bbf8e51ae3c97e98149edbd4a
"use strict";
// src/shared/middlewares/userRateLimit.middleware.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.userRateLimit = userRateLimit;
exports.createUserRateLimit = createUserRateLimit;
const UserRateLimiter_1 = require("@shared/utils/UserRateLimiter");
const errors_1 = require("@shared/errors");
const logger_1 = require("@shared/utils/logger");
/**
 * Middleware de rate limiting por usuário
 * Requer que apiKeyAuth middleware seja executado antes
 */
function userRateLimit(req, res, next) {
    try {
        // Se não há usuário autenticado, aplica rate limit genérico por IP
        if (!req.user) {
            logger_1.log.debug('Rate limit por IP (sem autenticação)', {
                correlationId: req.id,
                ip: req.ip
            });
            // Fallback para rate limit genérico
            return next();
        }
        const { id: userId, tier } = req.user;
        // Verifica rate limit
        const result = UserRateLimiter_1.UserRateLimiter.check(userId, tier);
        // Adiciona headers de rate limit
        res.setHeader('X-RateLimit-Limit', result.limit.toString());
        res.setHeader('X-RateLimit-Remaining', result.remaining.toString());
        res.setHeader('X-RateLimit-Reset', new Date(result.resetAt).toISOString());
        if (!result.allowed) {
            // Rate limit excedido
            logger_1.log.warn('Rate limit por usuário excedido', {
                correlationId: req.id,
                userId,
                tier,
                limit: result.limit,
                resetAt: new Date(result.resetAt)
            });
            // Adiciona header Retry-After
            if (result.retryAfter) {
                res.setHeader('Retry-After', result.retryAfter.toString());
            }
            throw new errors_1.RateLimitError(result.retryAfter);
        }
        logger_1.log.debug('Rate limit OK', {
            correlationId: req.id,
            userId,
            tier,
            remaining: result.remaining,
            limit: result.limit
        });
        next();
    }
    catch (error) {
        next(error);
    }
}
/**
 * Cria middleware de rate limit customizado para endpoints específicos
 */
function createUserRateLimit(options) {
    return (req, res, next) => {
        try {
            // Se configurado para pular autenticados e usuário está autenticado
            if (options?.skipAuthenticated && req.user) {
                return next();
            }
            if (!req.user) {
                return next();
            }
            const { id: userId, tier } = req.user;
            const result = UserRateLimiter_1.UserRateLimiter.check(userId, tier);
            // Aplica multiplicador se configurado
            const limit = options?.multiplier
                ? result.limit * options.multiplier
                : result.limit;
            res.setHeader('X-RateLimit-Limit', limit.toString());
            res.setHeader('X-RateLimit-Remaining', result.remaining.toString());
            res.setHeader('X-RateLimit-Reset', new Date(result.resetAt).toISOString());
            if (!result.allowed) {
                if (result.retryAfter) {
                    res.setHeader('Retry-After', result.retryAfter.toString());
                }
                throw new errors_1.RateLimitError(result.retryAfter);
            }
            next();
        }
        catch (error) {
            next(error);
        }
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC9taWRkbGV3YXJlcy91c2VyUmF0ZUxpbWl0Lm1pZGRsZXdhcmUudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7QUFZckQsc0NBd0RDO0FBS0Qsa0RBd0NDO0FBOUdELG1FQUFnRTtBQUNoRSwyQ0FBZ0Q7QUFFaEQsaURBQTJDO0FBRTNDOzs7R0FHRztBQUNILFNBQWdCLGFBQWEsQ0FDM0IsR0FBWSxFQUNaLEdBQWEsRUFDYixJQUFrQjtJQUVsQixJQUFJLENBQUM7UUFDSCxtRUFBbUU7UUFDbkUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLFlBQUcsQ0FBQyxLQUFLLENBQUMsc0NBQXNDLEVBQUU7Z0JBQ2hELGFBQWEsRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDckIsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO2FBQ1gsQ0FBQyxDQUFDO1lBQ0gsb0NBQW9DO1lBQ3BDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDaEIsQ0FBQztRQUVELE1BQU0sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFdEMsc0JBQXNCO1FBQ3RCLE1BQU0sTUFBTSxHQUFHLGlDQUFlLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVuRCxpQ0FBaUM7UUFDakMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDNUQsR0FBRyxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDcEUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztR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QUUsQ0FBQztZQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL21hbm8vcHJvamV0b3MvZGF0YXN1bC9sb3IwMTM4L3NyYy9zaGFyZWQvbWlkZGxld2FyZXMvdXNlclJhdGVMaW1pdC5taWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9zaGFyZWQvbWlkZGxld2FyZXMvdXNlclJhdGVMaW1pdC5taWRkbGV3YXJlLnRzXG5cbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFVzZXJSYXRlTGltaXRlciB9IGZyb20gJ0BzaGFyZWQvdXRpbHMvVXNlclJhdGVMaW1pdGVyJztcbmltcG9ydCB7IFJhdGVMaW1pdEVycm9yIH0gZnJvbSAnQHNoYXJlZC9lcnJvcnMnO1xuaW1wb3J0IHsgVXNlclRpZXIgfSBmcm9tICdAc2hhcmVkL3R5cGVzL2FwaUtleS50eXBlcyc7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICdAc2hhcmVkL3V0aWxzL2xvZ2dlcic7XG5cbi8qKlxuICogTWlkZGxld2FyZSBkZSByYXRlIGxpbWl0aW5nIHBvciB1c3XDoXJpb1xuICogUmVxdWVyIHF1ZSBhcGlLZXlBdXRoIG1pZGRsZXdhcmUgc2VqYSBleGVjdXRhZG8gYW50ZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVzZXJSYXRlTGltaXQoXG4gIHJlcTogUmVxdWVzdCxcbiAgcmVzOiBSZXNwb25zZSxcbiAgbmV4dDogTmV4dEZ1bmN0aW9uXG4pOiB2b2lkIHtcbiAgdHJ5IHtcbiAgICAvLyBTZSBuw6NvIGjDoSB1c3XDoXJpbyBhdXRlbnRpY2FkbywgYXBsaWNhIHJhdGUgbGltaXQgZ2Vuw6lyaWNvIHBvciBJUFxuICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgIGxvZy5kZWJ1ZygnUmF0ZSBsaW1pdCBwb3IgSVAgKHNlbSBhdXRlbnRpY2HDp8OjbyknLCB7XG4gICAgICAgIGNvcnJlbGF0aW9uSWQ6IHJlcS5pZCxcbiAgICAgICAgaXA6IHJlcS5pcFxuICAgICAgfSk7XG4gICAgICAvLyBGYWxsYmFjayBwYXJhIHJhdGUgbGltaXQgZ2Vuw6lyaWNvXG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgaWQ6IHVzZXJJZCwgdGllciB9ID0gcmVxLnVzZXI7XG5cbiAgICAvLyBWZXJpZmljYSByYXRlIGxpbWl0XG4gICAgY29uc3QgcmVzdWx0ID0gVXNlclJhdGVMaW1pdGVyLmNoZWNrKHVzZXJJZCwgdGllcik7XG5cbiAgICAvLyBBZGljaW9uYSBoZWFkZXJzIGRlIHJhdGUgbGltaXRcbiAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1MaW1pdCcsIHJlc3VsdC5saW1pdC50b1N0cmluZygpKTtcbiAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZW1haW5pbmcnLCByZXN1bHQucmVtYWluaW5nLnRvU3RyaW5nKCkpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlc2V0JywgbmV3IERhdGUocmVzdWx0LnJlc2V0QXQpLnRvSVNPU3RyaW5nKCkpO1xuXG4gICAgaWYgKCFyZXN1bHQuYWxsb3dlZCkge1xuICAgICAgLy8gUmF0ZSBsaW1pdCBleGNlZGlkb1xuICAgICAgbG9nLndhcm4oJ1JhdGUgbGltaXQgcG9yIHVzdcOhcmlvIGV4Y2VkaWRvJywge1xuICAgICAgICBjb3JyZWxhdGlvbklkOiByZXEuaWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgdGllcixcbiAgICAgICAgbGltaXQ6IHJlc3VsdC5saW1pdCxcbiAgICAgICAgcmVzZXRBdDogbmV3IERhdGUocmVzdWx0LnJlc2V0QXQpXG4gICAgICB9KTtcblxuICAgICAgLy8gQWRpY2lvbmEgaGVhZGVyIFJldHJ5LUFmdGVyXG4gICAgICBpZiAocmVzdWx0LnJldHJ5QWZ0ZXIpIHtcbiAgICAgICAgcmVzLnNldEhlYWRlcignUmV0cnktQWZ0ZXInLCByZXN1bHQucmV0cnlBZnRlci50b1N0cmluZygpKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IFJhdGVMaW1pdEVycm9yKHJlc3VsdC5yZXRyeUFmdGVyKTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoJ1JhdGUgbGltaXQgT0snLCB7XG4gICAgICBjb3JyZWxhdGlvbklkOiByZXEuaWQsXG4gICAgICB1c2VySWQsXG4gICAgICB0aWVyLFxuICAgICAgcmVtYWluaW5nOiByZXN1bHQucmVtYWluaW5nLFxuICAgICAgbGltaXQ6IHJlc3VsdC5saW1pdFxuICAgIH0pO1xuXG4gICAgbmV4dCgpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIG5leHQoZXJyb3IpO1xuICB9XG59XG5cbi8qKlxuICogQ3JpYSBtaWRkbGV3YXJlIGRlIHJhdGUgbGltaXQgY3VzdG9taXphZG8gcGFyYSBlbmRwb2ludHMgZXNwZWPDrWZpY29zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVVc2VyUmF0ZUxpbWl0KG9wdGlvbnM/OiB7XG4gIHNraXBBdXRoZW50aWNhdGVkPzogYm9vbGVhbjsgLy8gUHVsYSByYXRlIGxpbWl0IHNlIGF1dGVudGljYWRvXG4gIG11bHRpcGxpZXI/OiBudW1iZXI7IC8vIE11bHRpcGxpY2Egb3MgbGltaXRlcyBwYWRyw6NvXG59KTogKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB2b2lkIHtcbiAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBTZSBjb25maWd1cmFkbyBwYXJhIHB1bGFyIGF1dGVudGljYWRvcyBlIHVzdcOhcmlvIGVzdMOhIGF1dGVudGljYWRvXG4gICAgICBpZiAob3B0aW9ucz8uc2tpcEF1dGhlbnRpY2F0ZWQgJiYgcmVxLnVzZXIpIHtcbiAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFyZXEudXNlcikge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7IGlkOiB1c2VySWQsIHRpZXIgfSA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgcmVzdWx0ID0gVXNlclJhdGVMaW1pdGVyLmNoZWNrKHVzZXJJZCwgdGllcik7XG5cbiAgICAgIC8vIEFwbGljYSBtdWx0aXBsaWNhZG9yIHNlIGNvbmZpZ3VyYWRvXG4gICAgICBjb25zdCBsaW1pdCA9IG9wdGlvbnM/Lm11bHRpcGxpZXIgXG4gICAgICAgID8gcmVzdWx0LmxpbWl0ICogb3B0aW9ucy5tdWx0aXBsaWVyIFxuICAgICAgICA6IHJlc3VsdC5saW1pdDtcblxuICAgICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtTGltaXQnLCBsaW1pdC50b1N0cmluZygpKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlbWFpbmluZycsIHJlc3VsdC5yZW1haW5pbmcudG9TdHJpbmcoKSk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIG5ldyBEYXRlKHJlc3VsdC5yZXNldEF0KS50b0lTT1N0cmluZygpKTtcblxuICAgICAgaWYgKCFyZXN1bHQuYWxsb3dlZCkge1xuICAgICAgICBpZiAocmVzdWx0LnJldHJ5QWZ0ZXIpIHtcbiAgICAgICAgICByZXMuc2V0SGVhZGVyKCdSZXRyeS1BZnRlcicsIHJlc3VsdC5yZXRyeUFmdGVyLnRvU3RyaW5nKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IFJhdGVMaW1pdEVycm9yKHJlc3VsdC5yZXRyeUFmdGVyKTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBuZXh0KGVycm9yKTtcbiAgICB9XG4gIH07XG59Il0sInZlcnNpb24iOjN9