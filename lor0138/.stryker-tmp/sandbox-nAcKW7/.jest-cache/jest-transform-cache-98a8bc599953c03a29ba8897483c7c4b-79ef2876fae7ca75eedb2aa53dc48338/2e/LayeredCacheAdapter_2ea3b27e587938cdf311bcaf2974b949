0e37866da39d2be8ea5eeb6b2533040d
"use strict";
// src/shared/utils/cache/LayeredCacheAdapter.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.LayeredCacheAdapter = void 0;
const logger_1 = require("../logger");
/**
 * Adaptador de cache em camadas (L1 + L2)
 *
 * Estrat√©gia:
 * 1. GET: Busca L1 ‚Üí L2 ‚Üí Banco (promove L2‚ÜíL1 em hit)
 * 2. SET: Armazena L1 + L2 simultaneamente
 * 3. DELETE: Remove de L1 + L2
 *
 * Benef√≠cios:
 * - Performance m√°xima (L1 mem√≥ria)
 * - Compartilhamento entre servidores (L2 Redis)
 * - Redund√¢ncia (fallback L1‚ÜîL2)
 */
class LayeredCacheAdapter {
    constructor(l1, l2, name = 'Layered') {
        // Estat√≠sticas
        this.stats = {
            l1Hits: 0,
            l1Misses: 0,
            l2Hits: 0,
            l2Misses: 0,
            totalHits: 0,
            totalMisses: 0
        };
        this.l1 = l1;
        this.l2 = l2;
        this.name = name;
        logger_1.log.info(`${this.name} cache inicializado (L1 + L2)`);
    }
    async get(key) {
        try {
            // 1Ô∏è‚É£ Tenta L1 (mem√≥ria)
            const l1Value = await this.l1.get(key);
            if (l1Value !== undefined) {
                this.stats.l1Hits++;
                this.stats.totalHits++;
                logger_1.log.debug(`${this.name} L1 HIT`, { key });
                return l1Value;
            }
            this.stats.l1Misses++;
            // 2Ô∏è‚É£ Tenta L2 (Redis)
            const l2Value = await this.l2.get(key);
            if (l2Value !== undefined) {
                this.stats.l2Hits++;
                this.stats.totalHits++;
                logger_1.log.debug(`${this.name} L2 HIT`, { key });
                // üîº PROMOVE para L1 (pr√≥xima leitura ser√° mais r√°pida)
                await this.l1.set(key, l2Value).catch(err => {
                    logger_1.log.warn(`${this.name} falha ao promover para L1`, { key, error: err });
                });
                return l2Value;
            }
            this.stats.l2Misses++;
            this.stats.totalMisses++;
            logger_1.log.debug(`${this.name} MISS (L1 e L2)`, { key });
            return undefined;
        }
        catch (error) {
            logger_1.log.error(`${this.name} GET error`, { key, error });
            return undefined;
        }
    }
    async set(key, value, ttl) {
        try {
            // Armazena em AMBAS as camadas simultaneamente
            const [l1Success, l2Success] = await Promise.allSettled([
                this.l1.set(key, value, ttl),
                this.l2.set(key, value, ttl)
            ]);
            const l1Ok = l1Success.status === 'fulfilled' && l1Success.value;
            const l2Ok = l2Success.status === 'fulfilled' && l2Success.value;
            if (!l1Ok) {
                logger_1.log.warn(`${this.name} falha L1 SET`, { key });
            }
            if (!l2Ok) {
                logger_1.log.warn(`${this.name} falha L2 SET`, { key });
            }
            logger_1.log.debug(`${this.name} SET`, {
                key,
                ttl,
                l1: l1Ok ? 'OK' : 'FAIL',
                l2: l2Ok ? 'OK' : 'FAIL'
            });
            // Considera sucesso se pelo menos uma camada funcionou
            return l1Ok || l2Ok;
        }
        catch (error) {
            logger_1.log.error(`${this.name} SET error`, { key, error });
            return false;
        }
    }
    async delete(key) {
        try {
            // Remove de AMBAS as camadas
            const [l1Deleted, l2Deleted] = await Promise.allSettled([
                this.l1.delete(key),
                this.l2.delete(key)
            ]);
            const l1Count = l1Deleted.status === 'fulfilled' ? l1Deleted.value : 0;
            const l2Count = l2Deleted.status === 'fulfilled' ? l2Deleted.value : 0;
            const total = l1Count + l2Count;
            logger_1.log.debug(`${this.name} DELETE`, {
                key,
                l1: l1Count,
                l2: l2Count,
                total
            });
            return total;
        }
        catch (error) {
            logger_1.log.error(`${this.name} DELETE error`, { key, error });
            return 0;
        }
    }
    async flush() {
        try {
            // Limpa AMBAS as camadas
            await Promise.allSettled([
                this.l1.flush(),
                this.l2.flush()
            ]);
            logger_1.log.info(`${this.name} FLUSH ALL (L1 + L2)`);
            // Reseta estat√≠sticas
            this.stats = {
                l1Hits: 0,
                l1Misses: 0,
                l2Hits: 0,
                l2Misses: 0,
                totalHits: 0,
                totalMisses: 0
            };
        }
        catch (error) {
            logger_1.log.error(`${this.name} FLUSH error`, { error });
        }
    }
    async keys(pattern) {
        try {
            // Retorna UNI√ÉO de L1 + L2 (sem duplicatas)
            const [l1Keys, l2Keys] = await Promise.allSettled([
                this.l1.keys(pattern),
                this.l2.keys(pattern)
            ]);
            const l1List = l1Keys.status === 'fulfilled' ? l1Keys.value : [];
            const l2List = l2Keys.status === 'fulfilled' ? l2Keys.value : [];
            // Remove duplicatas
            const uniqueKeys = [...new Set([...l1List, ...l2List])];
            logger_1.log.debug(`${this.name} KEYS`, {
                pattern,
                l1: l1List.length,
                l2: l2List.length,
                total: uniqueKeys.length
            });
            return uniqueKeys;
        }
        catch (error) {
            logger_1.log.error(`${this.name} KEYS error`, { pattern, error });
            return [];
        }
    }
    async isReady() {
        try {
            const [l1Ready, l2Ready] = await Promise.all([
                this.l1.isReady(),
                this.l2.isReady()
            ]);
            // Considera pronto se pelo menos L1 estiver OK
            return l1Ready;
        }
        catch (error) {
            logger_1.log.error(`${this.name} isReady error`, { error });
            return false;
        }
    }
    async close() {
        try {
            await Promise.allSettled([
                this.l1.close(),
                this.l2.close()
            ]);
            logger_1.log.info(`${this.name} fechado (L1 + L2)`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} CLOSE error`, { error });
        }
    }
    /**
     * Retorna estat√≠sticas do cache em camadas
     */
    getStats() {
        const l1HitRate = this.stats.l1Hits + this.stats.l1Misses > 0
            ? (this.stats.l1Hits / (this.stats.l1Hits + this.stats.l1Misses)) * 100
            : 0;
        const l2HitRate = this.stats.l2Hits + this.stats.l2Misses > 0
            ? (this.stats.l2Hits / (this.stats.l2Hits + this.stats.l2Misses)) * 100
            : 0;
        const totalHitRate = this.stats.totalHits + this.stats.totalMisses > 0
            ? (this.stats.totalHits / (this.stats.totalHits + this.stats.totalMisses)) * 100
            : 0;
        return {
            l1: {
                hits: this.stats.l1Hits,
                misses: this.stats.l1Misses,
                hitRate: l1HitRate.toFixed(2) + '%'
            },
            l2: {
                hits: this.stats.l2Hits,
                misses: this.stats.l2Misses,
                hitRate: l2HitRate.toFixed(2) + '%'
            },
            total: {
                hits: this.stats.totalHits,
                misses: this.stats.totalMisses,
                hitRate: totalHitRate.toFixed(2) + '%'
            }
        };
    }
    /**
     * Reseta estat√≠sticas
     */
    resetStats() {
        this.stats = {
            l1Hits: 0,
            l1Misses: 0,
            l2Hits: 0,
            l2Misses: 0,
            totalHits: 0,
            totalMisses: 0
        };
        logger_1.log.info(`${this.name} estat√≠sticas resetadas`);
    }
}
exports.LayeredCacheAdapter = LayeredCacheAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC91dGlscy9jYWNoZS9MYXllcmVkQ2FjaGVBZGFwdGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxnREFBZ0Q7OztBQUdoRCxzQ0FBZ0M7QUFFaEM7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0gsTUFBYSxtQkFBbUI7SUFlOUIsWUFBWSxFQUFnQixFQUFFLEVBQWdCLEVBQUUsT0FBZSxTQUFTO1FBVnhFLGVBQWU7UUFDUCxVQUFLLEdBQUc7WUFDZCxNQUFNLEVBQUUsQ0FBQztZQUNULFFBQVEsRUFBRSxDQUFDO1lBQ1gsTUFBTSxFQUFFLENBQUM7WUFDVCxRQUFRLEVBQUUsQ0FBQztZQUNYLFNBQVMsRUFBRSxDQUFDO1lBQ1osV0FBVyxFQUFFLENBQUM7U0FDZixDQUFDO1FBR0EsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLFlBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSwrQkFBK0IsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRCxLQUFLLENBQUMsR0FBRyxDQUFJLEdBQVc7UUFDdEIsSUFBSSxDQUFDO1lBQ0gseUJBQXlCO1lBQ3pCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUksR0FBRyxDQUFDLENBQUM7WUFFMUMsSUFBSSxPQUFPLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ3ZCLFlBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxTQUFTLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUMxQyxPQUFPLE9BQU8sQ0FB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SixDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVO1FBQ1IsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLE1BQU0sRUFBRSxDQUFDO1lBQ1QsUUFBUSxFQUFFLENBQUM7WUFDWCxNQUFNLEVBQUUsQ0FBQztZQUNULFFBQVEsRUFBRSxDQUFDO1lBQ1gsU0FBUyxFQUFFLENBQUM7WUFDWixXQUFXLEVBQUUsQ0FBQztTQUNmLENBQUM7UUFFRixZQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUkseUJBQXlCLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBQ0Y7QUE5UEQsa0RBOFBDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL21hbm8vcHJvamV0b3MvZGF0YXN1bC9sb3IwMTM4L3NyYy9zaGFyZWQvdXRpbHMvY2FjaGUvTGF5ZXJlZENhY2hlQWRhcHRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2hhcmVkL3V0aWxzL2NhY2hlL0xheWVyZWRDYWNoZUFkYXB0ZXIudHNcblxuaW1wb3J0IHsgQ2FjaGVBZGFwdGVyIH0gZnJvbSAnLi9DYWNoZUFkYXB0ZXInO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vbG9nZ2VyJztcblxuLyoqXG4gKiBBZGFwdGFkb3IgZGUgY2FjaGUgZW0gY2FtYWRhcyAoTDEgKyBMMilcbiAqIFxuICogRXN0cmF0w6lnaWE6XG4gKiAxLiBHRVQ6IEJ1c2NhIEwxIOKGkiBMMiDihpIgQmFuY28gKHByb21vdmUgTDLihpJMMSBlbSBoaXQpXG4gKiAyLiBTRVQ6IEFybWF6ZW5hIEwxICsgTDIgc2ltdWx0YW5lYW1lbnRlXG4gKiAzLiBERUxFVEU6IFJlbW92ZSBkZSBMMSArIEwyXG4gKiBcbiAqIEJlbmVmw61jaW9zOlxuICogLSBQZXJmb3JtYW5jZSBtw6F4aW1hIChMMSBtZW3Ds3JpYSlcbiAqIC0gQ29tcGFydGlsaGFtZW50byBlbnRyZSBzZXJ2aWRvcmVzIChMMiBSZWRpcylcbiAqIC0gUmVkdW5kw6JuY2lhIChmYWxsYmFjayBMMeKGlEwyKVxuICovXG5leHBvcnQgY2xhc3MgTGF5ZXJlZENhY2hlQWRhcHRlciBpbXBsZW1lbnRzIENhY2hlQWRhcHRlciB7XG4gIHByaXZhdGUgbDE6IENhY2hlQWRhcHRlcjsgLy8gTWVtw7NyaWEgKHLDoXBpZG8sIGxvY2FsKVxuICBwcml2YXRlIGwyOiBDYWNoZUFkYXB0ZXI7IC8vIFJlZGlzIChjb21wYXJ0aWxoYWRvLCBwZXJzaXN0ZW50ZSlcbiAgcHJpdmF0ZSBuYW1lOiBzdHJpbmc7XG5cbiAgLy8gRXN0YXTDrXN0aWNhc1xuICBwcml2YXRlIHN0YXRzID0ge1xuICAgIGwxSGl0czogMCxcbiAgICBsMU1pc3NlczogMCxcbiAgICBsMkhpdHM6IDAsXG4gICAgbDJNaXNzZXM6IDAsXG4gICAgdG90YWxIaXRzOiAwLFxuICAgIHRvdGFsTWlzc2VzOiAwXG4gIH07XG5cbiAgY29uc3RydWN0b3IobDE6IENhY2hlQWRhcHRlciwgbDI6IENhY2hlQWRhcHRlciwgbmFtZTogc3RyaW5nID0gJ0xheWVyZWQnKSB7XG4gICAgdGhpcy5sMSA9IGwxO1xuICAgIHRoaXMubDIgPSBsMjtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuXG4gICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBjYWNoZSBpbmljaWFsaXphZG8gKEwxICsgTDIpYCk7XG4gIH1cblxuICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gMe+4j+KDoyBUZW50YSBMMSAobWVtw7NyaWEpXG4gICAgICBjb25zdCBsMVZhbHVlID0gYXdhaXQgdGhpcy5sMS5nZXQ8VD4oa2V5KTtcbiAgICAgIFxuICAgICAgaWYgKGwxVmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnN0YXRzLmwxSGl0cysrO1xuICAgICAgICB0aGlzLnN0YXRzLnRvdGFsSGl0cysrO1xuICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBMMSBISVRgLCB7IGtleSB9KTtcbiAgICAgICAgcmV0dXJuIGwxVmFsdWU7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc3RhdHMubDFNaXNzZXMrKztcblxuICAgICAgLy8gMu+4j+KDoyBUZW50YSBMMiAoUmVkaXMpXG4gICAgICBjb25zdCBsMlZhbHVlID0gYXdhaXQgdGhpcy5sMi5nZXQ8VD4oa2V5KTtcblxuICAgICAgaWYgKGwyVmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnN0YXRzLmwySGl0cysrO1xuICAgICAgICB0aGlzLnN0YXRzLnRvdGFsSGl0cysrO1xuICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBMMiBISVRgLCB7IGtleSB9KTtcblxuICAgICAgICAvLyDwn5S8IFBST01PVkUgcGFyYSBMMSAocHLDs3hpbWEgbGVpdHVyYSBzZXLDoSBtYWlzIHLDoXBpZGEpXG4gICAgICAgIGF3YWl0IHRoaXMubDEuc2V0KGtleSwgbDJWYWx1ZSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IGZhbGhhIGFvIHByb21vdmVyIHBhcmEgTDFgLCB7IGtleSwgZXJyb3I6IGVyciB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGwyVmFsdWU7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc3RhdHMubDJNaXNzZXMrKztcbiAgICAgIHRoaXMuc3RhdHMudG90YWxNaXNzZXMrKztcbiAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLm5hbWV9IE1JU1MgKEwxIGUgTDIpYCwgeyBrZXkgfSk7XG5cbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEdFVCBlcnJvcmAsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2V0PFQ+KGtleTogc3RyaW5nLCB2YWx1ZTogVCwgdHRsPzogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEFybWF6ZW5hIGVtIEFNQkFTIGFzIGNhbWFkYXMgc2ltdWx0YW5lYW1lbnRlXG4gICAgICBjb25zdCBbbDFTdWNjZXNzLCBsMlN1Y2Nlc3NdID0gYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtcbiAgICAgICAgdGhpcy5sMS5zZXQoa2V5LCB2YWx1ZSwgdHRsKSxcbiAgICAgICAgdGhpcy5sMi5zZXQoa2V5LCB2YWx1ZSwgdHRsKVxuICAgICAgXSk7XG5cbiAgICAgIGNvbnN0IGwxT2sgPSBsMVN1Y2Nlc3Muc3RhdHVzID09PSAnZnVsZmlsbGVkJyAmJiBsMVN1Y2Nlc3MudmFsdWU7XG4gICAgICBjb25zdCBsMk9rID0gbDJTdWNjZXNzLnN0YXR1cyA9PT0gJ2Z1bGZpbGxlZCcgJiYgbDJTdWNjZXNzLnZhbHVlO1xuXG4gICAgICBpZiAoIWwxT2spIHtcbiAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBmYWxoYSBMMSBTRVRgLCB7IGtleSB9KTtcbiAgICAgIH1cbiAgICAgIGlmICghbDJPaykge1xuICAgICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IGZhbGhhIEwyIFNFVGAsIHsga2V5IH0pO1xuICAgICAgfVxuXG4gICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBTRVRgLCB7IFxuICAgICAgICBrZXksIFxuICAgICAgICB0dGwsIFxuICAgICAgICBsMTogbDFPayA/ICdPSycgOiAnRkFJTCcsIFxuICAgICAgICBsMjogbDJPayA/ICdPSycgOiAnRkFJTCcgXG4gICAgICB9KTtcblxuICAgICAgLy8gQ29uc2lkZXJhIHN1Y2Vzc28gc2UgcGVsbyBtZW5vcyB1bWEgY2FtYWRhIGZ1bmNpb25vdVxuICAgICAgcmV0dXJuIGwxT2sgfHwgbDJPaztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gU0VUIGVycm9yYCwgeyBrZXksIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShrZXk6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFJlbW92ZSBkZSBBTUJBUyBhcyBjYW1hZGFzXG4gICAgICBjb25zdCBbbDFEZWxldGVkLCBsMkRlbGV0ZWRdID0gYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtcbiAgICAgICAgdGhpcy5sMS5kZWxldGUoa2V5KSxcbiAgICAgICAgdGhpcy5sMi5kZWxldGUoa2V5KVxuICAgICAgXSk7XG5cbiAgICAgIGNvbnN0IGwxQ291bnQgPSBsMURlbGV0ZWQuc3RhdHVzID09PSAnZnVsZmlsbGVkJyA/IGwxRGVsZXRlZC52YWx1ZSA6IDA7XG4gICAgICBjb25zdCBsMkNvdW50ID0gbDJEZWxldGVkLnN0YXR1cyA9PT0gJ2Z1bGZpbGxlZCcgPyBsMkRlbGV0ZWQudmFsdWUgOiAwO1xuXG4gICAgICBjb25zdCB0b3RhbCA9IGwxQ291bnQgKyBsMkNvdW50O1xuXG4gICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBERUxFVEVgLCB7IFxuICAgICAgICBrZXksIFxuICAgICAgICBsMTogbDFDb3VudCwgXG4gICAgICAgIGwyOiBsMkNvdW50LCBcbiAgICAgICAgdG90YWwgXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHRvdGFsO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBERUxFVEUgZXJyb3JgLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmbHVzaCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gTGltcGEgQU1CQVMgYXMgY2FtYWRhc1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtcbiAgICAgICAgdGhpcy5sMS5mbHVzaCgpLFxuICAgICAgICB0aGlzLmwyLmZsdXNoKClcbiAgICAgIF0pO1xuXG4gICAgICBsb2cuaW5mbyhgJHt0aGlzLm5hbWV9IEZMVVNIIEFMTCAoTDEgKyBMMilgKTtcblxuICAgICAgLy8gUmVzZXRhIGVzdGF0w61zdGljYXNcbiAgICAgIHRoaXMuc3RhdHMgPSB7XG4gICAgICAgIGwxSGl0czogMCxcbiAgICAgICAgbDFNaXNzZXM6IDAsXG4gICAgICAgIGwySGl0czogMCxcbiAgICAgICAgbDJNaXNzZXM6IDAsXG4gICAgICAgIHRvdGFsSGl0czogMCxcbiAgICAgICAgdG90YWxNaXNzZXM6IDBcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEZMVVNIIGVycm9yYCwgeyBlcnJvciB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBrZXlzKHBhdHRlcm4/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFJldG9ybmEgVU5Jw4NPIGRlIEwxICsgTDIgKHNlbSBkdXBsaWNhdGFzKVxuICAgICAgY29uc3QgW2wxS2V5cywgbDJLZXlzXSA9IGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbXG4gICAgICAgIHRoaXMubDEua2V5cyhwYXR0ZXJuKSxcbiAgICAgICAgdGhpcy5sMi5rZXlzKHBhdHRlcm4pXG4gICAgICBdKTtcblxuICAgICAgY29uc3QgbDFMaXN0ID0gbDFLZXlzLnN0YXR1cyA9PT0gJ2Z1bGZpbGxlZCcgPyBsMUtleXMudmFsdWUgOiBbXTtcbiAgICAgIGNvbnN0IGwyTGlzdCA9IGwyS2V5cy5zdGF0dXMgPT09ICdmdWxmaWxsZWQnID8gbDJLZXlzLnZhbHVlIDogW107XG5cbiAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGFzXG4gICAgICBjb25zdCB1bmlxdWVLZXlzID0gWy4uLm5ldyBTZXQoWy4uLmwxTGlzdCwgLi4ubDJMaXN0XSldO1xuXG4gICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBLRVlTYCwgeyBcbiAgICAgICAgcGF0dGVybiwgXG4gICAgICAgIGwxOiBsMUxpc3QubGVuZ3RoLCBcbiAgICAgICAgbDI6IGwyTGlzdC5sZW5ndGgsIFxuICAgICAgICB0b3RhbDogdW5pcXVlS2V5cy5sZW5ndGggXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHVuaXF1ZUtleXM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEtFWVMgZXJyb3JgLCB7IHBhdHRlcm4sIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGlzUmVhZHkoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFtsMVJlYWR5LCBsMlJlYWR5XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5sMS5pc1JlYWR5KCksXG4gICAgICAgIHRoaXMubDIuaXNSZWFkeSgpXG4gICAgICBdKTtcblxuICAgICAgLy8gQ29uc2lkZXJhIHByb250byBzZSBwZWxvIG1lbm9zIEwxIGVzdGl2ZXIgT0tcbiAgICAgIHJldHVybiBsMVJlYWR5O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBpc1JlYWR5IGVycm9yYCwgeyBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtcbiAgICAgICAgdGhpcy5sMS5jbG9zZSgpLFxuICAgICAgICB0aGlzLmwyLmNsb3NlKClcbiAgICAgIF0pO1xuXG4gICAgICBsb2cuaW5mbyhgJHt0aGlzLm5hbWV9IGZlY2hhZG8gKEwxICsgTDIpYCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IENMT1NFIGVycm9yYCwgeyBlcnJvciB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBlc3RhdMOtc3RpY2FzIGRvIGNhY2hlIGVtIGNhbWFkYXNcbiAgICovXG4gIGdldFN0YXRzKCkge1xuICAgIGNvbnN0IGwxSGl0UmF0ZSA9IHRoaXMuc3RhdHMubDFIaXRzICsgdGhpcy5zdGF0cy5sMU1pc3NlcyA+IDBcbiAgICAgID8gKHRoaXMuc3RhdHMubDFIaXRzIC8gKHRoaXMuc3RhdHMubDFIaXRzICsgdGhpcy5zdGF0cy5sMU1pc3NlcykpICogMTAwXG4gICAgICA6IDA7XG5cbiAgICBjb25zdCBsMkhpdFJhdGUgPSB0aGlzLnN0YXRzLmwySGl0cyArIHRoaXMuc3RhdHMubDJNaXNzZXMgPiAwXG4gICAgICA/ICh0aGlzLnN0YXRzLmwySGl0cyAvICh0aGlzLnN0YXRzLmwySGl0cyArIHRoaXMuc3RhdHMubDJNaXNzZXMpKSAqIDEwMFxuICAgICAgOiAwO1xuXG4gICAgY29uc3QgdG90YWxIaXRSYXRlID0gdGhpcy5zdGF0cy50b3RhbEhpdHMgKyB0aGlzLnN0YXRzLnRvdGFsTWlzc2VzID4gMFxuICAgICAgPyAodGhpcy5zdGF0cy50b3RhbEhpdHMgLyAodGhpcy5zdGF0cy50b3RhbEhpdHMgKyB0aGlzLnN0YXRzLnRvdGFsTWlzc2VzKSkgKiAxMDBcbiAgICAgIDogMDtcblxuICAgIHJldHVybiB7XG4gICAgICBsMToge1xuICAgICAgICBoaXRzOiB0aGlzLnN0YXRzLmwxSGl0cyxcbiAgICAgICAgbWlzc2VzOiB0aGlzLnN0YXRzLmwxTWlzc2VzLFxuICAgICAgICBoaXRSYXRlOiBsMUhpdFJhdGUudG9GaXhlZCgyKSArICclJ1xuICAgICAgfSxcbiAgICAgIGwyOiB7XG4gICAgICAgIGhpdHM6IHRoaXMuc3RhdHMubDJIaXRzLFxuICAgICAgICBtaXNzZXM6IHRoaXMuc3RhdHMubDJNaXNzZXMsXG4gICAgICAgIGhpdFJhdGU6IGwySGl0UmF0ZS50b0ZpeGVkKDIpICsgJyUnXG4gICAgICB9LFxuICAgICAgdG90YWw6IHtcbiAgICAgICAgaGl0czogdGhpcy5zdGF0cy50b3RhbEhpdHMsXG4gICAgICAgIG1pc3NlczogdGhpcy5zdGF0cy50b3RhbE1pc3NlcyxcbiAgICAgICAgaGl0UmF0ZTogdG90YWxIaXRSYXRlLnRvRml4ZWQoMikgKyAnJSdcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0YSBlc3RhdMOtc3RpY2FzXG4gICAqL1xuICByZXNldFN0YXRzKCk6IHZvaWQge1xuICAgIHRoaXMuc3RhdHMgPSB7XG4gICAgICBsMUhpdHM6IDAsXG4gICAgICBsMU1pc3NlczogMCxcbiAgICAgIGwySGl0czogMCxcbiAgICAgIGwyTWlzc2VzOiAwLFxuICAgICAgdG90YWxIaXRzOiAwLFxuICAgICAgdG90YWxNaXNzZXM6IDBcbiAgICB9O1xuXG4gICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBlc3RhdMOtc3RpY2FzIHJlc2V0YWRhc2ApO1xuICB9XG59Il0sInZlcnNpb24iOjN9