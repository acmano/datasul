name: Deploy LOR0138 to Production

on:
  push:
    branches:
      - main
    paths:
      - 'lor0138/**'
  workflow_dispatch:

env:
  NODE_VERSION: '24'

jobs:
  test:
    name: Tests & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥í³¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§í´§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'lor0138/package-lock.json'

      - name: ðŸ“¦í³¦ Install dependencies
        run: |
          cd lor0138
          npm ci

      - name: ðŸ”í´ Run linter
        run: |
          cd lor0138
          npm run lint

      - name: ðŸ”¨í´¨ Build TypeScript
        run: |
          cd lor0138
          npm run build

      - name: ðŸ§ªí·ª Run tests
        run: |
          cd lor0138
          npm run test:unit || echo "Tests skipped"

  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥í³¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‹í³‹ Create release directory
        run: |
          RELEASE_DIR="/opt/lor0138/backend/releases/$(date +%Y-%m-%d_%H-%M-%S)"
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV
          mkdir -p "$RELEASE_DIR"

      - name: ðŸ“‚í³‚ Copy lor0138 code to release
        run: |
          cp -r lor0138/* "$RELEASE_DIR/"
          cp -r lor0138/.* "$RELEASE_DIR/" 2>/dev/null || true

      - name: âš™ï¸ Copy production env
        run: |
          cp /opt/lor0138/backend/shared/.env "$RELEASE_DIR/.env"

      - name: ðŸ“¦í³¦ Install production dependencies
        run: |
          cd "$RELEASE_DIR"
          npm ci --production

      - name: ðŸ”¨í´¨ Build application
        run: |
          cd "$RELEASE_DIR"
          npm run build

      - name: ðŸ’¾í²¾ Backup current version
        run: |
          if [ -L /opt/lor0138/backend/current ]; then
            CURRENT=$(readlink /opt/lor0138/backend/current)
            BACKUP_DIR="/opt/lor0138/backend/backups/$(basename $CURRENT)"
            cp -r "$CURRENT" "$BACKUP_DIR"
            echo "Backup: $BACKUP_DIR"
          fi

      - name: ðŸ”—í´— Update symlink
        run: |
          ln -snf "$RELEASE_DIR" /opt/lor0138/backend/current

      - name: â™»ï¸ Reload PM2
        run: |
          cd /opt/lor0138/backend/shared
          pm2 reload ecosystem.config.js --update-env

      - name: â±ï¸ Wait for startup
        run: sleep 5

      - name: ðŸ¥í¿¥ Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health)
          
          if [ $response -eq 200 ]; then
            echo "âœ… Deploy successful!"
          else
            echo "âŒ Health check failed: $response"
            
            PREVIOUS=$(ls -t /opt/lor0138/backend/releases | sed -n 2p)
            if [ -n "$PREVIOUS" ]; then
              ln -snf "/opt/lor0138/backend/releases/$PREVIOUS" /opt/lor0138/backend/current
              pm2 reload ecosystem.config.js --update-env
            fi
            
            exit 1
          fi

      - name: ðŸ§¹í·¹ Cleanup old releases
        run: |
          cd /opt/lor0138/backend/releases
          ls -t | tail -n +6 | xargs -r rm -rf

      - name: ðŸ“í³ Log deployment
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Deploy: ${{ github.sha }}" >> /var/log/lor0138
