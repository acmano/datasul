7a9b5ec163f1f006c89652000cd61471
"use strict";
// src/shared/middlewares/errorHandler.middleware.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.errorHandler = errorHandler;
exports.notFoundHandler = notFoundHandler;
exports.asyncHandler = asyncHandler;
const AppError_1 = require("@shared/errors/AppError");
const logger_1 = require("../utils/logger");
/**
 * Sanitiza mensagem de erro (mantido do seu código)
 */
function sanitizeErrorMessage(error) {
    const message = error.message || 'Erro desconhecido';
    let sanitized = message.replace(/\/[^\s]+\.(ts|js|tsx|jsx)/gi, '[arquivo]');
    sanitized = sanitized.replace(/SELECT\s+.*?FROM/gi, 'consulta SQL');
    sanitized = sanitized.replace(/INSERT\s+INTO/gi, 'operação de inserção');
    sanitized = sanitized.replace(/UPDATE\s+.*?SET/gi, 'operação de atualização');
    sanitized = sanitized.replace(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?/g, '[servidor]');
    sanitized = sanitized.replace(/user=\w+/gi, 'user=[oculto]');
    sanitized = sanitized.replace(/password=\w+/gi, 'password=[oculto]');
    return sanitized;
}
/**
 * Middleware global de tratamento de erros
 */
function errorHandler(err, req, res, next) {
    if (res.headersSent) {
        return next(err);
    }
    const statusCode = err instanceof AppError_1.AppError ? err.statusCode : 500;
    const isOperational = err instanceof AppError_1.AppError ? err.isOperational : false;
    const context = err instanceof AppError_1.AppError ? err.context : undefined;
    // Log baseado no tipo
    if (isOperational) {
        logger_1.log.warn('Erro operacional', {
            requestId: req.requestId,
            method: req.method,
            url: req.originalUrl,
            statusCode,
            message: err.message,
            context,
        });
    }
    else {
        logger_1.log.error('Erro não operacional', {
            requestId: req.requestId,
            method: req.method,
            url: req.originalUrl,
            error: err.message,
            stack: err.stack,
        });
    }
    const isDevelopment = process.env.NODE_ENV === 'development';
    if (isDevelopment) {
        return res.status(statusCode).json({
            error: err.name || 'Error',
            message: err.message,
            timestamp: new Date().toISOString(),
            path: req.originalUrl,
            requestId: req.requestId,
            context,
            stack: err.stack?.split('\n').slice(0, 5),
        });
    }
    // Produção: sanitiza mensagem
    const userMessage = isOperational
        ? sanitizeErrorMessage(err)
        : 'Erro interno do servidor. Tente novamente mais tarde.';
    res.status(statusCode).json({
        error: err.name || 'Error',
        message: userMessage,
        timestamp: new Date().toISOString(),
        path: req.originalUrl,
        requestId: req.requestId,
    });
}
/**
 * 404 - Rota não encontrada
 */
function notFoundHandler(req, res, next) {
    const error = new AppError_1.AppError(404, `Rota não encontrada: ${req.method} ${req.originalUrl}`, true, { method: req.method, path: req.originalUrl });
    next(error);
}
/**
 * asyncHandler (mantido do seu código)
 */
function asyncHandler(fn) {
    return (req, res, next) => {
        Promise.resolve(fn(req, res, next)).catch(next);
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC9taWRkbGV3YXJlcy9lcnJvckhhbmRsZXIubWlkZGxld2FyZS50cyIsIm1hcHBpbmdzIjoiO0FBQUEsb0RBQW9EOztBQTBCcEQsb0NBNERDO0FBS0QsMENBUUM7QUFLRCxvQ0FJQztBQXpHRCxzREFBbUQ7QUFDbkQsNENBQXNDO0FBRXRDOztHQUVHO0FBQ0gsU0FBUyxvQkFBb0IsQ0FBQyxLQUFVO0lBQ3RDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLElBQUksbUJBQW1CLENBQUM7SUFFckQsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyw2QkFBNkIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUM1RSxTQUFTLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUNwRSxTQUFTLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3pFLFNBQVMsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLHlCQUF5QixDQUFDLENBQUM7SUFDOUUsU0FBUyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsNENBQTRDLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDMUYsU0FBUyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0lBQzdELFNBQVMsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLG1CQUFtQixDQUFDLENBQUM7SUFFckUsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsWUFBWSxDQUMxQixHQUFxQixFQUNyQixHQUFZLEVBQ1osR0FBYSxFQUNiLElBQWtCO0lBRWxCLElBQUksR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFD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QyxDQUFDO0lBQ0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2QsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsWUFBWSxDQUFDLEVBQVk7SUFDdkMsT0FBTyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQ3pELE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9tYW5vL3Byb2pldG9zL2RhdGFzdWwvbG9yMDEzOC9zcmMvc2hhcmVkL21pZGRsZXdhcmVzL2Vycm9ySGFuZGxlci5taWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9zaGFyZWQvbWlkZGxld2FyZXMvZXJyb3JIYW5kbGVyLm1pZGRsZXdhcmUudHNcblxuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgQXBwRXJyb3IgfSBmcm9tICdAc2hhcmVkL2Vycm9ycy9BcHBFcnJvcic7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuXG4vKipcbiAqIFNhbml0aXphIG1lbnNhZ2VtIGRlIGVycm8gKG1hbnRpZG8gZG8gc2V1IGPDs2RpZ28pXG4gKi9cbmZ1bmN0aW9uIHNhbml0aXplRXJyb3JNZXNzYWdlKGVycm9yOiBhbnkpOiBzdHJpbmcge1xuICBjb25zdCBtZXNzYWdlID0gZXJyb3IubWVzc2FnZSB8fCAnRXJybyBkZXNjb25oZWNpZG8nO1xuICBcbiAgbGV0IHNhbml0aXplZCA9IG1lc3NhZ2UucmVwbGFjZSgvXFwvW15cXHNdK1xcLih0c3xqc3x0c3h8anN4KS9naSwgJ1thcnF1aXZvXScpO1xuICBzYW5pdGl6ZWQgPSBzYW5pdGl6ZWQucmVwbGFjZSgvU0VMRUNUXFxzKy4qP0ZST00vZ2ksICdjb25zdWx0YSBTUUwnKTtcbiAgc2FuaXRpemVkID0gc2FuaXRpemVkLnJlcGxhY2UoL0lOU0VSVFxccytJTlRPL2dpLCAnb3BlcmHDp8OjbyBkZSBpbnNlcsOnw6NvJyk7XG4gIHNhbml0aXplZCA9IHNhbml0aXplZC5yZXBsYWNlKC9VUERBVEVcXHMrLio/U0VUL2dpLCAnb3BlcmHDp8OjbyBkZSBhdHVhbGl6YcOnw6NvJyk7XG4gIHNhbml0aXplZCA9IHNhbml0aXplZC5yZXBsYWNlKC9cXGR7MSwzfVxcLlxcZHsxLDN9XFwuXFxkezEsM31cXC5cXGR7MSwzfSg6XFxkKyk/L2csICdbc2Vydmlkb3JdJyk7XG4gIHNhbml0aXplZCA9IHNhbml0aXplZC5yZXBsYWNlKC91c2VyPVxcdysvZ2ksICd1c2VyPVtvY3VsdG9dJyk7XG4gIHNhbml0aXplZCA9IHNhbml0aXplZC5yZXBsYWNlKC9wYXNzd29yZD1cXHcrL2dpLCAncGFzc3dvcmQ9W29jdWx0b10nKTtcbiAgXG4gIHJldHVybiBzYW5pdGl6ZWQ7XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBnbG9iYWwgZGUgdHJhdGFtZW50byBkZSBlcnJvc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZXJyb3JIYW5kbGVyKFxuICBlcnI6IEVycm9yIHwgQXBwRXJyb3IsXG4gIHJlcTogUmVxdWVzdCxcbiAgcmVzOiBSZXNwb25zZSxcbiAgbmV4dDogTmV4dEZ1bmN0aW9uXG4pIHtcbiAgaWYgKHJlcy5oZWFkZXJzU2VudCkge1xuICAgIHJldHVybiBuZXh0KGVycik7XG4gIH1cblxuICBjb25zdCBzdGF0dXNDb2RlID0gZXJyIGluc3RhbmNlb2YgQXBwRXJyb3IgPyBlcnIuc3RhdHVzQ29kZSA6IDUwMDtcbiAgY29uc3QgaXNPcGVyYXRpb25hbCA9IGVyciBpbnN0YW5jZW9mIEFwcEVycm9yID8gZXJyLmlzT3BlcmF0aW9uYWwgOiBmYWxzZTtcbiAgY29uc3QgY29udGV4dCA9IGVyciBpbnN0YW5jZW9mIEFwcEVycm9yID8gZXJyLmNvbnRleHQgOiB1bmRlZmluZWQ7XG5cbiAgLy8gTG9nIGJhc2VhZG8gbm8gdGlwb1xuICBpZiAoaXNPcGVyYXRpb25hbCkge1xuICAgIGxvZy53YXJuKCdFcnJvIG9wZXJhY2lvbmFsJywge1xuICAgICAgcmVxdWVzdElkOiByZXEucmVxdWVzdElkLFxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgdXJsOiByZXEub3JpZ2luYWxVcmwsXG4gICAgICBzdGF0dXNDb2RlLFxuICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICBjb250ZXh0LFxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGxvZy5lcnJvcignRXJybyBuw6NvIG9wZXJhY2lvbmFsJywge1xuICAgICAgcmVxdWVzdElkOiByZXEucmVxdWVzdElkLFxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgdXJsOiByZXEub3JpZ2luYWxVcmwsXG4gICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXG4gICAgICBzdGFjazogZXJyLnN0YWNrLFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgaXNEZXZlbG9wbWVudCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnO1xuXG4gIGlmIChpc0RldmVsb3BtZW50KSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbih7XG4gICAgICBlcnJvcjogZXJyLm5hbWUgfHwgJ0Vycm9yJyxcbiAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBwYXRoOiByZXEub3JpZ2luYWxVcmwsXG4gICAgICByZXF1ZXN0SWQ6IHJlcS5yZXF1ZXN0SWQsXG4gICAgICBjb250ZXh0LFxuICAgICAgc3RhY2s6IGVyci5zdGFjaz8uc3BsaXQoJ1xcbicpLnNsaWNlKDAsIDUpLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gUHJvZHXDp8Ojbzogc2FuaXRpemEgbWVuc2FnZW1cbiAgY29uc3QgdXNlck1lc3NhZ2UgPSBpc09wZXJhdGlvbmFsXG4gICAgPyBzYW5pdGl6ZUVycm9yTWVzc2FnZShlcnIpXG4gICAgOiAnRXJybyBpbnRlcm5vIGRvIHNlcnZpZG9yLiBUZW50ZSBub3ZhbWVudGUgbWFpcyB0YXJkZS4nO1xuXG4gIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbih7XG4gICAgZXJyb3I6IGVyci5uYW1lIHx8ICdFcnJvcicsXG4gICAgbWVzc2FnZTogdXNlck1lc3NhZ2UsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgcGF0aDogcmVxLm9yaWdpbmFsVXJsLFxuICAgIHJlcXVlc3RJZDogcmVxLnJlcXVlc3RJZCxcbiAgfSk7XG59XG5cbi8qKlxuICogNDA0IC0gUm90YSBuw6NvIGVuY29udHJhZGFcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG5vdEZvdW5kSGFuZGxlcihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikge1xuICBjb25zdCBlcnJvciA9IG5ldyBBcHBFcnJvcihcbiAgICA0MDQsXG4gICAgYFJvdGEgbsOjbyBlbmNvbnRyYWRhOiAke3JlcS5tZXRob2R9ICR7cmVxLm9yaWdpbmFsVXJsfWAsXG4gICAgdHJ1ZSxcbiAgICB7IG1ldGhvZDogcmVxLm1ldGhvZCwgcGF0aDogcmVxLm9yaWdpbmFsVXJsIH1cbiAgKTtcbiAgbmV4dChlcnJvcik7XG59XG5cbi8qKlxuICogYXN5bmNIYW5kbGVyIChtYW50aWRvIGRvIHNldSBjw7NkaWdvKVxuICovXG5leHBvcnQgZnVuY3Rpb24gYXN5bmNIYW5kbGVyKGZuOiBGdW5jdGlvbikge1xuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgUHJvbWlzZS5yZXNvbHZlKGZuKHJlcSwgcmVzLCBuZXh0KSkuY2F0Y2gobmV4dCk7XG4gIH07XG59Il0sInZlcnNpb24iOjN9