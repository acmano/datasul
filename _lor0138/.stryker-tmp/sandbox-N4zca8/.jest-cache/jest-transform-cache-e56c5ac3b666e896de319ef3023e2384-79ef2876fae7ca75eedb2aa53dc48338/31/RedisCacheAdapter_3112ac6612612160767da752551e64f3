1c93229e0e57ddf864765ccfb1d99b33
"use strict";
// @ts-nocheck
// src/shared/utils/cache/RedisCacheAdapter.ts
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedisCacheAdapter = void 0;
const ioredis_1 = __importDefault(require("ioredis"));
const logger_1 = require("../logger");
/**
 * Adaptador de cache Redis (L2)
 * - Compartilhado entre múltiplas instâncias
 * - Persistente (sobrevive a restarts)
 * - Um pouco mais lento que memória (rede)
 */
class RedisCacheAdapter {
    constructor(urlOrOptions, name = 'L2-Redis') {
        this.ready = false;
        this.name = name;
        // Aceita URL ou objeto de configuração
        if (typeof urlOrOptions === 'string') {
            this.redis = new ioredis_1.default(urlOrOptions, {
                retryStrategy: (times) => {
                    const delay = Math.min(times * 50, 2000);
                    logger_1.log.warn(`${this.name} reconectando...`, { attempt: times, delay });
                    return delay;
                },
                maxRetriesPerRequest: 3,
                enableReadyCheck: true,
                lazyConnect: false
            });
        }
        else {
            this.redis = new ioredis_1.default(urlOrOptions);
        }
        this.setupEventHandlers();
    }
    setupEventHandlers() {
        this.redis.on('connect', () => {
            logger_1.log.info(`${this.name} conectando...`);
        });
        this.redis.on('ready', () => {
            this.ready = true;
            logger_1.log.info(`${this.name} pronto`, {
                host: this.redis.options.host,
                port: this.redis.options.port
            });
        });
        this.redis.on('error', (error) => {
            logger_1.log.error(`${this.name} erro`, { error: error.message });
        });
        this.redis.on('close', () => {
            this.ready = false;
            logger_1.log.warn(`${this.name} conexão fechada`);
        });
        this.redis.on('reconnecting', () => {
            logger_1.log.info(`${this.name} reconectando...`);
        });
    }
    async get(key) {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`, { key });
                return undefined;
            }
            const value = await this.redis.get(key);
            if (value) {
                logger_1.log.debug(`${this.name} HIT`, { key });
                return JSON.parse(value);
            }
            logger_1.log.debug(`${this.name} MISS`, { key });
            return undefined;
        }
        catch (error) {
            logger_1.log.error(`${this.name} GET error`, { key, error });
            return undefined;
        }
    }
    async set(key, value, ttl) {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`, { key });
                return false;
            }
            const serialized = JSON.stringify(value);
            if (ttl && ttl > 0) {
                // SETEX: Set com expiração
                await this.redis.setex(key, ttl, serialized);
            }
            else {
                // SET: Sem expiração
                await this.redis.set(key, serialized);
            }
            logger_1.log.debug(`${this.name} SET`, { key, ttl });
            return true;
        }
        catch (error) {
            logger_1.log.error(`${this.name} SET error`, { key, error });
            return false;
        }
    }
    async delete(key) {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`, { key });
                return 0;
            }
            const deleted = await this.redis.del(key);
            logger_1.log.debug(`${this.name} DELETE`, { key, deleted });
            return deleted;
        }
        catch (error) {
            logger_1.log.error(`${this.name} DELETE error`, { key, error });
            return 0;
        }
    }
    async flush() {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`);
                return;
            }
            await this.redis.flushall();
            logger_1.log.info(`${this.name} FLUSH ALL`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} FLUSH error`, { error });
        }
    }
    async keys(pattern = '*') {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`);
                return [];
            }
            // SCAN é mais seguro que KEYS em produção
            const keys = [];
            let cursor = '0';
            do {
                const [nextCursor, foundKeys] = await this.redis.scan(cursor, 'MATCH', pattern, 'COUNT', 100);
                cursor = nextCursor;
                keys.push(...foundKeys);
            } while (cursor !== '0');
            return keys;
        }
        catch (error) {
            logger_1.log.error(`${this.name} KEYS error`, { pattern, error });
            return [];
        }
    }
    async isReady() {
        return this.ready;
    }
    async close() {
        try {
            await this.redis.quit();
            this.ready = false;
            logger_1.log.info(`${this.name} fechado`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} CLOSE error`, { error });
        }
    }
    /**
     * Métodos extras específicos do Redis
     */
    async ping() {
        return this.redis.ping();
    }
    async info() {
        return this.redis.info();
    }
    getClient() {
        return this.redis;
    }
}
exports.RedisCacheAdapter = RedisCacheAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvLnN0cnlrZXItdG1wL3NhbmRib3gtTjR6Y2E4L3NyYy9zaGFyZWQvdXRpbHMvY2FjaGUvUmVkaXNDYWNoZUFkYXB0ZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLGNBQWM7QUFDZCw4Q0FBOEM7Ozs7OztBQUU5QyxzREFBNEI7QUFHNUIsc0NBQWdDO0FBRWhDOzs7OztHQUtHO0FBQ0gsTUFBYSxpQkFBaUI7SUFLNUIsWUFBWSxZQUFtQyxFQUFFLE9BQWUsVUFBVTtRQUZsRSxVQUFLLEdBQVksS0FBSyxDQUFDO1FBRzdCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWpCLHVDQUF1QztRQUN2QyxJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxpQkFBSyxDQUFDLFlBQVksRUFBRTtnQkFDbkMsYUFBYSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7b0JBQ3ZCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDekMsWUFBRyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGtCQUFrQixFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO29CQUNwRSxPQUFPLEtBQUssQ0FBQztnQkFDZixDQUFDO2dCQUNELG9CQUFvQixFQUFFLENBQUM7Z0JBQ3ZCLGdCQUFnQixFQUFFLElBQUk7Z0JBQ3RCLFdBQVcsRUFBRSxLQUFLO2FBQ25CLENBQUMsQ0FBQztRQUNMLENBQUM7YUFBTSxDQUFDO1lBQ04sSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGlCQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUVELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTyxrQkFBa0I7UUFDeEIs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Q0FBQyxJQUFJO1FBQ1IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBSTtRQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQsU0FBUztRQUNQLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0NBQ0Y7QUE5TEQsOENBOExDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL21hbm8vcHJvamV0b3MvZGF0YXN1bC9sb3IwMTM4Ly5zdHJ5a2VyLXRtcC9zYW5kYm94LU40emNhOC9zcmMvc2hhcmVkL3V0aWxzL2NhY2hlL1JlZGlzQ2FjaGVBZGFwdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIEB0cy1ub2NoZWNrXG4vLyBzcmMvc2hhcmVkL3V0aWxzL2NhY2hlL1JlZGlzQ2FjaGVBZGFwdGVyLnRzXG5cbmltcG9ydCBSZWRpcyBmcm9tICdpb3JlZGlzJztcbmltcG9ydCB0eXBlIHsgUmVkaXNPcHRpb25zIH0gZnJvbSAnaW9yZWRpcyc7XG5pbXBvcnQgeyBDYWNoZUFkYXB0ZXIgfSBmcm9tICcuL0NhY2hlQWRhcHRlcic7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi9sb2dnZXInO1xuXG4vKipcbiAqIEFkYXB0YWRvciBkZSBjYWNoZSBSZWRpcyAoTDIpXG4gKiAtIENvbXBhcnRpbGhhZG8gZW50cmUgbcO6bHRpcGxhcyBpbnN0w6JuY2lhc1xuICogLSBQZXJzaXN0ZW50ZSAoc29icmV2aXZlIGEgcmVzdGFydHMpXG4gKiAtIFVtIHBvdWNvIG1haXMgbGVudG8gcXVlIG1lbcOzcmlhIChyZWRlKVxuICovXG5leHBvcnQgY2xhc3MgUmVkaXNDYWNoZUFkYXB0ZXIgaW1wbGVtZW50cyBDYWNoZUFkYXB0ZXIge1xuICBwcml2YXRlIHJlZGlzOiBSZWRpcztcbiAgcHJpdmF0ZSBuYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZHk6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcih1cmxPck9wdGlvbnM6IHN0cmluZyB8IFJlZGlzT3B0aW9ucywgbmFtZTogc3RyaW5nID0gJ0wyLVJlZGlzJykge1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG5cbiAgICAvLyBBY2VpdGEgVVJMIG91IG9iamV0byBkZSBjb25maWd1cmHDp8Ojb1xuICAgIGlmICh0eXBlb2YgdXJsT3JPcHRpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5yZWRpcyA9IG5ldyBSZWRpcyh1cmxPck9wdGlvbnMsIHtcbiAgICAgICAgcmV0cnlTdHJhdGVneTogKHRpbWVzKSA9PiB7XG4gICAgICAgICAgY29uc3QgZGVsYXkgPSBNYXRoLm1pbih0aW1lcyAqIDUwLCAyMDAwKTtcbiAgICAgICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IHJlY29uZWN0YW5kby4uLmAsIHsgYXR0ZW1wdDogdGltZXMsIGRlbGF5IH0pO1xuICAgICAgICAgIHJldHVybiBkZWxheTtcbiAgICAgICAgfSxcbiAgICAgICAgbWF4UmV0cmllc1BlclJlcXVlc3Q6IDMsXG4gICAgICAgIGVuYWJsZVJlYWR5Q2hlY2s6IHRydWUsXG4gICAgICAgIGxhenlDb25uZWN0OiBmYWxzZVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVkaXMgPSBuZXcgUmVkaXModXJsT3JPcHRpb25zKTtcbiAgICB9XG5cbiAgICB0aGlzLnNldHVwRXZlbnRIYW5kbGVycygpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cEV2ZW50SGFuZGxlcnMoKTogdm9pZCB7XG4gICAgdGhpcy5yZWRpcy5vbignY29ubmVjdCcsICgpID0+IHtcbiAgICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gY29uZWN0YW5kby4uLmApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yZWRpcy5vbigncmVhZHknLCAoKSA9PiB7XG4gICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gcHJvbnRvYCwge1xuICAgICAgICBob3N0OiB0aGlzLnJlZGlzLm9wdGlvbnMuaG9zdCxcbiAgICAgICAgcG9ydDogdGhpcy5yZWRpcy5vcHRpb25zLnBvcnRcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yZWRpcy5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IGVycm9gLCB7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yZWRpcy5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IGNvbmV4w6NvIGZlY2hhZGFgKTtcbiAgICB9KTtcblxuICAgIHRoaXMucmVkaXMub24oJ3JlY29ubmVjdGluZycsICgpID0+IHtcbiAgICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gcmVjb25lY3RhbmRvLi4uYCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgIGxvZy53YXJuKGAke3RoaXMubmFtZX0gbsOjbyBlc3TDoSBwcm9udG9gLCB7IGtleSB9KTtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLnJlZGlzLmdldChrZXkpO1xuXG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gSElUYCwgeyBrZXkgfSk7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKSBhcyBUO1xuICAgICAgfVxuXG4gICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBNSVNTYCwgeyBrZXkgfSk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBHRVQgZXJyb3JgLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldDxUPihrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bD86IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBuw6NvIGVzdMOhIHByb250b2AsIHsga2V5IH0pO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG5cbiAgICAgIGlmICh0dGwgJiYgdHRsID4gMCkge1xuICAgICAgICAvLyBTRVRFWDogU2V0IGNvbSBleHBpcmHDp8Ojb1xuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzLnNldGV4KGtleSwgdHRsLCBzZXJpYWxpemVkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFNFVDogU2VtIGV4cGlyYcOnw6NvXG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXMuc2V0KGtleSwgc2VyaWFsaXplZCk7XG4gICAgICB9XG5cbiAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLm5hbWV9IFNFVGAsIHsga2V5LCB0dGwgfSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gU0VUIGVycm9yYCwgeyBrZXksIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShrZXk6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGhpcy5yZWFkeSkge1xuICAgICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IG7Do28gZXN0w6EgcHJvbnRvYCwgeyBrZXkgfSk7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgdGhpcy5yZWRpcy5kZWwoa2V5KTtcbiAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLm5hbWV9IERFTEVURWAsIHsga2V5LCBkZWxldGVkIH0pO1xuICAgICAgcmV0dXJuIGRlbGV0ZWQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IERFTEVURSBlcnJvcmAsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZsdXNoKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBuw6NvIGVzdMOhIHByb250b2ApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMucmVkaXMuZmx1c2hhbGwoKTtcbiAgICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gRkxVU0ggQUxMYCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEZMVVNIIGVycm9yYCwgeyBlcnJvciB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBrZXlzKHBhdHRlcm46IHN0cmluZyA9ICcqJyk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgIGxvZy53YXJuKGAke3RoaXMubmFtZX0gbsOjbyBlc3TDoSBwcm9udG9gKTtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfVxuXG4gICAgICAvLyBTQ0FOIMOpIG1haXMgc2VndXJvIHF1ZSBLRVlTIGVtIHByb2R1w6fDo29cbiAgICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gW107XG4gICAgICBsZXQgY3Vyc29yID0gJzAnO1xuXG4gICAgICBkbyB7XG4gICAgICAgIGNvbnN0IFtuZXh0Q3Vyc29yLCBmb3VuZEtleXNdID0gYXdhaXQgdGhpcy5yZWRpcy5zY2FuKFxuICAgICAgICAgIGN1cnNvcixcbiAgICAgICAgICAnTUFUQ0gnLFxuICAgICAgICAgIHBhdHRlcm4sXG4gICAgICAgICAgJ0NPVU5UJyxcbiAgICAgICAgICAxMDBcbiAgICAgICAgKTtcblxuICAgICAgICBjdXJzb3IgPSBuZXh0Q3Vyc29yO1xuICAgICAgICBrZXlzLnB1c2goLi4uZm91bmRLZXlzKTtcbiAgICAgIH0gd2hpbGUgKGN1cnNvciAhPT0gJzAnKTtcblxuICAgICAgcmV0dXJuIGtleXM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEtFWVMgZXJyb3JgLCB7IHBhdHRlcm4sIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGlzUmVhZHkoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZHk7XG4gIH1cblxuICBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5xdWl0KCk7XG4gICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gICAgICBsb2cuaW5mbyhgJHt0aGlzLm5hbWV9IGZlY2hhZG9gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gQ0xPU0UgZXJyb3JgLCB7IGVycm9yIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNw6l0b2RvcyBleHRyYXMgZXNwZWPDrWZpY29zIGRvIFJlZGlzXG4gICAqL1xuICBhc3luYyBwaW5nKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMucmVkaXMucGluZygpO1xuICB9XG5cbiAgYXN5bmMgaW5mbygpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLnJlZGlzLmluZm8oKTtcbiAgfVxuXG4gIGdldENsaWVudCgpOiBSZWRpcyB7XG4gICAgcmV0dXJuIHRoaXMucmVkaXM7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=