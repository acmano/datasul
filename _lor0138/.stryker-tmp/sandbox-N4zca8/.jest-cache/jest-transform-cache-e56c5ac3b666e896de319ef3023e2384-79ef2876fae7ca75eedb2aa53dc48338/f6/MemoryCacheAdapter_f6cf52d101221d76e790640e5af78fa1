e88647f085fb5ee9c5eda54fe6ff94c4
"use strict";
// @ts-nocheck
// src/shared/utils/cache/MemoryCacheAdapter.ts
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryCacheAdapter = void 0;
const node_cache_1 = __importDefault(require("node-cache"));
const logger_1 = require("../logger");
/**
 * Adaptador de cache em memória (L1)
 * - Ultra rápido (acesso local)
 * - Volátil (perde dados ao reiniciar)
 * - Não compartilhado entre instâncias
 */
class MemoryCacheAdapter {
    constructor(stdTTL = 300, name = 'L1-Memory') {
        this.cache = new node_cache_1.default({
            stdTTL,
            checkperiod: 120, // Verifica expiração a cada 2min
            useClones: false // Performance: não clona objetos
        });
        this.name = name;
        logger_1.log.info(`${this.name} cache inicializado`, {
            ttl: stdTTL,
            checkPeriod: 120
        });
    }
    async get(key) {
        try {
            const value = this.cache.get(key);
            if (value !== undefined) {
                logger_1.log.debug(`${this.name} HIT`, { key });
            }
            else {
                logger_1.log.debug(`${this.name} MISS`, { key });
            }
            return value;
        }
        catch (error) {
            logger_1.log.error(`${this.name} GET error`, { key, error });
            return undefined;
        }
    }
    async set(key, value, ttl) {
        try {
            const success = ttl
                ? this.cache.set(key, value, ttl)
                : this.cache.set(key, value);
            if (success) {
                logger_1.log.debug(`${this.name} SET`, { key, ttl });
            }
            return success;
        }
        catch (error) {
            logger_1.log.error(`${this.name} SET error`, { key, error });
            return false;
        }
    }
    async delete(key) {
        try {
            const deleted = this.cache.del(key);
            logger_1.log.debug(`${this.name} DELETE`, { key, deleted });
            return deleted;
        }
        catch (error) {
            logger_1.log.error(`${this.name} DELETE error`, { key, error });
            return 0;
        }
    }
    async flush() {
        try {
            this.cache.flushAll();
            logger_1.log.info(`${this.name} FLUSH ALL`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} FLUSH error`, { error });
        }
    }
    async keys(pattern) {
        try {
            const allKeys = this.cache.keys();
            if (!pattern) {
                return allKeys;
            }
            // Converte pattern com * para regex
            const regex = new RegExp('^' + pattern.replace(/\*/g, '.*') + '$');
            return allKeys.filter(key => regex.test(key));
        }
        catch (error) {
            logger_1.log.error(`${this.name} KEYS error`, { pattern, error });
            return [];
        }
    }
    async isReady() {
        return true; // Memória sempre está pronta
    }
    async close() {
        try {
            this.cache.close();
            logger_1.log.info(`${this.name} fechado`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} CLOSE error`, { error });
        }
    }
    /**
     * Métodos extras específicos do NodeCache
     */
    getStats() {
        return this.cache.getStats();
    }
    getTtl(key) {
        return this.cache.getTtl(key);
    }
}
exports.MemoryCacheAdapter = MemoryCacheAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvLnN0cnlrZXItdG1wL3NhbmRib3gtTjR6Y2E4L3NyYy9zaGFyZWQvdXRpbHMvY2FjaGUvTWVtb3J5Q2FjaGVBZGFwdGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxjQUFjO0FBQ2QsK0NBQStDOzs7Ozs7QUFFL0MsNERBQW1DO0FBRW5DLHNDQUFnQztBQUVoQzs7Ozs7R0FLRztBQUNILE1BQWEsa0JBQWtCO0lBSTdCLFlBQVksU0FBaUIsR0FBRyxFQUFFLE9BQWUsV0FBVztRQUMxRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksb0JBQVMsQ0FBQztZQUN6QixNQUFNO1lBQ04sV0FBVyxFQUFFLEdBQUcsRUFBRSxpQ0FBaUM7WUFDbkQsU0FBUyxFQUFFLEtBQUssQ0FBRSxpQ0FBaUM7U0FDcEQsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFFakIsWUFBRyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLHFCQUFxQixFQUFFO1lBQzFDLEdBQUcsRUFBRSxNQUFNO1lBQ1gsV0FBVyxFQUFFLEdBQUc7U0FDakIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQUksR0FBVztRQUN0QixJQUFJLENBQUM7WUFDSCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBSSxHQUFHLENBQUMsQ0FBQztZQUVyQyxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDeEIsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDekMsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLFlBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLENBQUM7WUFFRCxPQUFP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RSxDQUFDO1lBQ2YsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGFBQWEsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3pELE9BQU8sRUFBRSxDQUFDO1FBQ1osQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNYLE9BQU8sSUFBSSxDQUFDLENBQUMsNkJBQTZCO0lBQzVDLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbkIsWUFBRyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLFVBQVUsQ0FBQyxDQUFDO1FBQ25DLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGNBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDbkQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILFFBQVE7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFXO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNGO0FBbkhELGdEQW1IQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9tYW5vL3Byb2pldG9zL2RhdGFzdWwvbG9yMDEzOC8uc3RyeWtlci10bXAvc2FuZGJveC1ONHpjYTgvc3JjL3NoYXJlZC91dGlscy9jYWNoZS9NZW1vcnlDYWNoZUFkYXB0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLW5vY2hlY2tcbi8vIHNyYy9zaGFyZWQvdXRpbHMvY2FjaGUvTWVtb3J5Q2FjaGVBZGFwdGVyLnRzXG5cbmltcG9ydCBOb2RlQ2FjaGUgZnJvbSAnbm9kZS1jYWNoZSc7XG5pbXBvcnQgeyBDYWNoZUFkYXB0ZXIgfSBmcm9tICcuL0NhY2hlQWRhcHRlcic7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi9sb2dnZXInO1xuXG4vKipcbiAqIEFkYXB0YWRvciBkZSBjYWNoZSBlbSBtZW3Ds3JpYSAoTDEpXG4gKiAtIFVsdHJhIHLDoXBpZG8gKGFjZXNzbyBsb2NhbClcbiAqIC0gVm9sw6F0aWwgKHBlcmRlIGRhZG9zIGFvIHJlaW5pY2lhcilcbiAqIC0gTsOjbyBjb21wYXJ0aWxoYWRvIGVudHJlIGluc3TDom5jaWFzXG4gKi9cbmV4cG9ydCBjbGFzcyBNZW1vcnlDYWNoZUFkYXB0ZXIgaW1wbGVtZW50cyBDYWNoZUFkYXB0ZXIge1xuICBwcml2YXRlIGNhY2hlOiBOb2RlQ2FjaGU7XG4gIHByaXZhdGUgbmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHN0ZFRUTDogbnVtYmVyID0gMzAwLCBuYW1lOiBzdHJpbmcgPSAnTDEtTWVtb3J5Jykge1xuICAgIHRoaXMuY2FjaGUgPSBuZXcgTm9kZUNhY2hlKHsgXG4gICAgICBzdGRUVEwsXG4gICAgICBjaGVja3BlcmlvZDogMTIwLCAvLyBWZXJpZmljYSBleHBpcmHDp8OjbyBhIGNhZGEgMm1pblxuICAgICAgdXNlQ2xvbmVzOiBmYWxzZSAgLy8gUGVyZm9ybWFuY2U6IG7Do28gY2xvbmEgb2JqZXRvc1xuICAgIH0pO1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG5cbiAgICBsb2cuaW5mbyhgJHt0aGlzLm5hbWV9IGNhY2hlIGluaWNpYWxpemFkb2AsIHsgXG4gICAgICB0dGw6IHN0ZFRUTCxcbiAgICAgIGNoZWNrUGVyaW9kOiAxMjAgXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmNhY2hlLmdldDxUPihrZXkpO1xuICAgICAgXG4gICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBISVRgLCB7IGtleSB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLm5hbWV9IE1JU1NgLCB7IGtleSB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBHRVQgZXJyb3JgLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldDxUPihrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bD86IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdWNjZXNzID0gdHRsIFxuICAgICAgICA/IHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUsIHR0bClcbiAgICAgICAgOiB0aGlzLmNhY2hlLnNldChrZXksIHZhbHVlKTtcblxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gU0VUYCwgeyBrZXksIHR0bCB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHN1Y2Nlc3M7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IFNFVCBlcnJvcmAsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkZWxldGVkID0gdGhpcy5jYWNoZS5kZWwoa2V5KTtcbiAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLm5hbWV9IERFTEVURWAsIHsga2V5LCBkZWxldGVkIH0pO1xuICAgICAgcmV0dXJuIGRlbGV0ZWQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IERFTEVURSBlcnJvcmAsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZsdXNoKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmNhY2hlLmZsdXNoQWxsKCk7XG4gICAgICBsb2cuaW5mbyhgJHt0aGlzLm5hbWV9IEZMVVNIIEFMTGApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBGTFVTSCBlcnJvcmAsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMga2V5cyhwYXR0ZXJuPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhbGxLZXlzID0gdGhpcy5jYWNoZS5rZXlzKCk7XG5cbiAgICAgIGlmICghcGF0dGVybikge1xuICAgICAgICByZXR1cm4gYWxsS2V5cztcbiAgICAgIH1cblxuICAgICAgLy8gQ29udmVydGUgcGF0dGVybiBjb20gKiBwYXJhIHJlZ2V4XG4gICAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoXG4gICAgICAgICdeJyArIHBhdHRlcm4ucmVwbGFjZSgvXFwqL2csICcuKicpICsgJyQnXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gYWxsS2V5cy5maWx0ZXIoa2V5ID0+IHJlZ2V4LnRlc3Qoa2V5KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEtFWVMgZXJyb3JgLCB7IHBhdHRlcm4sIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGlzUmVhZHkoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRydWU7IC8vIE1lbcOzcmlhIHNlbXByZSBlc3TDoSBwcm9udGFcbiAgfVxuXG4gIGFzeW5jIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmNhY2hlLmNsb3NlKCk7XG4gICAgICBsb2cuaW5mbyhgJHt0aGlzLm5hbWV9IGZlY2hhZG9gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gQ0xPU0UgZXJyb3JgLCB7IGVycm9yIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNw6l0b2RvcyBleHRyYXMgZXNwZWPDrWZpY29zIGRvIE5vZGVDYWNoZVxuICAgKi9cbiAgZ2V0U3RhdHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuZ2V0U3RhdHMoKTtcbiAgfVxuXG4gIGdldFR0bChrZXk6IHN0cmluZyk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuZ2V0VHRsKGtleSk7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=