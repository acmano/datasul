b83bf7c232fa721af2a65a95860a720f
"use strict";
// src/infrastructure/database/connections/OdbcConnection.ts
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.OdbcConnection = void 0;
const odbc_1 = __importDefault(require("odbc"));
const logger_1 = require("@shared/utils/logger");
const retry_1 = require("@shared/utils/retry");
const env_config_1 = require("@config/env.config");
class OdbcConnection {
    constructor(connectionString, name = 'ODBC') {
        this.connection = null;
        this.connectionString = connectionString;
        this.name = name;
    }
    async connect() {
        const context = `${this.name} (ODBC)`;
        logger_1.log.info(`Conectando ${context}...`);
        // ✅ NOVO: Retry com backoff exponencial
        const retryOptions = {
            maxAttempts: env_config_1.config.database.retry.maxAttempts,
            initialDelay: env_config_1.config.database.retry.initialDelay,
            maxDelay: env_config_1.config.database.retry.maxDelay,
            backoffFactor: env_config_1.config.database.retry.backoffFactor,
            jitter: true,
            onRetry: (error, attempt, delay) => {
                // Só retry em erros de conexão
                if (!(0, retry_1.isRetryableError)(error)) {
                    logger_1.log.error(`${context}: Erro não-retryable, abortando`, {
                        error: error.message,
                        attempt,
                    });
                    throw error;
                }
            },
        };
        try {
            this.connection = await (0, retry_1.retryWithBackoff)(async () => {
                const conn = await odbc_1.default.connect(this.connectionString);
                return conn;
            }, retryOptions, context);
            logger_1.log.info(`${context} conectado`);
        }
        catch (error) {
            logger_1.log.error(`${context}: Falha após todas as tentativas de retry`, {
                error: error instanceof Error ? error.message : 'Erro desconhecido',
                maxAttempts: retryOptions.maxAttempts,
            });
            throw error;
        }
    }
    async query(sql) {
        if (!this.connection) {
            throw new Error(`${this.name}: Conexão não inicializada`);
        }
        try {
            const result = await this.connection.query(sql);
            return result;
        }
        catch (error) {
            logger_1.log.error(`${this.name}: Erro na query`, {
                error: error instanceof Error ? error.message : 'Erro desconhecido',
                sql: sql.substring(0, 100),
            });
            throw error;
        }
    }
    async queryWithParams(sql, params) {
        if (!this.connection) {
            throw new Error(`${this.name}: Conexão não inicializada`);
        }
        try {
            // ODBC usa '?' como placeholder
            const values = params.map(p => p.value);
            const result = await this.connection.query(sql, values);
            return result;
        }
        catch (error) {
            logger_1.log.error(`${this.name}: Erro na query parametrizada`, {
                error: error instanceof Error ? error.message : 'Erro desconhecido',
                params: params.map(p => ({ name: p.name, type: p.type })),
            });
            throw error;
        }
    }
    async close() {
        if (this.connection) {
            await this.connection.close();
            this.connection = null;
            logger_1.log.info(`${this.name} desconectado`);
        }
    }
    isConnected() {
        return this.connection !== null;
    }
    async healthCheck() {
        const startTime = Date.now();
        try {
            if (!this.connection) {
                return { connected: false, responseTime: 0 };
            }
            await this.connection.query('SELECT 1 AS health');
            const responseTime = Date.now() - startTime;
            return { connected: true, responseTime };
        }
        catch (error) {
            logger_1.log.error(`${this.name}: Health check falhou`, {
                error: error instanceof Error ? error.message : 'Erro desconhecido',
            });
            return { connected: false, responseTime: Date.now() - startTime };
        }
    }
}
exports.OdbcConnection = OdbcConnection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL2Nvbm5lY3Rpb25zL09kYmNDb25uZWN0aW9uLnRzIiwibWFwcGluZ3MiOiI7QUFBQSw0REFBNEQ7Ozs7OztBQUU1RCxnREFBd0I7QUFFeEIsaURBQTJDO0FBQzNDLCtDQUF5RTtBQUN6RSxtREFBNEM7QUFFNUMsTUFBYSxjQUFjO0lBS3pCLFlBQVksZ0JBQXdCLEVBQUUsT0FBZSxNQUFNO1FBSm5ELGVBQVUsR0FBMkIsSUFBSSxDQUFDO1FBS2hELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNuQixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxNQUFNLE9BQU8sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLFNBQVMsQ0FBQztRQUV0QyxZQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsT0FBTyxLQUFLLENBQUMsQ0FBQztRQUVyQyx3Q0FBd0M7UUFDeEMsTUFBTSxZQUFZLEdBQUc7WUFDbkIsV0FBVyxFQUFFLG1CQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxXQUFXO1lBQzlDLFlBQVksRUFBRSxtQkFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsWUFBWTtZQUNoRCxRQUFRLEVBQUUsbUJBQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFFBQVE7WUFDeEMsYUFBYSxFQUFFLG1CQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxhQUFhO1lBQ2xELE1BQU0sRUFBRSxJQUFJO1lBQ1osT0FBTyxFQUFFLENBQUMsS0FBWSxFQUFFLE9BQWUsRUFBRSxLQUFhLEVBQUUsRUFBRTtnQkFDeEQsK0JBQStCO2dCQUMvQixJQUFJLENBQUMsSUFBQSx3QkFBZ0IsRUFBQyxLQUFLLENBQUMsRUFBRSxDQUFDO29CQUM3QixZQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsT0FBTyxpQ0FBaUMs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Q0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLG1CQUFtQjthQUNwRSxDQUFDLENBQUM7WUFDSCxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFDO1FBQ3BFLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF6SEQsd0NBeUhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL21hbm8vcHJvamV0b3MvZGF0YXN1bC9sb3IwMTM4L3NyYy9pbmZyYXN0cnVjdHVyZS9kYXRhYmFzZS9jb25uZWN0aW9ucy9PZGJjQ29ubmVjdGlvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvY29ubmVjdGlvbnMvT2RiY0Nvbm5lY3Rpb24udHNcclxuXHJcbmltcG9ydCBvZGJjIGZyb20gJ29kYmMnO1xyXG5pbXBvcnQgeyBJQ29ubmVjdGlvbiwgUXVlcnlQYXJhbWV0ZXIgfSBmcm9tICcuLi90eXBlcyc7XHJcbmltcG9ydCB7IGxvZyB9IGZyb20gJ0BzaGFyZWQvdXRpbHMvbG9nZ2VyJztcclxuaW1wb3J0IHsgcmV0cnlXaXRoQmFja29mZiwgaXNSZXRyeWFibGVFcnJvciB9IGZyb20gJ0BzaGFyZWQvdXRpbHMvcmV0cnknO1xyXG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICdAY29uZmlnL2Vudi5jb25maWcnO1xyXG5cclxuZXhwb3J0IGNsYXNzIE9kYmNDb25uZWN0aW9uIGltcGxlbWVudHMgSUNvbm5lY3Rpb24ge1xyXG4gIHByaXZhdGUgY29ubmVjdGlvbjogb2RiYy5Db25uZWN0aW9uIHwgbnVsbCA9IG51bGw7XHJcbiAgcHJpdmF0ZSBjb25uZWN0aW9uU3RyaW5nOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBuYW1lOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmc6IHN0cmluZywgbmFtZTogc3RyaW5nID0gJ09EQkMnKSB7XHJcbiAgICB0aGlzLmNvbm5lY3Rpb25TdHJpbmcgPSBjb25uZWN0aW9uU3RyaW5nO1xyXG4gICAgdGhpcy5uYW1lID0gbmFtZTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGNvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBjb250ZXh0ID0gYCR7dGhpcy5uYW1lfSAoT0RCQylgO1xyXG4gICAgXHJcbiAgICBsb2cuaW5mbyhgQ29uZWN0YW5kbyAke2NvbnRleHR9Li4uYCk7XHJcblxyXG4gICAgLy8g4pyFIE5PVk86IFJldHJ5IGNvbSBiYWNrb2ZmIGV4cG9uZW5jaWFsXHJcbiAgICBjb25zdCByZXRyeU9wdGlvbnMgPSB7XHJcbiAgICAgIG1heEF0dGVtcHRzOiBjb25maWcuZGF0YWJhc2UucmV0cnkubWF4QXR0ZW1wdHMsXHJcbiAgICAgIGluaXRpYWxEZWxheTogY29uZmlnLmRhdGFiYXNlLnJldHJ5LmluaXRpYWxEZWxheSxcclxuICAgICAgbWF4RGVsYXk6IGNvbmZpZy5kYXRhYmFzZS5yZXRyeS5tYXhEZWxheSxcclxuICAgICAgYmFja29mZkZhY3RvcjogY29uZmlnLmRhdGFiYXNlLnJldHJ5LmJhY2tvZmZGYWN0b3IsXHJcbiAgICAgIGppdHRlcjogdHJ1ZSxcclxuICAgICAgb25SZXRyeTogKGVycm9yOiBFcnJvciwgYXR0ZW1wdDogbnVtYmVyLCBkZWxheTogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgLy8gU8OzIHJldHJ5IGVtIGVycm9zIGRlIGNvbmV4w6NvXHJcbiAgICAgICAgaWYgKCFpc1JldHJ5YWJsZUVycm9yKGVycm9yKSkge1xyXG4gICAgICAgICAgbG9nLmVycm9yKGAke2NvbnRleHR9OiBFcnJvIG7Do28tcmV0cnlhYmxlLCBhYm9ydGFuZG9gLCB7XHJcbiAgICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICAgICAgICBhdHRlbXB0LFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIHRoaXMuY29ubmVjdGlvbiA9IGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoXHJcbiAgICAgICAgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgY29ubiA9IGF3YWl0IG9kYmMuY29ubmVjdCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcpO1xyXG4gICAgICAgICAgcmV0dXJuIGNvbm47XHJcbiAgICAgICAgfSxcclxuICAgICAgICByZXRyeU9wdGlvbnMsXHJcbiAgICAgICAgY29udGV4dFxyXG4gICAgICApO1xyXG5cclxuICAgICAgbG9nLmluZm8oYCR7Y29udGV4dH0gY29uZWN0YWRvYCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2cuZXJyb3IoYCR7Y29udGV4dH06IEZhbGhhIGFww7NzIHRvZGFzIGFzIHRlbnRhdGl2YXMgZGUgcmV0cnlgLCB7XHJcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ0Vycm8gZGVzY29uaGVjaWRvJyxcclxuICAgICAgICBtYXhBdHRlbXB0czogcmV0cnlPcHRpb25zLm1heEF0dGVtcHRzLFxyXG4gICAgICB9KTtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBxdWVyeShzcWw6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dGhpcy5uYW1lfTogQ29uZXjDo28gbsOjbyBpbmljaWFsaXphZGFgKTtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb24ucXVlcnkoc3FsKTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9OiBFcnJvIG5hIHF1ZXJ5YCwge1xyXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdFcnJvIGRlc2NvbmhlY2lkbycsXHJcbiAgICAgICAgc3FsOiBzcWwuc3Vic3RyaW5nKDAsIDEwMCksXHJcbiAgICAgIH0pO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHF1ZXJ5V2l0aFBhcmFtcyhzcWw6IHN0cmluZywgcGFyYW1zOiBRdWVyeVBhcmFtZXRlcltdKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLm5hbWV9OiBDb25leMOjbyBuw6NvIGluaWNpYWxpemFkYWApO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIE9EQkMgdXNhICc/JyBjb21vIHBsYWNlaG9sZGVyXHJcbiAgICAgIGNvbnN0IHZhbHVlcyA9IHBhcmFtcy5tYXAocCA9PiBwLnZhbHVlKTtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jb25uZWN0aW9uLnF1ZXJ5KHNxbCwgdmFsdWVzKTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9OiBFcnJvIG5hIHF1ZXJ5IHBhcmFtZXRyaXphZGFgLCB7XHJcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ0Vycm8gZGVzY29uaGVjaWRvJyxcclxuICAgICAgICBwYXJhbXM6IHBhcmFtcy5tYXAocCA9PiAoeyBuYW1lOiBwLm5hbWUsIHR5cGU6IHAudHlwZSB9KSksXHJcbiAgICAgIH0pO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgaWYgKHRoaXMuY29ubmVjdGlvbikge1xyXG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3Rpb24uY2xvc2UoKTtcclxuICAgICAgdGhpcy5jb25uZWN0aW9uID0gbnVsbDtcclxuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBkZXNjb25lY3RhZG9gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlzQ29ubmVjdGVkKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbiAhPT0gbnVsbDtcclxuICB9XHJcblxyXG4gIGFzeW5jIGhlYWx0aENoZWNrKCk6IFByb21pc2U8eyBjb25uZWN0ZWQ6IGJvb2xlYW47IHJlc3BvbnNlVGltZTogbnVtYmVyIH0+IHtcclxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24pIHtcclxuICAgICAgICByZXR1cm4geyBjb25uZWN0ZWQ6IGZhbHNlLCByZXNwb25zZVRpbWU6IDAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0aW9uLnF1ZXJ5KCdTRUxFQ1QgMSBBUyBoZWFsdGgnKTtcclxuICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcclxuXHJcbiAgICAgIHJldHVybiB7IGNvbm5lY3RlZDogdHJ1ZSwgcmVzcG9uc2VUaW1lIH07XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfTogSGVhbHRoIGNoZWNrIGZhbGhvdWAsIHtcclxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnRXJybyBkZXNjb25oZWNpZG8nLFxyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIHsgY29ubmVjdGVkOiBmYWxzZSwgcmVzcG9uc2VUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lIH07XHJcbiAgICB9XHJcbiAgfVxyXG59Il0sInZlcnNpb24iOjN9