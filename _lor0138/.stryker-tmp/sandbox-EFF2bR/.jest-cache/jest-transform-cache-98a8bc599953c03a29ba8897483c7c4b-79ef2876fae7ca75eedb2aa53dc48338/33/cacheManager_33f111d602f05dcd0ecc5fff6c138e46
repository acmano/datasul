c39067dc329b9ea29b82544d0d8b99f6
"use strict";
// src/shared/utils/cacheManager.ts
// ✅ VERSÃO ATUALIZADA: Suporta Memory, Redis e Layered (L1+L2)
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheManager = void 0;
exports.generateCacheKey = generateCacheKey;
exports.Cacheable = Cacheable;
const MemoryCacheAdapter_1 = require("./cache/MemoryCacheAdapter");
const RedisCacheAdapter_1 = require("./cache/RedisCacheAdapter");
const LayeredCacheAdapter_1 = require("./cache/LayeredCacheAdapter");
const logger_1 = require("./logger");
/**
 * Gerenciador de cache com suporte a múltiplos backends
 * - Memory: Cache local (padrão)
 * - Redis: Cache compartilhado
 * - Layered: L1 (memory) + L2 (Redis)
 */
class CacheManager {
    /**
     * Inicializa o cache com a estratégia escolhida
     */
    static initialize(strategy) {
        this.enabled = process.env.CACHE_ENABLED !== 'false';
        this.strategy = strategy || process.env.CACHE_STRATEGY || 'memory';
        if (!this.enabled) {
            logger_1.log.warn('❌ Cache desabilitado (CACHE_ENABLED=false)');
            return;
        }
        const ttl = parseInt(process.env.CACHE_DEFAULT_TTL || '300', 10);
        try {
            switch (this.strategy) {
                case 'layered':
                    this.initializeLayered(ttl);
                    break;
                case 'redis':
                    this.initializeRedis(ttl);
                    break;
                case 'memory':
                default:
                    this.initializeMemory(ttl);
                    break;
            }
            logger_1.log.info('✅ Cache inicializado', {
                strategy: this.strategy,
                enabled: this.enabled,
                ttl
            });
        }
        catch (error) {
            logger_1.log.error('❌ Erro ao inicializar cache', { strategy: this.strategy, error });
            // Fallback para memória em caso de erro
            this.initializeMemory(ttl);
        }
    }
    static initializeMemory(ttl) {
        this.adapter = new MemoryCacheAdapter_1.MemoryCacheAdapter(ttl, 'Cache-Memory');
        this.strategy = 'memory';
    }
    static initializeRedis(ttl) {
        const redisUrl = process.env.CACHE_REDIS_URL || 'redis://lor0138.lorenzetti.ibe:6379';
        this.adapter = new RedisCacheAdapter_1.RedisCacheAdapter(redisUrl, 'Cache-Redis');
        this.strategy = 'redis';
    }
    static initializeLayered(ttl) {
        const redisUrl = process.env.CACHE_REDIS_URL || 'redis://lor0138.lorenzetti.ibe:6379';
        const l1 = new MemoryCacheAdapter_1.MemoryCacheAdapter(ttl, 'L1-Memory');
        const l2 = new RedisCacheAdapter_1.RedisCacheAdapter(redisUrl, 'L2-Redis');
        this.adapter = new LayeredCacheAdapter_1.LayeredCacheAdapter(l1, l2, 'Cache-Layered');
        this.strategy = 'layered';
    }
    /**
     * Retorna instância singleton (compatibilidade)
     */
    static getInstance() {
        if (!this.adapter) {
            this.initialize();
        }
        return this;
    }
    /**
     * Busca valor no cache
     */
    static async get(key) {
        if (!this.enabled || !this.adapter) {
            return undefined;
        }
        try {
            return await this.adapter.get(key);
        }
        catch (error) {
            logger_1.log.error('Cache GET error', { key, error });
            return undefined;
        }
    }
    /**
     * Armazena valor no cache
     */
    static async set(key, value, ttl) {
        if (!this.enabled || !this.adapter) {
            return false;
        }
        try {
            return await this.adapter.set(key, value, ttl);
        }
        catch (error) {
            logger_1.log.error('Cache SET error', { key, error });
            return false;
        }
    }
    /**
     * Remove valor do cache
     */
    static async delete(key) {
        if (!this.enabled || !this.adapter) {
            return 0;
        }
        try {
            return await this.adapter.delete(key);
        }
        catch (error) {
            logger_1.log.error('Cache DELETE error', { key, error });
            return 0;
        }
    }
    /**
     * Limpa todo o cache
     */
    static async flush() {
        if (!this.enabled || !this.adapter) {
            return;
        }
        try {
            await this.adapter.flush();
            logger_1.log.info('Cache limpo completamente');
        }
        catch (error) {
            logger_1.log.error('Cache FLUSH error', { error });
        }
    }
    /**
     * Lista chaves em cache
     */
    static async keys(pattern) {
        if (!this.enabled || !this.adapter) {
            return [];
        }
        try {
            return await this.adapter.keys(pattern);
        }
        catch (error) {
            logger_1.log.error('Cache KEYS error', { pattern, error });
            return [];
        }
    }
    /**
     * Invalida chaves por padrão (wildcards)
     */
    static async invalidate(pattern) {
        if (!this.enabled || !this.adapter) {
            return 0;
        }
        try {
            const keys = await this.adapter.keys(pattern);
            if (keys.length === 0) {
                logger_1.log.debug('Nenhuma chave encontrada para invalidar', { pattern });
                return 0;
            }
            const deletePromises = keys.map(key => this.adapter.delete(key));
            const results = await Promise.all(deletePromises);
            const total = results.reduce((sum, count) => sum + count, 0);
            logger_1.log.info('Cache invalidado', { pattern, keys: total });
            return total;
        }
        catch (error) {
            logger_1.log.error('Cache INVALIDATE error', { pattern, error });
            return 0;
        }
    }
    /**
     * Cache-aside pattern: busca ou executa função
     */
    static async getOrSet(key, fetchFn, ttl) {
        // Tenta buscar do cache
        const cached = await this.get(key);
        if (cached !== undefined) {
            return cached;
        }
        // Executa função para buscar dados
        const value = await fetchFn();
        // Armazena no cache
        await this.set(key, value, ttl);
        return value;
    }
    /**
     * Verifica se cache está pronto
     */
    static async isReady() {
        if (!this.enabled || !this.adapter) {
            return false;
        }
        try {
            return await this.adapter.isReady();
        }
        catch (error) {
            logger_1.log.error('Cache isReady error', { error });
            return false;
        }
    }
    /**
     * Retorna estatísticas do cache
     */
    static getStats() {
        if (!this.enabled || !this.adapter) {
            return {
                enabled: false,
                strategy: 'none'
            };
        }
        // LayeredCacheAdapter tem método getStats()
        if (this.adapter instanceof LayeredCacheAdapter_1.LayeredCacheAdapter) {
            return {
                enabled: true,
                strategy: this.strategy,
                ...this.adapter.getStats()
            };
        }
        // MemoryCacheAdapter tem método getStats()
        if (this.adapter instanceof MemoryCacheAdapter_1.MemoryCacheAdapter) {
            return {
                enabled: true,
                strategy: this.strategy,
                ...this.adapter.getStats()
            };
        }
        return {
            enabled: true,
            strategy: this.strategy
        };
    }
    /**
     * Fecha conexões (chamado no graceful shutdown)
     */
    static async close() {
        if (!this.adapter) {
            return;
        }
        try {
            await this.adapter.close();
            logger_1.log.info('Cache fechado');
        }
        catch (error) {
            logger_1.log.error('Cache CLOSE error', { error });
        }
    }
}
exports.CacheManager = CacheManager;
CacheManager.strategy = 'memory';
CacheManager.enabled = true;
/**
 * Gera chave de cache consistente
 */
function generateCacheKey(...parts) {
    return parts.filter(p => p !== undefined && p !== null).join(':');
}
/**
 * Decorator para cachear métodos de classe
 * @example
 * class MyService {
 *   @Cacheable({ ttl: 600, keyPrefix: 'service' })
 *   async getData(id: string) { ... }
 * }
 */
function Cacheable(options = {}) {
    return function (target, propertyKey, descriptor) {
        const originalMethod = descriptor.value;
        descriptor.value = async function (...args) {
            const keyPrefix = options.keyPrefix || target.constructor.name;
            const cacheKey = generateCacheKey(keyPrefix, propertyKey, ...args);
            return CacheManager.getOrSet(cacheKey, () => originalMethod.apply(this, args), options.ttl);
        };
        return descriptor;
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC91dGlscy9jYWNoZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLG1DQUFtQztBQUNuQywrREFBK0Q7OztBQXVTL0QsNENBRUM7QUFVRCw4QkFxQkM7QUFyVUQsbUVBQWdFO0FBQ2hFLGlFQUE4RDtBQUM5RCxxRUFBa0U7QUFDbEUscUNBQStCO0FBRy9COzs7OztHQUtHO0FBQ0gsTUFBYSxZQUFZO0lBS3ZCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFpQjtRQUNqQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxLQUFLLE9BQU8sQ0FBQztRQUNyRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxRQUFRLENBQUM7UUFFbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNsQixZQUFHLENBQUMsSUFBSSxDQUFDLDRDQUE0QyxDQUFDLENBQUM7WUFDdkQsT0FBTztRQUNULENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDO1lBQ0gsUUFBUSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLEtBQUssU0FBUztvQkFDWixJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzVCLE1BQU07Z0JBRVIsS0FBSyxPQUFPO29CQUNWLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzFCLE1BQU07Z0JBRVIsS0FBSyxRQUFRLENBQUM7Z0JBQ2Q7b0JBQ0UsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMzQixNQUFNO1lBQ1YsQ0FBQztZQUVELFlBQUcsQ0FB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QUFDLEdBQUcsQ0FDWixDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9tYW5vL3Byb2pldG9zL2RhdGFzdWwvbG9yMDEzOC9zcmMvc2hhcmVkL3V0aWxzL2NhY2hlTWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2hhcmVkL3V0aWxzL2NhY2hlTWFuYWdlci50c1xuLy8g4pyFIFZFUlPDg08gQVRVQUxJWkFEQTogU3Vwb3J0YSBNZW1vcnksIFJlZGlzIGUgTGF5ZXJlZCAoTDErTDIpXG5cbmltcG9ydCB7IENhY2hlQWRhcHRlciB9IGZyb20gJy4vY2FjaGUvQ2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IE1lbW9yeUNhY2hlQWRhcHRlciB9IGZyb20gJy4vY2FjaGUvTWVtb3J5Q2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IFJlZGlzQ2FjaGVBZGFwdGVyIH0gZnJvbSAnLi9jYWNoZS9SZWRpc0NhY2hlQWRhcHRlcic7XG5pbXBvcnQgeyBMYXllcmVkQ2FjaGVBZGFwdGVyIH0gZnJvbSAnLi9jYWNoZS9MYXllcmVkQ2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGFwcENvbmZpZyB9IGZyb20gJ0Bjb25maWcvYXBwLmNvbmZpZyc7XG5cbi8qKlxuICogR2VyZW5jaWFkb3IgZGUgY2FjaGUgY29tIHN1cG9ydGUgYSBtw7psdGlwbG9zIGJhY2tlbmRzXG4gKiAtIE1lbW9yeTogQ2FjaGUgbG9jYWwgKHBhZHLDo28pXG4gKiAtIFJlZGlzOiBDYWNoZSBjb21wYXJ0aWxoYWRvXG4gKiAtIExheWVyZWQ6IEwxIChtZW1vcnkpICsgTDIgKFJlZGlzKVxuICovXG5leHBvcnQgY2xhc3MgQ2FjaGVNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgYWRhcHRlcjogQ2FjaGVBZGFwdGVyO1xuICBwcml2YXRlIHN0YXRpYyBzdHJhdGVneTogc3RyaW5nID0gJ21lbW9yeSc7XG4gIHByaXZhdGUgc3RhdGljIGVuYWJsZWQ6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIC8qKlxuICAgKiBJbmljaWFsaXphIG8gY2FjaGUgY29tIGEgZXN0cmF0w6lnaWEgZXNjb2xoaWRhXG4gICAqL1xuICBzdGF0aWMgaW5pdGlhbGl6ZShzdHJhdGVneT86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuZW5hYmxlZCA9IHByb2Nlc3MuZW52LkNBQ0hFX0VOQUJMRUQgIT09ICdmYWxzZSc7XG4gICAgdGhpcy5zdHJhdGVneSA9IHN0cmF0ZWd5IHx8IHByb2Nlc3MuZW52LkNBQ0hFX1NUUkFURUdZIHx8ICdtZW1vcnknO1xuXG4gICAgaWYgKCF0aGlzLmVuYWJsZWQpIHtcbiAgICAgIGxvZy53YXJuKCfinYwgQ2FjaGUgZGVzYWJpbGl0YWRvIChDQUNIRV9FTkFCTEVEPWZhbHNlKScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHR0bCA9IHBhcnNlSW50KHByb2Nlc3MuZW52LkNBQ0hFX0RFRkFVTFRfVFRMIHx8ICczMDAnLCAxMCk7XG5cbiAgICB0cnkge1xuICAgICAgc3dpdGNoICh0aGlzLnN0cmF0ZWd5KSB7XG4gICAgICAgIGNhc2UgJ2xheWVyZWQnOlxuICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZUxheWVyZWQodHRsKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdyZWRpcyc6XG4gICAgICAgICAgdGhpcy5pbml0aWFsaXplUmVkaXModHRsKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdtZW1vcnknOlxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZU1lbW9yeSh0dGwpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBsb2cuaW5mbygn4pyFIENhY2hlIGluaWNpYWxpemFkbycsIHtcbiAgICAgICAgc3RyYXRlZ3k6IHRoaXMuc3RyYXRlZ3ksXG4gICAgICAgIGVuYWJsZWQ6IHRoaXMuZW5hYmxlZCxcbiAgICAgICAgdHRsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCfinYwgRXJybyBhbyBpbmljaWFsaXphciBjYWNoZScsIHsgc3RyYXRlZ3k6IHRoaXMuc3RyYXRlZ3ksIGVycm9yIH0pO1xuICAgICAgLy8gRmFsbGJhY2sgcGFyYSBtZW3Ds3JpYSBlbSBjYXNvIGRlIGVycm9cbiAgICAgIHRoaXMuaW5pdGlhbGl6ZU1lbW9yeSh0dGwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVNZW1vcnkodHRsOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmFkYXB0ZXIgPSBuZXcgTWVtb3J5Q2FjaGVBZGFwdGVyKHR0bCwgJ0NhY2hlLU1lbW9yeScpO1xuICAgIHRoaXMuc3RyYXRlZ3kgPSAnbWVtb3J5JztcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVSZWRpcyh0dGw6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHJlZGlzVXJsID0gcHJvY2Vzcy5lbnYuQ0FDSEVfUkVESVNfVVJMIHx8ICdyZWRpczovL2xvcjAxMzgubG9yZW56ZXR0aS5pYmU6NjM3OSc7XG4gICAgdGhpcy5hZGFwdGVyID0gbmV3IFJlZGlzQ2FjaGVBZGFwdGVyKHJlZGlzVXJsLCAnQ2FjaGUtUmVkaXMnKTtcbiAgICB0aGlzLnN0cmF0ZWd5ID0gJ3JlZGlzJztcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVMYXllcmVkKHR0bDogbnVtYmVyKTogdm9pZCB7XG4gICAgY29uc3QgcmVkaXNVcmwgPSBwcm9jZXNzLmVudi5DQUNIRV9SRURJU19VUkwgfHwgJ3JlZGlzOi8vbG9yMDEzOC5sb3JlbnpldHRpLmliZTo2Mzc5JztcblxuICAgIGNvbnN0IGwxID0gbmV3IE1lbW9yeUNhY2hlQWRhcHRlcih0dGwsICdMMS1NZW1vcnknKTtcbiAgICBjb25zdCBsMiA9IG5ldyBSZWRpc0NhY2hlQWRhcHRlcihyZWRpc1VybCwgJ0wyLVJlZGlzJyk7XG5cbiAgICB0aGlzLmFkYXB0ZXIgPSBuZXcgTGF5ZXJlZENhY2hlQWRhcHRlcihsMSwgbDIsICdDYWNoZS1MYXllcmVkJyk7XG4gICAgdGhpcy5zdHJhdGVneSA9ICdsYXllcmVkJztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIGluc3TDom5jaWEgc2luZ2xldG9uIChjb21wYXRpYmlsaWRhZGUpXG4gICAqL1xuICBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogQ2FjaGVNYW5hZ2VyIHtcbiAgICBpZiAoIXRoaXMuYWRhcHRlcikge1xuICAgICAgdGhpcy5pbml0aWFsaXplKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1c2NhIHZhbG9yIG5vIGNhY2hlXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0PFQ+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYWRhcHRlci5nZXQ8VD4oa2V5KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCdDYWNoZSBHRVQgZXJyb3InLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBcm1hemVuYSB2YWxvciBubyBjYWNoZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHNldDxUPihrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bD86IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmICghdGhpcy5lbmFibGVkIHx8ICF0aGlzLmFkYXB0ZXIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYWRhcHRlci5zZXQoa2V5LCB2YWx1ZSwgdHRsKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCdDYWNoZSBTRVQgZXJyb3InLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB2YWxvciBkbyBjYWNoZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGRlbGV0ZShrZXk6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmFkYXB0ZXIuZGVsZXRlKGtleSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcignQ2FjaGUgREVMRVRFIGVycm9yJywgeyBrZXksIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpbXBhIHRvZG8gbyBjYWNoZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGZsdXNoKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5lbmFibGVkIHx8ICF0aGlzLmFkYXB0ZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZGFwdGVyLmZsdXNoKCk7XG4gICAgICBsb2cuaW5mbygnQ2FjaGUgbGltcG8gY29tcGxldGFtZW50ZScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NhY2hlIEZMVVNIIGVycm9yJywgeyBlcnJvciB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlzdGEgY2hhdmVzIGVtIGNhY2hlXG4gICAqL1xuICBzdGF0aWMgYXN5bmMga2V5cyhwYXR0ZXJuPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICghdGhpcy5lbmFibGVkIHx8ICF0aGlzLmFkYXB0ZXIpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYWRhcHRlci5rZXlzKHBhdHRlcm4pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoJ0NhY2hlIEtFWVMgZXJyb3InLCB7IHBhdHRlcm4sIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYSBjaGF2ZXMgcG9yIHBhZHLDo28gKHdpbGRjYXJkcylcbiAgICovXG4gIHN0YXRpYyBhc3luYyBpbnZhbGlkYXRlKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGtleXMgPSBhd2FpdCB0aGlzLmFkYXB0ZXIua2V5cyhwYXR0ZXJuKTtcblxuICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnTmVuaHVtYSBjaGF2ZSBlbmNvbnRyYWRhIHBhcmEgaW52YWxpZGFyJywgeyBwYXR0ZXJuIH0pO1xuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGVsZXRlUHJvbWlzZXMgPSBrZXlzLm1hcChrZXkgPT4gdGhpcy5hZGFwdGVyLmRlbGV0ZShrZXkpKTtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChkZWxldGVQcm9taXNlcyk7XG4gICAgICBjb25zdCB0b3RhbCA9IHJlc3VsdHMucmVkdWNlKChzdW0sIGNvdW50KSA9PiBzdW0gKyBjb3VudCwgMCk7XG5cbiAgICAgIGxvZy5pbmZvKCdDYWNoZSBpbnZhbGlkYWRvJywgeyBwYXR0ZXJuLCBrZXlzOiB0b3RhbCB9KTtcbiAgICAgIHJldHVybiB0b3RhbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCdDYWNoZSBJTlZBTElEQVRFIGVycm9yJywgeyBwYXR0ZXJuLCBlcnJvciB9KTtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYWNoZS1hc2lkZSBwYXR0ZXJuOiBidXNjYSBvdSBleGVjdXRhIGZ1bsOnw6NvXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0T3JTZXQ8VD4oXG4gICAga2V5OiBzdHJpbmcsXG4gICAgZmV0Y2hGbjogKCkgPT4gUHJvbWlzZTxUPixcbiAgICB0dGw/OiBudW1iZXJcbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgLy8gVGVudGEgYnVzY2FyIGRvIGNhY2hlXG4gICAgY29uc3QgY2FjaGVkID0gYXdhaXQgdGhpcy5nZXQ8VD4oa2V5KTtcbiAgICBpZiAoY2FjaGVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuXG4gICAgLy8gRXhlY3V0YSBmdW7Dp8OjbyBwYXJhIGJ1c2NhciBkYWRvc1xuICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgZmV0Y2hGbigpO1xuXG4gICAgLy8gQXJtYXplbmEgbm8gY2FjaGVcbiAgICBhd2FpdCB0aGlzLnNldChrZXksIHZhbHVlLCB0dGwpO1xuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWNhIHNlIGNhY2hlIGVzdMOhIHByb250b1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIGlzUmVhZHkoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZGFwdGVyLmlzUmVhZHkoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKCdDYWNoZSBpc1JlYWR5IGVycm9yJywgeyBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0b3JuYSBlc3RhdMOtc3RpY2FzIGRvIGNhY2hlXG4gICAqL1xuICBzdGF0aWMgZ2V0U3RhdHMoKTogYW55IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhdGhpcy5hZGFwdGVyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlbmFibGVkOiBmYWxzZSxcbiAgICAgICAgc3RyYXRlZ3k6ICdub25lJ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBMYXllcmVkQ2FjaGVBZGFwdGVyIHRlbSBtw6l0b2RvIGdldFN0YXRzKClcbiAgICBpZiAodGhpcy5hZGFwdGVyIGluc3RhbmNlb2YgTGF5ZXJlZENhY2hlQWRhcHRlcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgc3RyYXRlZ3k6IHRoaXMuc3RyYXRlZ3ksXG4gICAgICAgIC4uLnRoaXMuYWRhcHRlci5nZXRTdGF0cygpXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIE1lbW9yeUNhY2hlQWRhcHRlciB0ZW0gbcOpdG9kbyBnZXRTdGF0cygpXG4gICAgaWYgKHRoaXMuYWRhcHRlciBpbnN0YW5jZW9mIE1lbW9yeUNhY2hlQWRhcHRlcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgc3RyYXRlZ3k6IHRoaXMuc3RyYXRlZ3ksXG4gICAgICAgIC4uLnRoaXMuYWRhcHRlci5nZXRTdGF0cygpXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgc3RyYXRlZ3k6IHRoaXMuc3RyYXRlZ3lcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEZlY2hhIGNvbmV4w7VlcyAoY2hhbWFkbyBubyBncmFjZWZ1bCBzaHV0ZG93bilcbiAgICovXG4gIHN0YXRpYyBhc3luYyBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuYWRhcHRlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYXB0ZXIuY2xvc2UoKTtcbiAgICAgIGxvZy5pbmZvKCdDYWNoZSBmZWNoYWRvJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcignQ2FjaGUgQ0xPU0UgZXJyb3InLCB7IGVycm9yIH0pO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEdlcmEgY2hhdmUgZGUgY2FjaGUgY29uc2lzdGVudGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlQ2FjaGVLZXkoLi4ucGFydHM6IChzdHJpbmcgfCBudW1iZXIpW10pOiBzdHJpbmcge1xuICByZXR1cm4gcGFydHMuZmlsdGVyKHAgPT4gcCAhPT0gdW5kZWZpbmVkICYmIHAgIT09IG51bGwpLmpvaW4oJzonKTtcbn1cblxuLyoqXG4gKiBEZWNvcmF0b3IgcGFyYSBjYWNoZWFyIG3DqXRvZG9zIGRlIGNsYXNzZVxuICogQGV4YW1wbGVcbiAqIGNsYXNzIE15U2VydmljZSB7XG4gKiAgIEBDYWNoZWFibGUoeyB0dGw6IDYwMCwga2V5UHJlZml4OiAnc2VydmljZScgfSlcbiAqICAgYXN5bmMgZ2V0RGF0YShpZDogc3RyaW5nKSB7IC4uLiB9XG4gKiB9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBDYWNoZWFibGUob3B0aW9uczogeyB0dGw/OiBudW1iZXI7IGtleVByZWZpeD86IHN0cmluZyB9ID0ge30pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChcbiAgICB0YXJnZXQ6IGFueSxcbiAgICBwcm9wZXJ0eUtleTogc3RyaW5nLFxuICAgIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvclxuICApIHtcbiAgICBjb25zdCBvcmlnaW5hbE1ldGhvZCA9IGRlc2NyaXB0b3IudmFsdWU7XG5cbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gYXN5bmMgZnVuY3Rpb24gKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICBjb25zdCBrZXlQcmVmaXggPSBvcHRpb25zLmtleVByZWZpeCB8fCB0YXJnZXQuY29uc3RydWN0b3IubmFtZTtcbiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gZ2VuZXJhdGVDYWNoZUtleShrZXlQcmVmaXgsIHByb3BlcnR5S2V5LCAuLi5hcmdzKTtcblxuICAgICAgcmV0dXJuIENhY2hlTWFuYWdlci5nZXRPclNldChcbiAgICAgICAgY2FjaGVLZXksXG4gICAgICAgICgpID0+IG9yaWdpbmFsTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpLFxuICAgICAgICBvcHRpb25zLnR0bFxuICAgICAgKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59Il0sInZlcnNpb24iOjN9