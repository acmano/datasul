1b2efd52d55803ae975f27c1ca3434d9
"use strict";
// @ts-nocheck
// src/shared/utils/cache/LayeredCacheAdapter.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.LayeredCacheAdapter = void 0;
const logger_1 = require("../logger");
/**
 * Adaptador de cache em camadas (L1 + L2)
 *
 * Estrat√©gia:
 * 1. GET: Busca L1 ‚Üí L2 ‚Üí Banco (promove L2‚ÜíL1 em hit)
 * 2. SET: Armazena L1 + L2 simultaneamente
 * 3. DELETE: Remove de L1 + L2
 *
 * Benef√≠cios:
 * - Performance m√°xima (L1 mem√≥ria)
 * - Compartilhamento entre servidores (L2 Redis)
 * - Redund√¢ncia (fallback L1‚ÜîL2)
 */
class LayeredCacheAdapter {
    constructor(l1, l2, name = 'Layered') {
        // Estat√≠sticas
        this.stats = {
            l1Hits: 0,
            l1Misses: 0,
            l2Hits: 0,
            l2Misses: 0,
            totalHits: 0,
            totalMisses: 0
        };
        this.l1 = l1;
        this.l2 = l2;
        this.name = name;
        logger_1.log.info(`${this.name} cache inicializado (L1 + L2)`);
    }
    async get(key) {
        try {
            // 1Ô∏è‚É£ Tenta L1 (mem√≥ria)
            const l1Value = await this.l1.get(key);
            if (l1Value !== undefined) {
                this.stats.l1Hits++;
                this.stats.totalHits++;
                logger_1.log.debug(`${this.name} L1 HIT`, { key });
                return l1Value;
            }
            this.stats.l1Misses++;
            // 2Ô∏è‚É£ Tenta L2 (Redis)
            const l2Value = await this.l2.get(key);
            if (l2Value !== undefined) {
                this.stats.l2Hits++;
                this.stats.totalHits++;
                logger_1.log.debug(`${this.name} L2 HIT`, { key });
                // üîº PROMOVE para L1 (pr√≥xima leitura ser√° mais r√°pida)
                await this.l1.set(key, l2Value).catch(err => {
                    logger_1.log.warn(`${this.name} falha ao promover para L1`, { key, error: err });
                });
                return l2Value;
            }
            this.stats.l2Misses++;
            this.stats.totalMisses++;
            logger_1.log.debug(`${this.name} MISS (L1 e L2)`, { key });
            return undefined;
        }
        catch (error) {
            logger_1.log.error(`${this.name} GET error`, { key, error });
            return undefined;
        }
    }
    async set(key, value, ttl) {
        try {
            // Armazena em AMBAS as camadas simultaneamente
            const [l1Success, l2Success] = await Promise.allSettled([
                this.l1.set(key, value, ttl),
                this.l2.set(key, value, ttl)
            ]);
            const l1Ok = l1Success.status === 'fulfilled' && l1Success.value;
            const l2Ok = l2Success.status === 'fulfilled' && l2Success.value;
            if (!l1Ok) {
                logger_1.log.warn(`${this.name} falha L1 SET`, { key });
            }
            if (!l2Ok) {
                logger_1.log.warn(`${this.name} falha L2 SET`, { key });
            }
            logger_1.log.debug(`${this.name} SET`, {
                key,
                ttl,
                l1: l1Ok ? 'OK' : 'FAIL',
                l2: l2Ok ? 'OK' : 'FAIL'
            });
            // Considera sucesso se pelo menos uma camada funcionou
            return l1Ok || l2Ok;
        }
        catch (error) {
            logger_1.log.error(`${this.name} SET error`, { key, error });
            return false;
        }
    }
    async delete(key) {
        try {
            // Remove de AMBAS as camadas
            const [l1Deleted, l2Deleted] = await Promise.allSettled([
                this.l1.delete(key),
                this.l2.delete(key)
            ]);
            const l1Count = l1Deleted.status === 'fulfilled' ? l1Deleted.value : 0;
            const l2Count = l2Deleted.status === 'fulfilled' ? l2Deleted.value : 0;
            const total = l1Count + l2Count;
            logger_1.log.debug(`${this.name} DELETE`, {
                key,
                l1: l1Count,
                l2: l2Count,
                total
            });
            return total;
        }
        catch (error) {
            logger_1.log.error(`${this.name} DELETE error`, { key, error });
            return 0;
        }
    }
    async flush() {
        try {
            // Limpa AMBAS as camadas
            await Promise.allSettled([
                this.l1.flush(),
                this.l2.flush()
            ]);
            logger_1.log.info(`${this.name} FLUSH ALL (L1 + L2)`);
            // Reseta estat√≠sticas
            this.stats = {
                l1Hits: 0,
                l1Misses: 0,
                l2Hits: 0,
                l2Misses: 0,
                totalHits: 0,
                totalMisses: 0
            };
        }
        catch (error) {
            logger_1.log.error(`${this.name} FLUSH error`, { error });
        }
    }
    async keys(pattern) {
        try {
            // Retorna UNI√ÉO de L1 + L2 (sem duplicatas)
            const [l1Keys, l2Keys] = await Promise.allSettled([
                this.l1.keys(pattern),
                this.l2.keys(pattern)
            ]);
            const l1List = l1Keys.status === 'fulfilled' ? l1Keys.value : [];
            const l2List = l2Keys.status === 'fulfilled' ? l2Keys.value : [];
            // Remove duplicatas
            const uniqueKeys = [...new Set([...l1List, ...l2List])];
            logger_1.log.debug(`${this.name} KEYS`, {
                pattern,
                l1: l1List.length,
                l2: l2List.length,
                total: uniqueKeys.length
            });
            return uniqueKeys;
        }
        catch (error) {
            logger_1.log.error(`${this.name} KEYS error`, { pattern, error });
            return [];
        }
    }
    async isReady() {
        try {
            const [l1Ready, l2Ready] = await Promise.all([
                this.l1.isReady(),
                this.l2.isReady()
            ]);
            // Considera pronto se pelo menos L1 estiver OK
            return l1Ready;
        }
        catch (error) {
            logger_1.log.error(`${this.name} isReady error`, { error });
            return false;
        }
    }
    async close() {
        try {
            await Promise.allSettled([
                this.l1.close(),
                this.l2.close()
            ]);
            logger_1.log.info(`${this.name} fechado (L1 + L2)`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} CLOSE error`, { error });
        }
    }
    /**
     * Retorna estat√≠sticas do cache em camadas
     */
    getStats() {
        const l1HitRate = this.stats.l1Hits + this.stats.l1Misses > 0
            ? (this.stats.l1Hits / (this.stats.l1Hits + this.stats.l1Misses)) * 100
            : 0;
        const l2HitRate = this.stats.l2Hits + this.stats.l2Misses > 0
            ? (this.stats.l2Hits / (this.stats.l2Hits + this.stats.l2Misses)) * 100
            : 0;
        const totalHitRate = this.stats.totalHits + this.stats.totalMisses > 0
            ? (this.stats.totalHits / (this.stats.totalHits + this.stats.totalMisses)) * 100
            : 0;
        return {
            l1: {
                hits: this.stats.l1Hits,
                misses: this.stats.l1Misses,
                hitRate: l1HitRate.toFixed(2) + '%'
            },
            l2: {
                hits: this.stats.l2Hits,
                misses: this.stats.l2Misses,
                hitRate: l2HitRate.toFixed(2) + '%'
            },
            total: {
                hits: this.stats.totalHits,
                misses: this.stats.totalMisses,
                hitRate: totalHitRate.toFixed(2) + '%'
            }
        };
    }
    /**
     * Reseta estat√≠sticas
     */
    resetStats() {
        this.stats = {
            l1Hits: 0,
            l1Misses: 0,
            l2Hits: 0,
            l2Misses: 0,
            totalHits: 0,
            totalMisses: 0
        };
        logger_1.log.info(`${this.name} estat√≠sticas resetadas`);
    }
}
exports.LayeredCacheAdapter = LayeredCacheAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvLnN0cnlrZXItdG1wL3NhbmRib3gtRVM1cWNML3NyYy9zaGFyZWQvdXRpbHMvY2FjaGUvTGF5ZXJlZENhY2hlQWRhcHRlci50cyIsIm1hcHBpbmdzIjoiO0FBQUEsY0FBYztBQUNkLGdEQUFnRDs7O0FBR2hELHNDQUFnQztBQUVoQzs7Ozs7Ozs7Ozs7O0dBWUc7QUFDSCxNQUFhLG1CQUFtQjtJQWU5QixZQUFZLEVBQWdCLEVBQUUsRUFBZ0IsRUFBRSxPQUFlLFNBQVM7UUFWeEUsZUFBZTtRQUNQLFVBQUssR0FBRztZQUNkLE1BQU0sRUFBRSxDQUFDO1lBQ1QsUUFBUSxFQUFFLENBQUM7WUFDWCxNQUFNLEVBQUUsQ0FBQztZQUNULFFBQVEsRUFBRSxDQUFDO1lBQ1gsU0FBUyxFQUFFLENBQUM7WUFDWixXQUFXLEVBQUUsQ0FBQztTQUNmLENBQUM7UUFHQSxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFFakIsWUFBRyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLCtCQUErQixDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQUksR0FBVztRQUN0QixJQUFJLENBQUM7WUFDSCx5QkFBeUI7WUFDekIsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBSSxHQUFHLENBQUMsQ0FBQztZQUUxQyxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDdkIsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLFNBQVMsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQzFDLE9BQU8sT0FBTyxDQUFDO1lBQ2pCLENBQUM7WUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRXRCLHVCQUF1QjtZQUN2QixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFJLEdBQUcsQ0FBQyxDQUFDO1lBRTFDLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUN2QixZQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFFMUMsd0RBQXdEO2dCQUN4RCxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQzFDLFlBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSw0QkFBNEIsRUFBRSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDMUUsQ0FBQyxDQUFDLENBQUM7Z0JBRUgsT0FBTyxPQUFPLENBQUM7WUFDakIsQ0FBQztZQUVELElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN6QixZQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksaUJBQWlCLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBRWxELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLFlBQVksRUFBRSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3BELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLEdBQUcsQ0FBSSxHQUFXLEVBQUUsS0FBUSxFQUFFLEdBQVk7UUFDOUMsSUFBSSxDQUFDO1lBQ0gsK0NBQStDO1lBQy9DLE1BQU0sQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDO2dCQUN0RCxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUM7YUFDN0IsQ0FBQyxDQUFDO1lBRUgsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLE1BQU0sS0FBSyxXQUFXLElBQUksU0FBUyxDQUFDLEtBQUssQ0FBQztZQUNqRSxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsTUFBTSxLQUFLLFdBQVcsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDO1lBRWpFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDVixZQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNqRCxDQUFDO1lBQ0QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNWLFlBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxlQUFlLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2pELENBQUM7WUFFRCxZQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksTUFBTSxFQUFFO2dCQUM1QixHQUFHO2dCQUNILEdBQUc7Z0JBQ0gsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNO2dCQUN4QixFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU07YUFDekIsQ0FBQyxDQUFDO1lBRUgsdURBQXVEO1lBQ3ZELE9BQU8sSUFBSSxJQUFJLElBQUksQ0FBQztRQUN0QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLFlBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxZQUFZLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNwRCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFXO1FBQ3RCLElBQUksQ0FBQztZQUNILDZCQUE2QjtZQUM3QixNQUFNLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLFVBQVUsQ0FBQztnQkFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUNuQixJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7YUFDcEIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLE1BQU0sS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2RSxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsTUFBTSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXZFLE1BQU0sS0FBSyxHQUFHLE9BQU8sR0FBRyxPQUFPLENBQUM7WUFFaEMsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLFNBQVMsRUFBRTtnQkFDL0IsR0FBRztnQkFDSCxFQUFFLEVBQUUsT0FBTztnQkFDWCxFQUFFLEVBQUUsT0FBTztnQkFDWCxLQUFLO2FBQ04sQ0FBQyxDQUFDO1lBRUgsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLFlBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxlQUFlLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUN2RCxPQUFPLENBQUMsQ0FBQztRQUNYLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDVCxJQUFJLENBQUM7WUFDSCx5QkFBeUI7WUFDekIsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDO2dCQUN2QixJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRTtnQkFDZixJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRTthQUNoQixDQUFDLENBQUM7WUFFSCxZQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksc0JBQXNCLENBQUMsQ0FBQztZQUU3QyxzQkFBc0I7WUFDdEIsSUFBSSxDQUFDLEtBQUssR0FBRztnQkFDWCxNQUFNLEVBQUUsQ0FBQztnQkFDVCxRQUFRLEVBQUUsQ0FBQztnQkFDWCxNQUFNLEVBQUUsQ0FBQztnQkFDVCxRQUFRLEVBQUUsQ0FBQztnQkFDWCxTQUFTLEVBQUUsQ0FBQztnQkFDWixXQUFXLEVBQUUsQ0FBQzthQUNmLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLFlBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxjQUFjLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFnQjtRQUN6QixJQUFJLENBQUM7WUFDSCw0Q0FBNEM7WUFDNUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUM7Z0JBQ2hELElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDckIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO2FBQ3RCLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDakUsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUVqRSxvQkFBb0I7WUFDcEIsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFeEQsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLE9BQU8sRUFBRTtnQkFDN0IsT0FBTztnQkFDUCxFQUFFLEVBQUUsTUFBTSxDQUFDLE1BQU07Z0JBQ2pCLEVBQUUsRUFBRSxNQUFNLENBQUMsTUFBTTtnQkFDakIsS0FBSyxFQUFFLFVBQVUsQ0FBQyxNQUFNO2FBQ3pCLENBQUMsQ0FBQztZQUVILE9BQU8sVUFBVSxDQUFDO1FBQ3BCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGFBQWEsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3pELE9BQU8sRUFBRSxDQUFDO1FBQ1osQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNYLElBQUksQ0FBQztZQUNILE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO2dCQUMzQyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRTtnQkFDakIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUU7YUFDbEIsQ0FBQyxDQUFDO1lBRUgsK0NBQStDO1lBQy9DLE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGdCQUFnQixFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNuRCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDVCxJQUFJLENBQUM7WUFDSCxNQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUM7Z0JBQ3ZCLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO2dCQUNmLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO2FBQ2hCLENBQUMsQ0FBQztZQUVILFlBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxvQkFBb0IsQ0FBQyxDQUFDO1FBQzdDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsWUFBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGNBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDbkQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILFFBQVE7UUFDTixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxDQUFDO1lBQzNELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLEdBQUc7WUFDdkUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVOLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLENBQUM7WUFDM0QsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsR0FBRztZQUN2RSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRU4sTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEdBQUcsQ0FBQztZQUNwRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxHQUFHO1lBQ2hGLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFTixPQUFPO1lBQ0wsRUFBRSxFQUFFO2dCQUNGLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU07Z0JBQ3ZCLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVE7Z0JBQzNCLE9BQU8sRUFBRSxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUc7YUFDcEM7WUFDRCxFQUFFLEVBQUU7Z0JBQ0YsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTtnQkFDdkIsTUFBTSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUTtnQkFDM0IsT0FBTyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRzthQUNwQztZQUNELEtBQUssRUFBRTtnQkFDTCxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO2dCQUMxQixNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXO2dCQUM5QixPQUFPLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHO2FBQ3ZDO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVU7UUFDUixJQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1gsTUFBTSxFQUFFLENBQUM7WUFDVCxRQUFRLEVBQUUsQ0FBQztZQUNYLE1BQU0sRUFBRSxDQUFDO1lBQ1QsUUFBUSxFQUFFLENBQUM7WUFDWCxTQUFTLEVBQUUsQ0FBQztZQUNaLFdBQVcsRUFBRSxDQUFDO1NBQ2YsQ0FBQztRQUVGLFlBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSx5QkFBeUIsQ0FBQyxDQUFDO0lBQ2xELENBQUM7Q0FDRjtBQTlQRCxrREE4UEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvLnN0cnlrZXItdG1wL3NhbmRib3gtRVM1cWNML3NyYy9zaGFyZWQvdXRpbHMvY2FjaGUvTGF5ZXJlZENhY2hlQWRhcHRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtbm9jaGVja1xuLy8gc3JjL3NoYXJlZC91dGlscy9jYWNoZS9MYXllcmVkQ2FjaGVBZGFwdGVyLnRzXG5cbmltcG9ydCB7IENhY2hlQWRhcHRlciB9IGZyb20gJy4vQ2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4uL2xvZ2dlcic7XG5cbi8qKlxuICogQWRhcHRhZG9yIGRlIGNhY2hlIGVtIGNhbWFkYXMgKEwxICsgTDIpXG4gKiBcbiAqIEVzdHJhdMOpZ2lhOlxuICogMS4gR0VUOiBCdXNjYSBMMSDihpIgTDIg4oaSIEJhbmNvIChwcm9tb3ZlIEwy4oaSTDEgZW0gaGl0KVxuICogMi4gU0VUOiBBcm1hemVuYSBMMSArIEwyIHNpbXVsdGFuZWFtZW50ZVxuICogMy4gREVMRVRFOiBSZW1vdmUgZGUgTDEgKyBMMlxuICogXG4gKiBCZW5lZsOtY2lvczpcbiAqIC0gUGVyZm9ybWFuY2UgbcOheGltYSAoTDEgbWVtw7NyaWEpXG4gKiAtIENvbXBhcnRpbGhhbWVudG8gZW50cmUgc2Vydmlkb3JlcyAoTDIgUmVkaXMpXG4gKiAtIFJlZHVuZMOibmNpYSAoZmFsbGJhY2sgTDHihpRMMilcbiAqL1xuZXhwb3J0IGNsYXNzIExheWVyZWRDYWNoZUFkYXB0ZXIgaW1wbGVtZW50cyBDYWNoZUFkYXB0ZXIge1xuICBwcml2YXRlIGwxOiBDYWNoZUFkYXB0ZXI7IC8vIE1lbcOzcmlhIChyw6FwaWRvLCBsb2NhbClcbiAgcHJpdmF0ZSBsMjogQ2FjaGVBZGFwdGVyOyAvLyBSZWRpcyAoY29tcGFydGlsaGFkbywgcGVyc2lzdGVudGUpXG4gIHByaXZhdGUgbmFtZTogc3RyaW5nO1xuXG4gIC8vIEVzdGF0w61zdGljYXNcbiAgcHJpdmF0ZSBzdGF0cyA9IHtcbiAgICBsMUhpdHM6IDAsXG4gICAgbDFNaXNzZXM6IDAsXG4gICAgbDJIaXRzOiAwLFxuICAgIGwyTWlzc2VzOiAwLFxuICAgIHRvdGFsSGl0czogMCxcbiAgICB0b3RhbE1pc3NlczogMFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKGwxOiBDYWNoZUFkYXB0ZXIsIGwyOiBDYWNoZUFkYXB0ZXIsIG5hbWU6IHN0cmluZyA9ICdMYXllcmVkJykge1xuICAgIHRoaXMubDEgPSBsMTtcbiAgICB0aGlzLmwyID0gbDI7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcblxuICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gY2FjaGUgaW5pY2lhbGl6YWRvIChMMSArIEwyKWApO1xuICB9XG5cbiAgYXN5bmMgZ2V0PFQ+KGtleTogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIDHvuI/ig6MgVGVudGEgTDEgKG1lbcOzcmlhKVxuICAgICAgY29uc3QgbDFWYWx1ZSA9IGF3YWl0IHRoaXMubDEuZ2V0PFQ+KGtleSk7XG4gICAgICBcbiAgICAgIGlmIChsMVZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5zdGF0cy5sMUhpdHMrKztcbiAgICAgICAgdGhpcy5zdGF0cy50b3RhbEhpdHMrKztcbiAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gTDEgSElUYCwgeyBrZXkgfSk7XG4gICAgICAgIHJldHVybiBsMVZhbHVlO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnN0YXRzLmwxTWlzc2VzKys7XG5cbiAgICAgIC8vIDLvuI/ig6MgVGVudGEgTDIgKFJlZGlzKVxuICAgICAgY29uc3QgbDJWYWx1ZSA9IGF3YWl0IHRoaXMubDIuZ2V0PFQ+KGtleSk7XG5cbiAgICAgIGlmIChsMlZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5zdGF0cy5sMkhpdHMrKztcbiAgICAgICAgdGhpcy5zdGF0cy50b3RhbEhpdHMrKztcbiAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gTDIgSElUYCwgeyBrZXkgfSk7XG5cbiAgICAgICAgLy8g8J+UvCBQUk9NT1ZFIHBhcmEgTDEgKHByw7N4aW1hIGxlaXR1cmEgc2Vyw6EgbWFpcyByw6FwaWRhKVxuICAgICAgICBhd2FpdCB0aGlzLmwxLnNldChrZXksIGwyVmFsdWUpLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBmYWxoYSBhbyBwcm9tb3ZlciBwYXJhIEwxYCwgeyBrZXksIGVycm9yOiBlcnIgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBsMlZhbHVlO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnN0YXRzLmwyTWlzc2VzKys7XG4gICAgICB0aGlzLnN0YXRzLnRvdGFsTWlzc2VzKys7XG4gICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBNSVNTIChMMSBlIEwyKWAsIHsga2V5IH0pO1xuXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBHRVQgZXJyb3JgLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldDxUPihrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bD86IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBBcm1hemVuYSBlbSBBTUJBUyBhcyBjYW1hZGFzIHNpbXVsdGFuZWFtZW50ZVxuICAgICAgY29uc3QgW2wxU3VjY2VzcywgbDJTdWNjZXNzXSA9IGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbXG4gICAgICAgIHRoaXMubDEuc2V0KGtleSwgdmFsdWUsIHR0bCksXG4gICAgICAgIHRoaXMubDIuc2V0KGtleSwgdmFsdWUsIHR0bClcbiAgICAgIF0pO1xuXG4gICAgICBjb25zdCBsMU9rID0gbDFTdWNjZXNzLnN0YXR1cyA9PT0gJ2Z1bGZpbGxlZCcgJiYgbDFTdWNjZXNzLnZhbHVlO1xuICAgICAgY29uc3QgbDJPayA9IGwyU3VjY2Vzcy5zdGF0dXMgPT09ICdmdWxmaWxsZWQnICYmIGwyU3VjY2Vzcy52YWx1ZTtcblxuICAgICAgaWYgKCFsMU9rKSB7XG4gICAgICAgIGxvZy53YXJuKGAke3RoaXMubmFtZX0gZmFsaGEgTDEgU0VUYCwgeyBrZXkgfSk7XG4gICAgICB9XG4gICAgICBpZiAoIWwyT2spIHtcbiAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBmYWxoYSBMMiBTRVRgLCB7IGtleSB9KTtcbiAgICAgIH1cblxuICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gU0VUYCwgeyBcbiAgICAgICAga2V5LCBcbiAgICAgICAgdHRsLCBcbiAgICAgICAgbDE6IGwxT2sgPyAnT0snIDogJ0ZBSUwnLCBcbiAgICAgICAgbDI6IGwyT2sgPyAnT0snIDogJ0ZBSUwnIFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENvbnNpZGVyYSBzdWNlc3NvIHNlIHBlbG8gbWVub3MgdW1hIGNhbWFkYSBmdW5jaW9ub3VcbiAgICAgIHJldHVybiBsMU9rIHx8IGwyT2s7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IFNFVCBlcnJvcmAsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBSZW1vdmUgZGUgQU1CQVMgYXMgY2FtYWRhc1xuICAgICAgY29uc3QgW2wxRGVsZXRlZCwgbDJEZWxldGVkXSA9IGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbXG4gICAgICAgIHRoaXMubDEuZGVsZXRlKGtleSksXG4gICAgICAgIHRoaXMubDIuZGVsZXRlKGtleSlcbiAgICAgIF0pO1xuXG4gICAgICBjb25zdCBsMUNvdW50ID0gbDFEZWxldGVkLnN0YXR1cyA9PT0gJ2Z1bGZpbGxlZCcgPyBsMURlbGV0ZWQudmFsdWUgOiAwO1xuICAgICAgY29uc3QgbDJDb3VudCA9IGwyRGVsZXRlZC5zdGF0dXMgPT09ICdmdWxmaWxsZWQnID8gbDJEZWxldGVkLnZhbHVlIDogMDtcblxuICAgICAgY29uc3QgdG90YWwgPSBsMUNvdW50ICsgbDJDb3VudDtcblxuICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gREVMRVRFYCwgeyBcbiAgICAgICAga2V5LCBcbiAgICAgICAgbDE6IGwxQ291bnQsIFxuICAgICAgICBsMjogbDJDb3VudCwgXG4gICAgICAgIHRvdGFsIFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB0b3RhbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gREVMRVRFIGVycm9yYCwgeyBrZXksIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmx1c2goKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIExpbXBhIEFNQkFTIGFzIGNhbWFkYXNcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbXG4gICAgICAgIHRoaXMubDEuZmx1c2goKSxcbiAgICAgICAgdGhpcy5sMi5mbHVzaCgpXG4gICAgICBdKTtcblxuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBGTFVTSCBBTEwgKEwxICsgTDIpYCk7XG5cbiAgICAgIC8vIFJlc2V0YSBlc3RhdMOtc3RpY2FzXG4gICAgICB0aGlzLnN0YXRzID0ge1xuICAgICAgICBsMUhpdHM6IDAsXG4gICAgICAgIGwxTWlzc2VzOiAwLFxuICAgICAgICBsMkhpdHM6IDAsXG4gICAgICAgIGwyTWlzc2VzOiAwLFxuICAgICAgICB0b3RhbEhpdHM6IDAsXG4gICAgICAgIHRvdGFsTWlzc2VzOiAwXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBGTFVTSCBlcnJvcmAsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMga2V5cyhwYXR0ZXJuPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBSZXRvcm5hIFVOScODTyBkZSBMMSArIEwyIChzZW0gZHVwbGljYXRhcylcbiAgICAgIGNvbnN0IFtsMUtleXMsIGwyS2V5c10gPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoW1xuICAgICAgICB0aGlzLmwxLmtleXMocGF0dGVybiksXG4gICAgICAgIHRoaXMubDIua2V5cyhwYXR0ZXJuKVxuICAgICAgXSk7XG5cbiAgICAgIGNvbnN0IGwxTGlzdCA9IGwxS2V5cy5zdGF0dXMgPT09ICdmdWxmaWxsZWQnID8gbDFLZXlzLnZhbHVlIDogW107XG4gICAgICBjb25zdCBsMkxpc3QgPSBsMktleXMuc3RhdHVzID09PSAnZnVsZmlsbGVkJyA/IGwyS2V5cy52YWx1ZSA6IFtdO1xuXG4gICAgICAvLyBSZW1vdmUgZHVwbGljYXRhc1xuICAgICAgY29uc3QgdW5pcXVlS2V5cyA9IFsuLi5uZXcgU2V0KFsuLi5sMUxpc3QsIC4uLmwyTGlzdF0pXTtcblxuICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gS0VZU2AsIHsgXG4gICAgICAgIHBhdHRlcm4sIFxuICAgICAgICBsMTogbDFMaXN0Lmxlbmd0aCwgXG4gICAgICAgIGwyOiBsMkxpc3QubGVuZ3RoLCBcbiAgICAgICAgdG90YWw6IHVuaXF1ZUtleXMubGVuZ3RoIFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB1bmlxdWVLZXlzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBLRVlTIGVycm9yYCwgeyBwYXR0ZXJuLCBlcnJvciB9KTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpc1JlYWR5KCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBbbDFSZWFkeSwgbDJSZWFkeV0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHRoaXMubDEuaXNSZWFkeSgpLFxuICAgICAgICB0aGlzLmwyLmlzUmVhZHkoKVxuICAgICAgXSk7XG5cbiAgICAgIC8vIENvbnNpZGVyYSBwcm9udG8gc2UgcGVsbyBtZW5vcyBMMSBlc3RpdmVyIE9LXG4gICAgICByZXR1cm4gbDFSZWFkeTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gaXNSZWFkeSBlcnJvcmAsIHsgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChbXG4gICAgICAgIHRoaXMubDEuY2xvc2UoKSxcbiAgICAgICAgdGhpcy5sMi5jbG9zZSgpXG4gICAgICBdKTtcblxuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBmZWNoYWRvIChMMSArIEwyKWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBDTE9TRSBlcnJvcmAsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgZXN0YXTDrXN0aWNhcyBkbyBjYWNoZSBlbSBjYW1hZGFzXG4gICAqL1xuICBnZXRTdGF0cygpIHtcbiAgICBjb25zdCBsMUhpdFJhdGUgPSB0aGlzLnN0YXRzLmwxSGl0cyArIHRoaXMuc3RhdHMubDFNaXNzZXMgPiAwXG4gICAgICA/ICh0aGlzLnN0YXRzLmwxSGl0cyAvICh0aGlzLnN0YXRzLmwxSGl0cyArIHRoaXMuc3RhdHMubDFNaXNzZXMpKSAqIDEwMFxuICAgICAgOiAwO1xuXG4gICAgY29uc3QgbDJIaXRSYXRlID0gdGhpcy5zdGF0cy5sMkhpdHMgKyB0aGlzLnN0YXRzLmwyTWlzc2VzID4gMFxuICAgICAgPyAodGhpcy5zdGF0cy5sMkhpdHMgLyAodGhpcy5zdGF0cy5sMkhpdHMgKyB0aGlzLnN0YXRzLmwyTWlzc2VzKSkgKiAxMDBcbiAgICAgIDogMDtcblxuICAgIGNvbnN0IHRvdGFsSGl0UmF0ZSA9IHRoaXMuc3RhdHMudG90YWxIaXRzICsgdGhpcy5zdGF0cy50b3RhbE1pc3NlcyA+IDBcbiAgICAgID8gKHRoaXMuc3RhdHMudG90YWxIaXRzIC8gKHRoaXMuc3RhdHMudG90YWxIaXRzICsgdGhpcy5zdGF0cy50b3RhbE1pc3NlcykpICogMTAwXG4gICAgICA6IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbDE6IHtcbiAgICAgICAgaGl0czogdGhpcy5zdGF0cy5sMUhpdHMsXG4gICAgICAgIG1pc3NlczogdGhpcy5zdGF0cy5sMU1pc3NlcyxcbiAgICAgICAgaGl0UmF0ZTogbDFIaXRSYXRlLnRvRml4ZWQoMikgKyAnJSdcbiAgICAgIH0sXG4gICAgICBsMjoge1xuICAgICAgICBoaXRzOiB0aGlzLnN0YXRzLmwySGl0cyxcbiAgICAgICAgbWlzc2VzOiB0aGlzLnN0YXRzLmwyTWlzc2VzLFxuICAgICAgICBoaXRSYXRlOiBsMkhpdFJhdGUudG9GaXhlZCgyKSArICclJ1xuICAgICAgfSxcbiAgICAgIHRvdGFsOiB7XG4gICAgICAgIGhpdHM6IHRoaXMuc3RhdHMudG90YWxIaXRzLFxuICAgICAgICBtaXNzZXM6IHRoaXMuc3RhdHMudG90YWxNaXNzZXMsXG4gICAgICAgIGhpdFJhdGU6IHRvdGFsSGl0UmF0ZS50b0ZpeGVkKDIpICsgJyUnXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldGEgZXN0YXTDrXN0aWNhc1xuICAgKi9cbiAgcmVzZXRTdGF0cygpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXRzID0ge1xuICAgICAgbDFIaXRzOiAwLFxuICAgICAgbDFNaXNzZXM6IDAsXG4gICAgICBsMkhpdHM6IDAsXG4gICAgICBsMk1pc3NlczogMCxcbiAgICAgIHRvdGFsSGl0czogMCxcbiAgICAgIHRvdGFsTWlzc2VzOiAwXG4gICAgfTtcblxuICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gZXN0YXTDrXN0aWNhcyByZXNldGFkYXNgKTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==