6da31ad30013cdc1458c9eda34596c8b
"use strict";
// src/api/admin/routes/admin.routes.ts
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const ApiKeyService_1 = require("@shared/services/ApiKeyService");
const UserRateLimiter_1 = require("@shared/utils/UserRateLimiter");
const apiKey_types_1 = require("@shared/types/apiKey.types");
const apiKeyAuth_middleware_1 = require("@shared/middlewares/apiKeyAuth.middleware");
const errors_1 = require("@shared/errors");
const router = (0, express_1.Router)();
/**
 * @openapi
 * /admin/api-keys:
 *   get:
 *     summary: Listar todas as API Keys
 *     tags:
 *       - Admin
 *     security:
 *       - ApiKeyAuth: []
 *     responses:
 *       200:
 *         description: Lista de API Keys
 */
router.get('/api-keys', apiKeyAuth_middleware_1.apiKeyAuth, async (req, res) => {
    // Apenas admin pode listar todas as keys
    if (req.user?.tier !== apiKey_types_1.UserTier.ADMIN) {
        throw new errors_1.AuthorizationError('Apenas administradores podem listar todas as API Keys');
    }
    const stats = ApiKeyService_1.ApiKeyService.getStats();
    res.json({
        success: true,
        data: stats,
        correlationId: req.id
    });
});
/**
 * @openapi
 * /admin/api-keys/generate:
 *   post:
 *     summary: Gerar nova API Key
 *     tags:
 *       - Admin
 *     security:
 *       - ApiKeyAuth: []
 */
router.post('/api-keys/generate', apiKeyAuth_middleware_1.apiKeyAuth, async (req, res) => {
    if (req.user?.tier !== apiKey_types_1.UserTier.ADMIN) {
        throw new errors_1.AuthorizationError('Apenas administradores podem gerar API Keys');
    }
    const { userId, userName, tier, expiresInDays } = req.body;
    if (!userId || !userName || !tier) {
        const missingFields = {};
        if (!userId)
            missingFields.userId = 'Obrigatório';
        if (!userName)
            missingFields.userName = 'Obrigatório';
        if (!tier)
            missingFields.tier = 'Obrigatório';
        throw new errors_1.ValidationError('userId, userName e tier são obrigatórios', missingFields);
    }
    const apiKey = await ApiKeyService_1.ApiKeyService.generateKey(userId, userName, tier, expiresInDays);
    res.json({
        success: true,
        data: {
            apiKey,
            userId,
            userName,
            tier,
            expiresInDays
        },
        correlationId: req.id
    });
});
/**
 * @openapi
 * /admin/api-keys/{apiKey}/revoke:
 *   post:
 *     summary: Revogar API Key
 *     tags:
 *       - Admin
 */
router.post('/api-keys/:apiKey/revoke', apiKeyAuth_middleware_1.apiKeyAuth, async (req, res) => {
    if (req.user?.tier !== apiKey_types_1.UserTier.ADMIN) {
        throw new errors_1.AuthorizationError('Apenas administradores podem revogar API Keys');
    }
    const { apiKey } = req.params;
    const revoked = await ApiKeyService_1.ApiKeyService.revokeKey(apiKey);
    res.json({
        success: revoked,
        message: revoked ? 'API Key revogada' : 'API Key não encontrada',
        correlationId: req.id
    });
});
/**
 * @openapi
 * /admin/rate-limit/stats:
 *   get:
 *     summary: Estatísticas de rate limit
 *     tags:
 *       - Admin
 */
router.get('/rate-limit/stats', apiKeyAuth_middleware_1.apiKeyAuth, async (req, res) => {
    if (req.user?.tier !== apiKey_types_1.UserTier.ADMIN) {
        throw new errors_1.AuthorizationError('Apenas administradores podem ver estatísticas');
    }
    const userId = req.query.userId;
    const stats = UserRateLimiter_1.UserRateLimiter.getStats(userId);
    res.json({
        success: true,
        data: stats,
        correlationId: req.id
    });
});
/**
 * @openapi
 * /admin/rate-limit/reset/{userId}:
 *   post:
 *     summary: Resetar rate limit de um usuário
 *     tags:
 *       - Admin
 */
router.post('/rate-limit/reset/:userId', apiKeyAuth_middleware_1.apiKeyAuth, async (req, res) => {
    if (req.user?.tier !== apiKey_types_1.UserTier.ADMIN) {
        throw new errors_1.AuthorizationError('Apenas administradores podem resetar rate limits');
    }
    const { userId } = req.params;
    UserRateLimiter_1.UserRateLimiter.resetUser(userId);
    res.json({
        success: true,
        message: `Rate limit resetado para usuário ${userId}`,
        correlationId: req.id
    });
});
/**
 * @openapi
 * /admin/users/{userId}/tier:
 *   put:
 *     summary: Atualizar tier de um usuário
 *     tags:
 *       - Admin
 */
router.put('/users/:userId/tier', apiKeyAuth_middleware_1.apiKeyAuth, async (req, res) => {
    if (req.user?.tier !== apiKey_types_1.UserTier.ADMIN) {
        throw new errors_1.AuthorizationError('Apenas administradores podem atualizar tiers');
    }
    const { userId } = req.params;
    const { tier } = req.body;
    if (!tier || !Object.values(apiKey_types_1.UserTier).includes(tier)) {
        throw new errors_1.ValidationError('Tier inválido', {
            tier: `Deve ser: ${Object.values(apiKey_types_1.UserTier).join(', ')}`
        });
    }
    await ApiKeyService_1.ApiKeyService.updateUserTier(userId, tier);
    res.json({
        success: true,
        message: `Tier atualizado para ${tier}`,
        data: { userId, tier },
        correlationId: req.id
    });
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL2FwaS9hZG1pbi9yb3V0ZXMvYWRtaW4ucm91dGVzLnRzIiwibWFwcGluZ3MiOiI7QUFBQSx1Q0FBdUM7O0FBRXZDLHFDQUFvRDtBQUNwRCxrRUFBK0Q7QUFDL0QsbUVBQWdFO0FBQ2hFLDZEQUFzRDtBQUN0RCxxRkFBdUU7QUFDdkUsMkNBQXFFO0FBRXJFLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBRXhCOzs7Ozs7Ozs7Ozs7R0FZRztBQUNILE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLGtDQUFVLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUN4RSx5Q0FBeUM7SUFDekMsSUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyx1QkFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSwyQkFBa0IsQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFFRCxNQUFNLEtBQUssR0FBRyw2QkFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBRXZDLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDUCxPQUFPLEVBQUUsSUFBSTtRQUNiLElBQUksRUFBRSxLQUFLO1FBQ1gsYUFBYSxFQUFFLEdBQUcsQ0FBQyxFQUFFO0tBQ3RCLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUg7Ozs7Ozs7OztHQVNHO0FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxrQ0FBVSxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDbEYsSUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyx1QkFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSwyQkFBa0IsQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRCxNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEs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QUM7SUFFakQsR0FBRyxDQUFDLElBQUksQ0FBQztRQUNQLE9BQU8sRUFBRSxJQUFJO1FBQ2IsT0FBTyxFQUFFLHdCQUF3QixJQUFJLEVBQUU7UUFDdkMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtRQUN0QixhQUFhLEVBQUUsR0FBRyxDQUFDLEVBQUU7S0FDdEIsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxrQkFBZSxNQUFNLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL2FwaS9hZG1pbi9yb3V0ZXMvYWRtaW4ucm91dGVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9hcGkvYWRtaW4vcm91dGVzL2FkbWluLnJvdXRlcy50c1xuXG5pbXBvcnQgeyBSb3V0ZXIsIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBBcGlLZXlTZXJ2aWNlIH0gZnJvbSAnQHNoYXJlZC9zZXJ2aWNlcy9BcGlLZXlTZXJ2aWNlJztcbmltcG9ydCB7IFVzZXJSYXRlTGltaXRlciB9IGZyb20gJ0BzaGFyZWQvdXRpbHMvVXNlclJhdGVMaW1pdGVyJztcbmltcG9ydCB7IFVzZXJUaWVyIH0gZnJvbSAnQHNoYXJlZC90eXBlcy9hcGlLZXkudHlwZXMnO1xuaW1wb3J0IHsgYXBpS2V5QXV0aCB9IGZyb20gJ0BzaGFyZWQvbWlkZGxld2FyZXMvYXBpS2V5QXV0aC5taWRkbGV3YXJlJztcbmltcG9ydCB7IEF1dGhvcml6YXRpb25FcnJvciwgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnQHNoYXJlZC9lcnJvcnMnO1xuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxuLyoqXG4gKiBAb3BlbmFwaVxuICogL2FkbWluL2FwaS1rZXlzOlxuICogICBnZXQ6XG4gKiAgICAgc3VtbWFyeTogTGlzdGFyIHRvZGFzIGFzIEFQSSBLZXlzXG4gKiAgICAgdGFnczpcbiAqICAgICAgIC0gQWRtaW5cbiAqICAgICBzZWN1cml0eTpcbiAqICAgICAgIC0gQXBpS2V5QXV0aDogW11cbiAqICAgICByZXNwb25zZXM6XG4gKiAgICAgICAyMDA6XG4gKiAgICAgICAgIGRlc2NyaXB0aW9uOiBMaXN0YSBkZSBBUEkgS2V5c1xuICovXG5yb3V0ZXIuZ2V0KCcvYXBpLWtleXMnLCBhcGlLZXlBdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIC8vIEFwZW5hcyBhZG1pbiBwb2RlIGxpc3RhciB0b2RhcyBhcyBrZXlzXG4gIGlmIChyZXEudXNlcj8udGllciAhPT0gVXNlclRpZXIuQURNSU4pIHtcbiAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvbkVycm9yKCdBcGVuYXMgYWRtaW5pc3RyYWRvcmVzIHBvZGVtIGxpc3RhciB0b2RhcyBhcyBBUEkgS2V5cycpO1xuICB9XG5cbiAgY29uc3Qgc3RhdHMgPSBBcGlLZXlTZXJ2aWNlLmdldFN0YXRzKCk7XG4gIFxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBkYXRhOiBzdGF0cyxcbiAgICBjb3JyZWxhdGlvbklkOiByZXEuaWRcbiAgfSk7XG59KTtcblxuLyoqXG4gKiBAb3BlbmFwaVxuICogL2FkbWluL2FwaS1rZXlzL2dlbmVyYXRlOlxuICogICBwb3N0OlxuICogICAgIHN1bW1hcnk6IEdlcmFyIG5vdmEgQVBJIEtleVxuICogICAgIHRhZ3M6XG4gKiAgICAgICAtIEFkbWluXG4gKiAgICAgc2VjdXJpdHk6XG4gKiAgICAgICAtIEFwaUtleUF1dGg6IFtdXG4gKi9cbnJvdXRlci5wb3N0KCcvYXBpLWtleXMvZ2VuZXJhdGUnLCBhcGlLZXlBdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGlmIChyZXEudXNlcj8udGllciAhPT0gVXNlclRpZXIuQURNSU4pIHtcbiAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvbkVycm9yKCdBcGVuYXMgYWRtaW5pc3RyYWRvcmVzIHBvZGVtIGdlcmFyIEFQSSBLZXlzJyk7XG4gIH1cblxuICBjb25zdCB7IHVzZXJJZCwgdXNlck5hbWUsIHRpZXIsIGV4cGlyZXNJbkRheXMgfSA9IHJlcS5ib2R5O1xuXG4gIGlmICghdXNlcklkIHx8ICF1c2VyTmFtZSB8fCAhdGllcikge1xuICAgIGNvbnN0IG1pc3NpbmdGaWVsZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBpZiAoIXVzZXJJZCkgbWlzc2luZ0ZpZWxkcy51c2VySWQgPSAnT2JyaWdhdMOzcmlvJztcbiAgICBpZiAoIXVzZXJOYW1lKSBtaXNzaW5nRmllbGRzLnVzZXJOYW1lID0gJ09icmlnYXTDs3Jpbyc7XG4gICAgaWYgKCF0aWVyKSBtaXNzaW5nRmllbGRzLnRpZXIgPSAnT2JyaWdhdMOzcmlvJztcbiAgICBcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCd1c2VySWQsIHVzZXJOYW1lIGUgdGllciBzw6NvIG9icmlnYXTDs3Jpb3MnLCBtaXNzaW5nRmllbGRzKTtcbiAgfVxuXG4gIGNvbnN0IGFwaUtleSA9IGF3YWl0IEFwaUtleVNlcnZpY2UuZ2VuZXJhdGVLZXkoXG4gICAgdXNlcklkLFxuICAgIHVzZXJOYW1lLFxuICAgIHRpZXIsXG4gICAgZXhwaXJlc0luRGF5c1xuICApO1xuXG4gIHJlcy5qc29uKHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGE6IHtcbiAgICAgIGFwaUtleSxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHVzZXJOYW1lLFxuICAgICAgdGllcixcbiAgICAgIGV4cGlyZXNJbkRheXNcbiAgICB9LFxuICAgIGNvcnJlbGF0aW9uSWQ6IHJlcS5pZFxuICB9KTtcbn0pO1xuXG4vKipcbiAqIEBvcGVuYXBpXG4gKiAvYWRtaW4vYXBpLWtleXMve2FwaUtleX0vcmV2b2tlOlxuICogICBwb3N0OlxuICogICAgIHN1bW1hcnk6IFJldm9nYXIgQVBJIEtleVxuICogICAgIHRhZ3M6XG4gKiAgICAgICAtIEFkbWluXG4gKi9cbnJvdXRlci5wb3N0KCcvYXBpLWtleXMvOmFwaUtleS9yZXZva2UnLCBhcGlLZXlBdXRoLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGlmIChyZXEudXNlcj8udGllciAhPT0gVXNlclRpZXIuQURNSU4pIHtcbiAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvbkVycm9yKCdBcGVuYXMgYWRtaW5pc3RyYWRvcmVzIHBvZGVtIHJldm9nYXIgQVBJIEtleXMnKTtcbiAgfVxuXG4gIGNvbnN0IHsgYXBpS2V5IH0gPSByZXEucGFyYW1zO1xuICBjb25zdCByZXZva2VkID0gYXdhaXQgQXBpS2V5U2VydmljZS5yZXZva2VLZXkoYXBpS2V5KTtcblxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogcmV2b2tlZCxcbiAgICBtZXNzYWdlOiByZXZva2VkID8gJ0FQSSBLZXkgcmV2b2dhZGEnIDogJ0FQSSBLZXkgbsOjbyBlbmNvbnRyYWRhJyxcbiAgICBjb3JyZWxhdGlvbklkOiByZXEuaWRcbiAgfSk7XG59KTtcblxuLyoqXG4gKiBAb3BlbmFwaVxuICogL2FkbWluL3JhdGUtbGltaXQvc3RhdHM6XG4gKiAgIGdldDpcbiAqICAgICBzdW1tYXJ5OiBFc3RhdMOtc3RpY2FzIGRlIHJhdGUgbGltaXRcbiAqICAgICB0YWdzOlxuICogICAgICAgLSBBZG1pblxuICovXG5yb3V0ZXIuZ2V0KCcvcmF0ZS1saW1pdC9zdGF0cycsIGFwaUtleUF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgaWYgKHJlcS51c2VyPy50aWVyICE9PSBVc2VyVGllci5BRE1JTikge1xuICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uRXJyb3IoJ0FwZW5hcyBhZG1pbmlzdHJhZG9yZXMgcG9kZW0gdmVyIGVzdGF0w61zdGljYXMnKTtcbiAgfVxuXG4gIGNvbnN0IHVzZXJJZCA9IHJlcS5xdWVyeS51c2VySWQgYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBjb25zdCBzdGF0cyA9IFVzZXJSYXRlTGltaXRlci5nZXRTdGF0cyh1c2VySWQpO1xuXG4gIHJlcy5qc29uKHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIGRhdGE6IHN0YXRzLFxuICAgIGNvcnJlbGF0aW9uSWQ6IHJlcS5pZFxuICB9KTtcbn0pO1xuXG4vKipcbiAqIEBvcGVuYXBpXG4gKiAvYWRtaW4vcmF0ZS1saW1pdC9yZXNldC97dXNlcklkfTpcbiAqICAgcG9zdDpcbiAqICAgICBzdW1tYXJ5OiBSZXNldGFyIHJhdGUgbGltaXQgZGUgdW0gdXN1w6FyaW9cbiAqICAgICB0YWdzOlxuICogICAgICAgLSBBZG1pblxuICovXG5yb3V0ZXIucG9zdCgnL3JhdGUtbGltaXQvcmVzZXQvOnVzZXJJZCcsIGFwaUtleUF1dGgsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgaWYgKHJlcS51c2VyPy50aWVyICE9PSBVc2VyVGllci5BRE1JTikge1xuICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uRXJyb3IoJ0FwZW5hcyBhZG1pbmlzdHJhZG9yZXMgcG9kZW0gcmVzZXRhciByYXRlIGxpbWl0cycpO1xuICB9XG5cbiAgY29uc3QgeyB1c2VySWQgfSA9IHJlcS5wYXJhbXM7XG4gIFVzZXJSYXRlTGltaXRlci5yZXNldFVzZXIodXNlcklkKTtcblxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBtZXNzYWdlOiBgUmF0ZSBsaW1pdCByZXNldGFkbyBwYXJhIHVzdcOhcmlvICR7dXNlcklkfWAsXG4gICAgY29ycmVsYXRpb25JZDogcmVxLmlkXG4gIH0pO1xufSk7XG5cbi8qKlxuICogQG9wZW5hcGlcbiAqIC9hZG1pbi91c2Vycy97dXNlcklkfS90aWVyOlxuICogICBwdXQ6XG4gKiAgICAgc3VtbWFyeTogQXR1YWxpemFyIHRpZXIgZGUgdW0gdXN1w6FyaW9cbiAqICAgICB0YWdzOlxuICogICAgICAgLSBBZG1pblxuICovXG5yb3V0ZXIucHV0KCcvdXNlcnMvOnVzZXJJZC90aWVyJywgYXBpS2V5QXV0aCwgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICBpZiAocmVxLnVzZXI/LnRpZXIgIT09IFVzZXJUaWVyLkFETUlOKSB7XG4gICAgdGhyb3cgbmV3IEF1dGhvcml6YXRpb25FcnJvcignQXBlbmFzIGFkbWluaXN0cmFkb3JlcyBwb2RlbSBhdHVhbGl6YXIgdGllcnMnKTtcbiAgfVxuXG4gIGNvbnN0IHsgdXNlcklkIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCB7IHRpZXIgfSA9IHJlcS5ib2R5O1xuXG4gIGlmICghdGllciB8fCAhT2JqZWN0LnZhbHVlcyhVc2VyVGllcikuaW5jbHVkZXModGllcikpIHtcbiAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdUaWVyIGludsOhbGlkbycsIHtcbiAgICAgIHRpZXI6IGBEZXZlIHNlcjogJHtPYmplY3QudmFsdWVzKFVzZXJUaWVyKS5qb2luKCcsICcpfWBcbiAgICB9KTtcbiAgfVxuXG4gIGF3YWl0IEFwaUtleVNlcnZpY2UudXBkYXRlVXNlclRpZXIodXNlcklkLCB0aWVyKTtcblxuICByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBtZXNzYWdlOiBgVGllciBhdHVhbGl6YWRvIHBhcmEgJHt0aWVyfWAsXG4gICAgZGF0YTogeyB1c2VySWQsIHRpZXIgfSxcbiAgICBjb3JyZWxhdGlvbklkOiByZXEuaWRcbiAgfSk7XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyOyJdLCJ2ZXJzaW9uIjozfQ==