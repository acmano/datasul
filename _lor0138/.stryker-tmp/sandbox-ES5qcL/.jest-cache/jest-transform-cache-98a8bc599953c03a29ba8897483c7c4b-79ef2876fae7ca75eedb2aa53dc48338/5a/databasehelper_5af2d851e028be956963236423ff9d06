6f6bdee5aebe4fc99d1670d0ea41e6fb
"use strict";
// tests/helpers/database.helper.ts
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatabaseTestHelper = void 0;
exports.setupTestDatabase = setupTestDatabase;
exports.teardownTestDatabase = teardownTestDatabase;
exports.requiresRealDatabase = requiresRealDatabase;
const DatabaseManager_1 = require("@infrastructure/database/DatabaseManager");
const dotenv_1 = __importDefault(require("dotenv"));
const path_1 = __importDefault(require("path"));
/**
 * Helper para testes de integração com banco real
 *
 * Gerencia conexão com banco de produção de forma segura para testes
 */
class DatabaseTestHelper {
    /**
     * Inicializa conexão com banco para testes
     * Se falhar, volta para mock automaticamente
     */
    static async initialize() {
        if (this.initialized) {
            return;
        }
        // Carregar .env.test
        dotenv_1.default.config({ path: path_1.default.resolve(process.cwd(), '.env.test') });
        try {
            // Tentar conectar ao banco real
            await DatabaseManager_1.DatabaseManager.initialize();
            // Verificar se está realmente conectado
            const status = DatabaseManager_1.DatabaseManager.getConnectionStatus();
            if (status.mode === 'REAL_DATABASE') {
                this.useRealDatabase = true;
                console.log('✅ Testes usando banco REAL de produção (somente leitura)');
            }
            else {
                this.useRealDatabase = false;
                console.log('⚠️  Testes usando MOCK_DATA (banco não disponível)');
            }
            this.initialized = true;
        }
        catch (error) {
            console.error('❌ Erro ao conectar banco para testes, usando MOCK_DATA:', error);
            this.useRealDatabase = false;
            this.initialized = true;
        }
    }
    /**
     * Verifica se está usando banco real
     */
    static isUsingRealDatabase() {
        return this.useRealDatabase;
    }
    /**
     * Fecha conexões após testes
     */
    static async cleanup() {
        if (this.initialized) {
            await DatabaseManager_1.DatabaseManager.close();
            this.initialized = false;
            this.useRealDatabase = false;
        }
    }
    /**
     * Executa query no banco (ou mock)
     */
    static async query(sql, params) {
        if (!this.initialized) {
            await this.initialize();
        }
        if (params) {
            return DatabaseManager_1.DatabaseManager.queryEmpWithParams(sql, params);
        }
        else {
            return DatabaseManager_1.DatabaseManager.queryEmp(sql);
        }
    }
    /**
     * Verifica se item existe no banco
     * Útil para setup de testes
     */
    static async itemExists(itemCodigo) {
        try {
            const result = await DatabaseManager_1.DatabaseManager.queryEmpWithParams(`SELECT TOP 1 item."it-codigo" as itemCodigo
         FROM OPENQUERY(PRD_EMS2EMP, 
           'SELECT "it-codigo" FROM pub.item WHERE "it-codigo" = ''${itemCodigo}'''
         ) as item`, []);
            return result && result.length > 0;
        }
        catch (error) {
            return false;
        }
    }
    /**
     * Busca um item real do banco para usar nos testes
     * Se não achar, retorna um código mock
     */
    static async getTestItemCode() {
        // Usar código conhecido que existe em produção
        // Vimos nos logs anteriores que 7530110 funciona
        return '7530110';
    }
    /**
     * Retorna códigos de teste conhecidos
     * Para diferentes cenários
     */
    static getKnownTestCodes() {
        return {
            // Item que DEVE existir em produção
            validItem: '7530110',
            // Item que NÃO existe
            invalidItem: 'INVALID999',
            // Item para teste de caracteres especiais
            specialChars: 'ABC-123',
            // Item de 1 caractere
            singleChar: 'A',
            // Item de 16 caracteres (máximo)
            maxLength: '1234567890123456',
        };
    }
    /**
     * Aguarda o banco estar pronto
     * Útil para beforeAll em testes
     */
    static async waitUntilReady(maxWaitMs = 5000) {
        const startTime = Date.now();
        while (Date.now() - startTime < maxWaitMs) {
            if (DatabaseManager_1.DatabaseManager.isReady()) {
                return true;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        return false;
    }
    /**
     * Reseta estado do DatabaseManager (para testes isolados)
     */
    static async reset() {
        await this.cleanup();
        this.initialized = false;
        this.useRealDatabase = false;
    }
}
exports.DatabaseTestHelper = DatabaseTestHelper;
DatabaseTestHelper.initialized = false;
DatabaseTestHelper.useRealDatabase = false;
/**
 * Helper para criar conexão de teste
 */
async function setupTestDatabase() {
    await DatabaseTestHelper.initialize();
    return DatabaseTestHelper.isUsingRealDatabase();
}
/**
 * Helper para cleanup de teste
 */
async function teardownTestDatabase() {
    await DatabaseTestHelper.cleanup();
}
/**
 * Decorator para pular teste se banco não estiver disponível
 */
function requiresRealDatabase() {
    return (target, propertyKey, descriptor) => {
        const originalMethod = descriptor.value;
        descriptor.value = async function (...args) {
            if (!DatabaseTestHelper.isUsingRealDatabase()) {
                console.log(`⏭️  Pulando teste "${propertyKey}" - requer banco real`);
                return;
            }
            return originalMethod.apply(this, args);
        };
        return descriptor;
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvdGVzdHMvaGVscGVycy9kYXRhYmFzZS5oZWxwZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLG1DQUFtQzs7Ozs7O0FBdUtuQyw4Q0FHQztBQUtELG9EQUVDO0FBS0Qsb0RBZUM7QUFuTUQsOEVBQTJFO0FBQzNFLG9EQUE0QjtBQUM1QixnREFBd0I7QUFFeEI7Ozs7R0FJRztBQUVILE1BQWEsa0JBQWtCO0lBSTdCOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVTtRQUNyQixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNyQixPQUFPO1FBQ1QsQ0FBQztRQUVELHFCQUFxQjtRQUNyQixnQkFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxjQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDO1lBQ0gsZ0NBQWdDO1lBQ2hDLE1BQU0saUNBQWUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUVuQyx3Q0FBd0M7WUFDeEMsTUFBTSxNQUFNLEdBQUcsaUNBQWUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBRXJELElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxlQUFlLEVBQUUsQ0FBQztnQkFDcEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7Z0JBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsMERBQTBELENBQUMsQ0FBQztZQUMxRSxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7Z0JBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0RBQW9ELENBQUMsQ0FBQztZQUNwRSxDQUFDO1lBRUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDMUIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFD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Q0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDO0lBQy9CLENBQUM7O0FBckpILGdEQXNKQztBQXJKZ0IsOEJBQVcsR0FBRyxLQUFLLENBQUM7QUFDcEIsa0NBQWUsR0FBRyxLQUFLLENBQUM7QUFzSnpDOztHQUVHO0FBQ0ksS0FBSyxVQUFVLGlCQUFpQjtJQUNyQyxNQUFNLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3RDLE9BQU8sa0JBQWtCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztBQUNsRCxDQUFDO0FBRUQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsb0JBQW9CO0lBQ3hDLE1BQU0sa0JBQWtCLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDckMsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0Isb0JBQW9CO0lBQ2xDLE9BQU8sQ0FBQyxNQUFXLEVBQUUsV0FBbUIsRUFBRSxVQUE4QixFQUFFLEVBQUU7UUFDMUUsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUV4QyxVQUFVLENBQUMsS0FBSyxHQUFHLEtBQUssV0FBVyxHQUFHLElBQVc7WUFDL0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQixFQUFFLEVBQUUsQ0FBQztnQkFDOUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsV0FBVyx1QkFBdUIsQ0FBQyxDQUFDO2dCQUN0RSxPQUFPO1lBQ1QsQ0FBQztZQUVELE9BQU8sY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDO1FBRUYsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9tYW5vL3Byb2pldG9zL2RhdGFzdWwvbG9yMDEzOC90ZXN0cy9oZWxwZXJzL2RhdGFiYXNlLmhlbHBlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0ZXN0cy9oZWxwZXJzL2RhdGFiYXNlLmhlbHBlci50c1xuXG5pbXBvcnQgeyBEYXRhYmFzZU1hbmFnZXIgfSBmcm9tICdAaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvRGF0YWJhc2VNYW5hZ2VyJztcbmltcG9ydCBkb3RlbnYgZnJvbSAnZG90ZW52JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG4vKipcbiAqIEhlbHBlciBwYXJhIHRlc3RlcyBkZSBpbnRlZ3Jhw6fDo28gY29tIGJhbmNvIHJlYWxcbiAqIFxuICogR2VyZW5jaWEgY29uZXjDo28gY29tIGJhbmNvIGRlIHByb2R1w6fDo28gZGUgZm9ybWEgc2VndXJhIHBhcmEgdGVzdGVzXG4gKi9cblxuZXhwb3J0IGNsYXNzIERhdGFiYXNlVGVzdEhlbHBlciB7XG4gIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVkID0gZmFsc2U7XG4gIHByaXZhdGUgc3RhdGljIHVzZVJlYWxEYXRhYmFzZSA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBJbmljaWFsaXphIGNvbmV4w6NvIGNvbSBiYW5jbyBwYXJhIHRlc3Rlc1xuICAgKiBTZSBmYWxoYXIsIHZvbHRhIHBhcmEgbW9jayBhdXRvbWF0aWNhbWVudGVcbiAgICovXG4gIHN0YXRpYyBhc3luYyBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmluaXRpYWxpemVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ2FycmVnYXIgLmVudi50ZXN0XG4gICAgZG90ZW52LmNvbmZpZyh7IHBhdGg6IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLmVudi50ZXN0JykgfSk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gVGVudGFyIGNvbmVjdGFyIGFvIGJhbmNvIHJlYWxcbiAgICAgIGF3YWl0IERhdGFiYXNlTWFuYWdlci5pbml0aWFsaXplKCk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmaWNhciBzZSBlc3TDoSByZWFsbWVudGUgY29uZWN0YWRvXG4gICAgICBjb25zdCBzdGF0dXMgPSBEYXRhYmFzZU1hbmFnZXIuZ2V0Q29ubmVjdGlvblN0YXR1cygpO1xuICAgICAgXG4gICAgICBpZiAoc3RhdHVzLm1vZGUgPT09ICdSRUFMX0RBVEFCQVNFJykge1xuICAgICAgICB0aGlzLnVzZVJlYWxEYXRhYmFzZSA9IHRydWU7XG4gICAgICAgIGNvbnNvbGUubG9nKCfinIUgVGVzdGVzIHVzYW5kbyBiYW5jbyBSRUFMIGRlIHByb2R1w6fDo28gKHNvbWVudGUgbGVpdHVyYSknKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudXNlUmVhbERhdGFiYXNlID0gZmFsc2U7XG4gICAgICAgIGNvbnNvbGUubG9nKCfimqDvuI8gIFRlc3RlcyB1c2FuZG8gTU9DS19EQVRBIChiYW5jbyBuw6NvIGRpc3BvbsOtdmVsKScpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm8gYW8gY29uZWN0YXIgYmFuY28gcGFyYSB0ZXN0ZXMsIHVzYW5kbyBNT0NLX0RBVEE6JywgZXJyb3IpO1xuICAgICAgdGhpcy51c2VSZWFsRGF0YWJhc2UgPSBmYWxzZTtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBlc3TDoSB1c2FuZG8gYmFuY28gcmVhbFxuICAgKi9cbiAgc3RhdGljIGlzVXNpbmdSZWFsRGF0YWJhc2UoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudXNlUmVhbERhdGFiYXNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEZlY2hhIGNvbmV4w7VlcyBhcMOzcyB0ZXN0ZXNcbiAgICovXG4gIHN0YXRpYyBhc3luYyBjbGVhbnVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmluaXRpYWxpemVkKSB7XG4gICAgICBhd2FpdCBEYXRhYmFzZU1hbmFnZXIuY2xvc2UoKTtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMudXNlUmVhbERhdGFiYXNlID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGEgcXVlcnkgbm8gYmFuY28gKG91IG1vY2spXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgcXVlcnkoc3FsOiBzdHJpbmcsIHBhcmFtcz86IGFueVtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgIH1cblxuICAgIGlmIChwYXJhbXMpIHtcbiAgICAgIHJldHVybiBEYXRhYmFzZU1hbmFnZXIucXVlcnlFbXBXaXRoUGFyYW1zKHNxbCwgcGFyYW1zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIERhdGFiYXNlTWFuYWdlci5xdWVyeUVtcChzcWwpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmljYSBzZSBpdGVtIGV4aXN0ZSBubyBiYW5jb1xuICAgKiDDmnRpbCBwYXJhIHNldHVwIGRlIHRlc3Rlc1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIGl0ZW1FeGlzdHMoaXRlbUNvZGlnbzogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERhdGFiYXNlTWFuYWdlci5xdWVyeUVtcFdpdGhQYXJhbXMoXG4gICAgICAgIGBTRUxFQ1QgVE9QIDEgaXRlbS5cIml0LWNvZGlnb1wiIGFzIGl0ZW1Db2RpZ29cbiAgICAgICAgIEZST00gT1BFTlFVRVJZKFBSRF9FTVMyRU1QLCBcbiAgICAgICAgICAgJ1NFTEVDVCBcIml0LWNvZGlnb1wiIEZST00gcHViLml0ZW0gV0hFUkUgXCJpdC1jb2RpZ29cIiA9ICcnJHtpdGVtQ29kaWdvfScnJ1xuICAgICAgICAgKSBhcyBpdGVtYCxcbiAgICAgICAgW11cbiAgICAgICk7XG4gICAgICBcbiAgICAgIHJldHVybiByZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCA+IDA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQnVzY2EgdW0gaXRlbSByZWFsIGRvIGJhbmNvIHBhcmEgdXNhciBub3MgdGVzdGVzXG4gICAqIFNlIG7Do28gYWNoYXIsIHJldG9ybmEgdW0gY8OzZGlnbyBtb2NrXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZ2V0VGVzdEl0ZW1Db2RlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgLy8gVXNhciBjw7NkaWdvIGNvbmhlY2lkbyBxdWUgZXhpc3RlIGVtIHByb2R1w6fDo29cbiAgICAvLyBWaW1vcyBub3MgbG9ncyBhbnRlcmlvcmVzIHF1ZSA3NTMwMTEwIGZ1bmNpb25hXG4gICAgcmV0dXJuICc3NTMwMTEwJztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRvcm5hIGPDs2RpZ29zIGRlIHRlc3RlIGNvbmhlY2lkb3NcbiAgICogUGFyYSBkaWZlcmVudGVzIGNlbsOhcmlvc1xuICAgKi9cbiAgc3RhdGljIGdldEtub3duVGVzdENvZGVzKCkge1xuICAgIHJldHVybiB7XG4gICAgICAvLyBJdGVtIHF1ZSBERVZFIGV4aXN0aXIgZW0gcHJvZHXDp8Ojb1xuICAgICAgdmFsaWRJdGVtOiAnNzUzMDExMCcsXG4gICAgICBcbiAgICAgIC8vIEl0ZW0gcXVlIE7Dg08gZXhpc3RlXG4gICAgICBpbnZhbGlkSXRlbTogJ0lOVkFMSUQ5OTknLFxuICAgICAgXG4gICAgICAvLyBJdGVtIHBhcmEgdGVzdGUgZGUgY2FyYWN0ZXJlcyBlc3BlY2lhaXNcbiAgICAgIHNwZWNpYWxDaGFyczogJ0FCQy0xMjMnLFxuICAgICAgXG4gICAgICAvLyBJdGVtIGRlIDEgY2FyYWN0ZXJlXG4gICAgICBzaW5nbGVDaGFyOiAnQScsXG4gICAgICBcbiAgICAgIC8vIEl0ZW0gZGUgMTYgY2FyYWN0ZXJlcyAobcOheGltbylcbiAgICAgIG1heExlbmd0aDogJzEyMzQ1Njc4OTAxMjM0NTYnLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQWd1YXJkYSBvIGJhbmNvIGVzdGFyIHByb250b1xuICAgKiDDmnRpbCBwYXJhIGJlZm9yZUFsbCBlbSB0ZXN0ZXNcbiAgICovXG4gIHN0YXRpYyBhc3luYyB3YWl0VW50aWxSZWFkeShtYXhXYWl0TXMgPSA1MDAwKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIHdoaWxlIChEYXRlLm5vdygpIC0gc3RhcnRUaW1lIDwgbWF4V2FpdE1zKSB7XG4gICAgICBpZiAoRGF0YWJhc2VNYW5hZ2VyLmlzUmVhZHkoKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRhIGVzdGFkbyBkbyBEYXRhYmFzZU1hbmFnZXIgKHBhcmEgdGVzdGVzIGlzb2xhZG9zKVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHJlc2V0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuY2xlYW51cCgpO1xuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICB0aGlzLnVzZVJlYWxEYXRhYmFzZSA9IGZhbHNlO1xuICB9XG59XG5cbi8qKlxuICogSGVscGVyIHBhcmEgY3JpYXIgY29uZXjDo28gZGUgdGVzdGVcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNldHVwVGVzdERhdGFiYXNlKCkge1xuICBhd2FpdCBEYXRhYmFzZVRlc3RIZWxwZXIuaW5pdGlhbGl6ZSgpO1xuICByZXR1cm4gRGF0YWJhc2VUZXN0SGVscGVyLmlzVXNpbmdSZWFsRGF0YWJhc2UoKTtcbn1cblxuLyoqXG4gKiBIZWxwZXIgcGFyYSBjbGVhbnVwIGRlIHRlc3RlXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0ZWFyZG93blRlc3REYXRhYmFzZSgpIHtcbiAgYXdhaXQgRGF0YWJhc2VUZXN0SGVscGVyLmNsZWFudXAoKTtcbn1cblxuLyoqXG4gKiBEZWNvcmF0b3IgcGFyYSBwdWxhciB0ZXN0ZSBzZSBiYW5jbyBuw6NvIGVzdGl2ZXIgZGlzcG9uw612ZWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVzUmVhbERhdGFiYXNlKCkge1xuICByZXR1cm4gKHRhcmdldDogYW55LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbE1ldGhvZCA9IGRlc2NyaXB0b3IudmFsdWU7XG5cbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gYXN5bmMgZnVuY3Rpb24gKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICBpZiAoIURhdGFiYXNlVGVzdEhlbHBlci5pc1VzaW5nUmVhbERhdGFiYXNlKCkpIHtcbiAgICAgICAgY29uc29sZS5sb2coYOKPre+4jyAgUHVsYW5kbyB0ZXN0ZSBcIiR7cHJvcGVydHlLZXl9XCIgLSByZXF1ZXIgYmFuY28gcmVhbGApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBvcmlnaW5hbE1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59Il0sInZlcnNpb24iOjN9