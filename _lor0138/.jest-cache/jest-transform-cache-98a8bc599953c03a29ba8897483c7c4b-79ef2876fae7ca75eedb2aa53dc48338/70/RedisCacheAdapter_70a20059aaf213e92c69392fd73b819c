d4d2b120122fdb57b485ecc9bae5b9f9
"use strict";
// src/shared/utils/cache/RedisCacheAdapter.ts
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedisCacheAdapter = void 0;
const ioredis_1 = __importDefault(require("ioredis"));
const logger_1 = require("../logger");
/**
 * Adaptador de cache Redis (L2)
 * - Compartilhado entre múltiplas instâncias
 * - Persistente (sobrevive a restarts)
 * - Um pouco mais lento que memória (rede)
 */
class RedisCacheAdapter {
    constructor(urlOrOptions, name = 'L2-Redis') {
        this.ready = false;
        this.name = name;
        // Aceita URL ou objeto de configuração
        if (typeof urlOrOptions === 'string') {
            this.redis = new ioredis_1.default(urlOrOptions, {
                retryStrategy: (times) => {
                    const delay = Math.min(times * 50, 2000);
                    logger_1.log.warn(`${this.name} reconectando...`, { attempt: times, delay });
                    return delay;
                },
                maxRetriesPerRequest: 3,
                enableReadyCheck: true,
                lazyConnect: false
            });
        }
        else {
            this.redis = new ioredis_1.default(urlOrOptions);
        }
        this.setupEventHandlers();
    }
    setupEventHandlers() {
        this.redis.on('connect', () => {
            logger_1.log.info(`${this.name} conectando...`);
        });
        this.redis.on('ready', () => {
            this.ready = true;
            logger_1.log.info(`${this.name} pronto`, {
                host: this.redis.options.host,
                port: this.redis.options.port
            });
        });
        this.redis.on('error', (error) => {
            logger_1.log.error(`${this.name} erro`, { error: error.message });
        });
        this.redis.on('close', () => {
            this.ready = false;
            logger_1.log.warn(`${this.name} conexão fechada`);
        });
        this.redis.on('reconnecting', () => {
            logger_1.log.info(`${this.name} reconectando...`);
        });
    }
    async get(key) {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`, { key });
                return undefined;
            }
            const value = await this.redis.get(key);
            if (value) {
                logger_1.log.debug(`${this.name} HIT`, { key });
                return JSON.parse(value);
            }
            logger_1.log.debug(`${this.name} MISS`, { key });
            return undefined;
        }
        catch (error) {
            logger_1.log.error(`${this.name} GET error`, { key, error });
            return undefined;
        }
    }
    async set(key, value, ttl) {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`, { key });
                return false;
            }
            const serialized = JSON.stringify(value);
            if (ttl && ttl > 0) {
                // SETEX: Set com expiração
                await this.redis.setex(key, ttl, serialized);
            }
            else {
                // SET: Sem expiração
                await this.redis.set(key, serialized);
            }
            logger_1.log.debug(`${this.name} SET`, { key, ttl });
            return true;
        }
        catch (error) {
            logger_1.log.error(`${this.name} SET error`, { key, error });
            return false;
        }
    }
    async delete(key) {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`, { key });
                return 0;
            }
            const deleted = await this.redis.del(key);
            logger_1.log.debug(`${this.name} DELETE`, { key, deleted });
            return deleted;
        }
        catch (error) {
            logger_1.log.error(`${this.name} DELETE error`, { key, error });
            return 0;
        }
    }
    async flush() {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`);
                return;
            }
            await this.redis.flushall();
            logger_1.log.info(`${this.name} FLUSH ALL`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} FLUSH error`, { error });
        }
    }
    async keys(pattern = '*') {
        try {
            if (!this.ready) {
                logger_1.log.warn(`${this.name} não está pronto`);
                return [];
            }
            // SCAN é mais seguro que KEYS em produção
            const keys = [];
            let cursor = '0';
            do {
                const [nextCursor, foundKeys] = await this.redis.scan(cursor, 'MATCH', pattern, 'COUNT', 100);
                cursor = nextCursor;
                keys.push(...foundKeys);
            } while (cursor !== '0');
            return keys;
        }
        catch (error) {
            logger_1.log.error(`${this.name} KEYS error`, { pattern, error });
            return [];
        }
    }
    async isReady() {
        return this.ready;
    }
    async close() {
        try {
            await this.redis.quit();
            this.ready = false;
            logger_1.log.info(`${this.name} fechado`);
        }
        catch (error) {
            logger_1.log.error(`${this.name} CLOSE error`, { error });
        }
    }
    /**
     * Métodos extras específicos do Redis
     */
    async ping() {
        return this.redis.ping();
    }
    async info() {
        return this.redis.info();
    }
    getClient() {
        return this.redis;
    }
}
exports.RedisCacheAdapter = RedisCacheAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvbWFuby9wcm9qZXRvcy9kYXRhc3VsL2xvcjAxMzgvc3JjL3NoYXJlZC91dGlscy9jYWNoZS9SZWRpc0NhY2hlQWRhcHRlci50cyIsIm1hcHBpbmdzIjoiO0FBQUEsOENBQThDOzs7Ozs7QUFFOUMsc0RBQTRCO0FBRzVCLHNDQUFnQztBQUVoQzs7Ozs7R0FLRztBQUNILE1BQWEsaUJBQWlCO0lBSzVCLFlBQVksWUFBbUMsRUFBRSxPQUFlLFVBQVU7UUFGbEUsVUFBSyxHQUFZLEtBQUssQ0FBQztRQUc3QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUVqQix1Q0FBdUM7UUFDdkMsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksaUJBQUssQ0FBQyxZQUFZLEVBQUU7Z0JBQ25DLGFBQWEsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUN2QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBQ3pDLFlBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxrQkFBa0IsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztvQkFDcEUsT0FBTyxLQUFLLENBQUM7Z0JBQ2YsQ0FBQztnQkFDRCxvQkFBb0IsRUFBRSxDQUFDO2dCQUN2QixnQkFBZ0IsRUFBRSxJQUFJO2dCQUN0QixXQUFXLEVBQUUsS0FBSzthQUNuQixDQUFDLENBQUM7UUFDTCxDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxpQkFBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFFRCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRU8sa0JBQWtCO1FBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFB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QyxJQUFJLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUk7UUFDUixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVELFNBQVM7UUFDUCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBOUxELDhDQThMQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9tYW5vL3Byb2pldG9zL2RhdGFzdWwvbG9yMDEzOC9zcmMvc2hhcmVkL3V0aWxzL2NhY2hlL1JlZGlzQ2FjaGVBZGFwdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9zaGFyZWQvdXRpbHMvY2FjaGUvUmVkaXNDYWNoZUFkYXB0ZXIudHNcblxuaW1wb3J0IFJlZGlzIGZyb20gJ2lvcmVkaXMnO1xuaW1wb3J0IHR5cGUgeyBSZWRpc09wdGlvbnMgfSBmcm9tICdpb3JlZGlzJztcbmltcG9ydCB7IENhY2hlQWRhcHRlciB9IGZyb20gJy4vQ2FjaGVBZGFwdGVyJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4uL2xvZ2dlcic7XG5cbi8qKlxuICogQWRhcHRhZG9yIGRlIGNhY2hlIFJlZGlzIChMMilcbiAqIC0gQ29tcGFydGlsaGFkbyBlbnRyZSBtw7psdGlwbGFzIGluc3TDom5jaWFzXG4gKiAtIFBlcnNpc3RlbnRlIChzb2JyZXZpdmUgYSByZXN0YXJ0cylcbiAqIC0gVW0gcG91Y28gbWFpcyBsZW50byBxdWUgbWVtw7NyaWEgKHJlZGUpXG4gKi9cbmV4cG9ydCBjbGFzcyBSZWRpc0NhY2hlQWRhcHRlciBpbXBsZW1lbnRzIENhY2hlQWRhcHRlciB7XG4gIHByaXZhdGUgcmVkaXM6IFJlZGlzO1xuICBwcml2YXRlIG5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkeTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHVybE9yT3B0aW9uczogc3RyaW5nIHwgUmVkaXNPcHRpb25zLCBuYW1lOiBzdHJpbmcgPSAnTDItUmVkaXMnKSB7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcblxuICAgIC8vIEFjZWl0YSBVUkwgb3Ugb2JqZXRvIGRlIGNvbmZpZ3VyYcOnw6NvXG4gICAgaWYgKHR5cGVvZiB1cmxPck9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0aGlzLnJlZGlzID0gbmV3IFJlZGlzKHVybE9yT3B0aW9ucywge1xuICAgICAgICByZXRyeVN0cmF0ZWd5OiAodGltZXMpID0+IHtcbiAgICAgICAgICBjb25zdCBkZWxheSA9IE1hdGgubWluKHRpbWVzICogNTAsIDIwMDApO1xuICAgICAgICAgIGxvZy53YXJuKGAke3RoaXMubmFtZX0gcmVjb25lY3RhbmRvLi4uYCwgeyBhdHRlbXB0OiB0aW1lcywgZGVsYXkgfSk7XG4gICAgICAgICAgcmV0dXJuIGRlbGF5O1xuICAgICAgICB9LFxuICAgICAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdDogMyxcbiAgICAgICAgZW5hYmxlUmVhZHlDaGVjazogdHJ1ZSxcbiAgICAgICAgbGF6eUNvbm5lY3Q6IGZhbHNlXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZWRpcyA9IG5ldyBSZWRpcyh1cmxPck9wdGlvbnMpO1xuICAgIH1cblxuICAgIHRoaXMuc2V0dXBFdmVudEhhbmRsZXJzKCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwRXZlbnRIYW5kbGVycygpOiB2b2lkIHtcbiAgICB0aGlzLnJlZGlzLm9uKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBjb25lY3RhbmRvLi4uYCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlZGlzLm9uKCdyZWFkeScsICgpID0+IHtcbiAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBwcm9udG9gLCB7XG4gICAgICAgIGhvc3Q6IHRoaXMucmVkaXMub3B0aW9ucy5ob3N0LFxuICAgICAgICBwb3J0OiB0aGlzLnJlZGlzLm9wdGlvbnMucG9ydFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlZGlzLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gZXJyb2AsIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlZGlzLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgICAgIGxvZy53YXJuKGAke3RoaXMubmFtZX0gY29uZXjDo28gZmVjaGFkYWApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yZWRpcy5vbigncmVjb25uZWN0aW5nJywgKCkgPT4ge1xuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSByZWNvbmVjdGFuZG8uLi5gKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldDxUPihrZXk6IHN0cmluZyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBuw6NvIGVzdMOhIHByb250b2AsIHsga2V5IH0pO1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMucmVkaXMuZ2V0KGtleSk7XG5cbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5uYW1lfSBISVRgLCB7IGtleSB9KTtcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpIGFzIFQ7XG4gICAgICB9XG5cbiAgICAgIGxvZy5kZWJ1ZyhgJHt0aGlzLm5hbWV9IE1JU1NgLCB7IGtleSB9KTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IEdFVCBlcnJvcmAsIHsga2V5LCBlcnJvciB9KTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2V0PFQ+KGtleTogc3RyaW5nLCB2YWx1ZTogVCwgdHRsPzogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGhpcy5yZWFkeSkge1xuICAgICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IG7Do28gZXN0w6EgcHJvbnRvYCwgeyBrZXkgfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcblxuICAgICAgaWYgKHR0bCAmJiB0dGwgPiAwKSB7XG4gICAgICAgIC8vIFNFVEVYOiBTZXQgY29tIGV4cGlyYcOnw6NvXG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXMuc2V0ZXgoa2V5LCB0dGwsIHNlcmlhbGl6ZWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gU0VUOiBTZW0gZXhwaXJhw6fDo29cbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpcy5zZXQoa2V5LCBzZXJpYWxpemVkKTtcbiAgICAgIH1cblxuICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gU0VUYCwgeyBrZXksIHR0bCB9KTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBTRVQgZXJyb3JgLCB7IGtleSwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgIGxvZy53YXJuKGAke3RoaXMubmFtZX0gbsOjbyBlc3TDoSBwcm9udG9gLCB7IGtleSB9KTtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRlbGV0ZWQgPSBhd2FpdCB0aGlzLnJlZGlzLmRlbChrZXkpO1xuICAgICAgbG9nLmRlYnVnKGAke3RoaXMubmFtZX0gREVMRVRFYCwgeyBrZXksIGRlbGV0ZWQgfSk7XG4gICAgICByZXR1cm4gZGVsZXRlZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gREVMRVRFIGVycm9yYCwgeyBrZXksIGVycm9yIH0pO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmx1c2goKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGhpcy5yZWFkeSkge1xuICAgICAgICBsb2cud2FybihgJHt0aGlzLm5hbWV9IG7Do28gZXN0w6EgcHJvbnRvYCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgdGhpcy5yZWRpcy5mbHVzaGFsbCgpO1xuICAgICAgbG9nLmluZm8oYCR7dGhpcy5uYW1lfSBGTFVTSCBBTExgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gRkxVU0ggZXJyb3JgLCB7IGVycm9yIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGtleXMocGF0dGVybjogc3RyaW5nID0gJyonKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgICAgbG9nLndhcm4oYCR7dGhpcy5uYW1lfSBuw6NvIGVzdMOhIHByb250b2ApO1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9XG5cbiAgICAgIC8vIFNDQU4gw6kgbWFpcyBzZWd1cm8gcXVlIEtFWVMgZW0gcHJvZHXDp8Ojb1xuICAgICAgY29uc3Qga2V5czogc3RyaW5nW10gPSBbXTtcbiAgICAgIGxldCBjdXJzb3IgPSAnMCc7XG5cbiAgICAgIGRvIHtcbiAgICAgICAgY29uc3QgW25leHRDdXJzb3IsIGZvdW5kS2V5c10gPSBhd2FpdCB0aGlzLnJlZGlzLnNjYW4oXG4gICAgICAgICAgY3Vyc29yLFxuICAgICAgICAgICdNQVRDSCcsXG4gICAgICAgICAgcGF0dGVybixcbiAgICAgICAgICAnQ09VTlQnLFxuICAgICAgICAgIDEwMFxuICAgICAgICApO1xuXG4gICAgICAgIGN1cnNvciA9IG5leHRDdXJzb3I7XG4gICAgICAgIGtleXMucHVzaCguLi5mb3VuZEtleXMpO1xuICAgICAgfSB3aGlsZSAoY3Vyc29yICE9PSAnMCcpO1xuXG4gICAgICByZXR1cm4ga2V5cztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKGAke3RoaXMubmFtZX0gS0VZUyBlcnJvcmAsIHsgcGF0dGVybiwgZXJyb3IgfSk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaXNSZWFkeSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeTtcbiAgfVxuXG4gIGFzeW5jIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnJlZGlzLnF1aXQoKTtcbiAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgICAgIGxvZy5pbmZvKGAke3RoaXMubmFtZX0gZmVjaGFkb2ApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2cuZXJyb3IoYCR7dGhpcy5uYW1lfSBDTE9TRSBlcnJvcmAsIHsgZXJyb3IgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE3DqXRvZG9zIGV4dHJhcyBlc3BlY8OtZmljb3MgZG8gUmVkaXNcbiAgICovXG4gIGFzeW5jIHBpbmcoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5yZWRpcy5waW5nKCk7XG4gIH1cblxuICBhc3luYyBpbmZvKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMucmVkaXMuaW5mbygpO1xuICB9XG5cbiAgZ2V0Q2xpZW50KCk6IFJlZGlzIHtcbiAgICByZXR1cm4gdGhpcy5yZWRpcztcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==